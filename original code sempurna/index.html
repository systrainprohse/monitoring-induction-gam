<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Terpadu GAMITAS</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#9333ea" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="GAMITAS" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>G</text></svg>">
    <link rel="manifest"
        href="data:application/json;base64,ewogICJuYW1lIjogIkdBTUlUQVMgLSBTYWZldHkgRGFzaGJvYXJkIiwKICAic2hvcnRfbmFtZSI6ICJHQU1JVEFTIiwKICAiZGVzY3JpcHRpb24iOiAiSW50ZWdyYXRlZCBTYWZldHkgU3lzdGVtIERhc2hib2FyZCIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y4ZmFmYyIsCiAgInRoZW1lX2NvbG9yIjogIiM5MzMzZWEiLAogICJpY29ucyI6IFsKICAgIHsic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvOTMzM2VhL2ZmZmZmZj90ZXh0PUciLCAic2l6ZXMiOiAiMTkyeDE5MiIsICJ0eXBlIjogImltYWdlL3BuZyJ9LAogICAgeyJzcmMiOiAiaHR0cHM6Ly9wbGFjZWhvbGQuY28vNTEyeDUxMi85MzMzZWEvZmZmZmZmP3RleHQ9RyIsICJzaXplcyI6ICI1MTJ4NTEyIiwgInR5cGUiOiAiaW1hZ2UvcG5nIn0KICBdCn0=" />

    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Flatpickr for Date Range Picker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-light: #f8fafc;
            --bg-dark: #1e293b;
            --text-light: #1f2937;
            --text-dark: #f1f5f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Theme Styles */
        .theme-dark {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .theme-dark .bg-white {
            background-color: #334155 !important;
        }

        .theme-dark .bg-gray-50,
        .theme-dark .bg-gray-100 {
            background-color: #475569 !important;
        }

        .theme-dark .text-gray-800,
        .theme-dark .text-gray-900 {
            color: #f1f5f9 !important;
        }

        .theme-dark .text-gray-700 {
            color: #e2e8f0 !important;
        }

        .theme-dark .text-gray-600 {
            color: #cbd5e1 !important;
        }

        .theme-dark .text-gray-500 {
            color: #94a3b8 !important;
        }

        .theme-dark .border-gray-200,
        .theme-dark .border-b,
        .theme-dark .border-t {
            border-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-100:hover {
            background-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-50:hover {
            background-color: #4b5a70 !important;
        }

        .theme-dark .shadow-md,
        .theme-dark .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }

        .theme-dark input,
        .theme-dark select {
            background-color: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        .theme-dark input::placeholder {
            color: #94a3b8;
        }

        .theme-dark .sidebar-link.active {
            background-color: #5b21b6;
            color: white;
        }

        .theme-dark .tab-link.active {
            color: #a78bfa !important;
            border-color: #a78bfa !important;
        }

        .theme-dark .pagination button.active {
            background-color: #a78bfa;
            color: #1e293b;
            border-color: #a78bfa;
        }

        .theme-dark .flatpickr-calendar {
            background: #334155;
            color: var(--text-dark);
            border-color: #475569;
        }

        .theme-dark .flatpickr-day:hover {
            background: #475569;
        }

        .theme-dark .flatpickr-day.selected {
            background: #7c3aed;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .theme-dark ::-webkit-scrollbar-track {
            background: #475569;
        }

        .theme-dark ::-webkit-scrollbar-thumb {
            background: #64748b;
        }

        /* General Styles */
        .sidebar-link.active {
            background-color: #f3e8ff;
            color: #9333ea;
            font-weight: 600;
        }

        .sidebar-submenu-link.active {
            color: #9333ea;
            font-weight: 600;
        }

        .page-content,
        .tab-content {
            display: none;
        }

        .page-content.active,
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Component Styles */
        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        .theme-dark .card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.2);
        }

        .table-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .pagination {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #e2e8f0;
            background-color: white;
            cursor: pointer;
        }

        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .pagination button.active {
            background-color: #9333ea;
            color: white;
            border-color: #9333ea;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th.sortable:hover {
            background-color: #f9fafb;
        }

        th.sortable::after {
            content: '↕';
            position: absolute;
            right: 0.5rem;
            opacity: 0.5;
        }

        th.sortable.sort-asc::after {
            content: '↑';
            opacity: 1;
        }

        th.sortable.sort-desc::after {
            content: '↓';
            opacity: 1;
        }

        .component-loading {
            position: relative;
            min-height: 100px;
        }

        .component-loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            animation: shimmer 1.5s infinite;
        }

        .theme-dark .component-loading::after {
            background: linear-gradient(90deg, transparent, rgba(100, 116, 139, 0.5), transparent);
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* PWA & Banners */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 0.5rem;
            text-align: center;
            z-index: 2000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .offline-banner.show {
            transform: translateY(0);
        }

        .install-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #9333ea, #7c3aed);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 25px -5px rgb(147 51 234 / 0.4);
            cursor: pointer;
            display: none;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .install-button:hover {
            transform: translateY(-2px);
        }

        .error-banner {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .theme-dark .error-banner {
            background-color: #4a2323;
            border-color: #993131;
            color: #fecaca;
        }

        .retry-btn {
            background-color: #dc2626;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            border: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .mobile-hidden {
                display: none !important;
            }

            .mobile-stack {
                flex-direction: column;
            }

            .mobile-full {
                width: 100%;
            }

            main {
                margin-left: 0 !important;
            }

            #sidebar {
                transform: translateX(-100%);
            }

            #sidebar.show {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body class="theme-light">

    <!-- Splash Screen -->
    <div id="splash-screen"
        class="fixed inset-0 bg-gradient-to-br from-purple-600 via-blue-600 to-green-500 flex items-center justify-center z-[9999]">
        <div class="text-center text-white">
            <div class="mb-8">
                <div class="w-24 h-24 mx-auto mb-6 relative">
                    <div class="absolute inset-0 bg-white rounded-full opacity-20 animate-ping"></div>
                    <div class="relative w-24 h-24 bg-white rounded-full flex items-center justify-center">
                        <span id="splash-logo" class="text-4xl font-bold text-purple-600">G</span>
                    </div>
                </div>
                <h1 id="splash-company-name" class="text-4xl font-bold mb-2">GAMITAS</h1>
                <p class="text-xl opacity-90">Advanced Safety Dashboard</p>
            </div>
            <div class="flex items-center justify-center space-x-2 mb-6">
                <div class="w-3 h-3 bg-white rounded-full animate-bounce"></div>
                <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
            <div class="w-64 h-2 bg-white bg-opacity-20 rounded-full overflow-hidden mx-auto mb-4">
                <div id="splash-progress" class="h-full bg-white rounded-full transition-all duration-300 ease-out"
                    style="width: 0%"></div>
            </div>
            <p id="splash-text" class="text-sm opacity-80">Initializing safety systems...</p>
        </div>
    </div>

    <!-- Banners -->
    <div id="offline-banner" class="offline-banner">
        <i data-lucide="wifi-off" class="w-4 h-4 inline mr-2"></i>
        Mode Offline - Data mungkin tidak terbaru
    </div>
    <button id="install-button" class="install-button">
        <i data-lucide="download" class="w-5 h-5"></i>
        Install App
    </button>

    <!-- ========== SIDEBAR ========== -->
    <aside id="sidebar"
        class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-50 transition-transform flex flex-col">
        <div class="p-6 border-b">
            <h1 id="company-name-sidebar" class="text-2xl font-bold text-gray-800">
                <span class="text-purple-600">G</span>AMITAS
            </h1>
            <p class="text-xs text-gray-500">Integrated Safety System</p>
        </div>
        <nav class="mt-4 flex-1 overflow-y-auto">
            <ul class="space-y-1 px-4">
                <li>
                    <a href="#" class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg"
                        data-page="dashboard">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        <span data-translate-key="sidebar_dashboard">Dashboard</span>
                    </a>
                </li>
                <li>
                    <button
                        class="sidebar-dropdown-toggle w-full flex items-center justify-between px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100">
                        <span class="flex items-center space-x-3">
                            <i data-lucide="user-check" class="w-5 h-5"></i>
                            <span data-translate-key="sidebar_induksi">Induksi</span>
                        </span>
                        <i data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                    </button>
                    <ul class="sidebar-submenu hidden mt-1 space-y-1 pl-8">
                        <li><a href="#"
                                class="sidebar-link sidebar-submenu-link block px-4 py-2 rounded-lg text-sm text-gray-500 hover:bg-gray-100"
                                data-page="induksi" data-translate-key="sidebar_induksi_karyawan">Induksi Karyawan</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <button
                        class="sidebar-dropdown-toggle w-full flex items-center justify-between px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100">
                        <span class="flex items-center space-x-3">
                            <i data-lucide="award" class="w-5 h-5"></i>
                            <span data-translate-key="sidebar_pelatihan">Pelatihan Internal</span>
                        </span>
                        <i data-lucide="chevron-down" class="w-4 h-4 transition-transform"></i>
                    </button>
                    <ul class="sidebar-submenu hidden mt-1 space-y-1 pl-8">
                        <li><a href="#"
                                class="sidebar-link sidebar-submenu-link block px-4 py-2 rounded-lg text-sm text-gray-500 hover:bg-gray-100"
                                data-page="pelatihan" data-translate-key="sidebar_pelatihan_menu">Menu Pelatihan</a>
                        </li>
                    </ul>
                </li>
                <li>
                    <a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="laporan">
                        <i data-lucide="file-warning" class="w-5 h-5"></i>
                        <span data-translate-key="sidebar_laporan_insiden">Laporan Insiden</span>
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="observasi">
                        <i data-lucide="search-check" class="w-5 h-5"></i>
                        <span data-translate-key="sidebar_laporan_observasi">Laporan Observasi</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="p-4 border-t">
            <div class="flex items-center space-x-3 mb-4">
                <img src="https://placehold.co/40x40/9333ea/ffffff?text=A" alt="User Avatar"
                    class="w-10 h-10 rounded-full">
                <div>
                    <p class="text-sm font-medium text-gray-800" id="user-name">Admin User</p>
                    <p class="text-xs text-gray-500" id="user-role">Administrator</p>
                </div>
            </div>
            <a href="#" class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span data-translate-key="sidebar_logout">Logout</span>
            </a>
        </div>
    </aside>

    <!-- Mobile Menu Toggle -->
    <button id="mobile-menu-toggle" class="fixed top-4 left-4 z-[60] p-2 rounded-lg bg-white shadow-md md:hidden">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <!-- ========== MAIN CONTENT ========== -->
    <main class="md:ml-64 p-4 sm:p-6 lg:p-8 overflow-y-auto min-h-screen transition-all">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
            <div id="header-title">
                <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                <p class="text-gray-500">Memuat...</p>
            </div>
            <div class="flex items-center space-x-2 sm:space-x-4 w-full sm:w-auto">
                <div class="relative flex-1 sm:flex-none">
                    <input type="text" id="global-search" placeholder="Cari..."
                        data-translate-key="header_search_placeholder"
                        class="pl-10 pr-4 py-2 rounded-full border bg-white focus:outline-none focus:ring-2 focus:ring-purple-500 w-full sm:w-auto">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                </div>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="sun"
                        class="w-5 h-5 text-gray-600"></i></button>
                <div class="relative" id="language-switcher">
                    <button id="language-toggle-btn" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="globe"
                            class="w-5 h-5 text-gray-600"></i></button>
                    <div id="language-menu"
                        class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl hidden z-20">
                        <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="id"><img src="https://flagcdn.com/id.svg" class="w-5 h-auto mr-3"
                                alt="Indonesia Flag"><span>Bahasa Indonesia</span></a>
                        <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="en"><img src="https://flagcdn.com/gb.svg" class="w-5 h-auto mr-3"
                                alt="English Flag"><span>English</span></a>
                        <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="ko"><img src="https://flagcdn.com/kr.svg" class="w-5 h-auto mr-3"
                                alt="Korean Flag"><span>한국어</span></a>
                    </div>
                </div>
                <div class="relative">
                    <button id="notification-btn" class="p-2 rounded-full hover:bg-gray-100 relative">
                        <i data-lucide="bell" class="w-5 h-5 text-gray-600"></i>
                        <span id="notification-badge"
                            class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center hidden"></span>
                    </button>
                    <div id="notification-dropdown"
                        class="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-xl hidden z-20 max-h-96 overflow-y-auto">
                        <div class="p-4 border-b">
                            <h3 class="font-semibold text-gray-800">Notifikasi</h3>
                        </div>
                        <div id="notification-list" class="divide-y"></div>
                    </div>
                </div>
                <div class="relative">
                    <button id="export-btn" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="download"
                            class="w-5 h-5 text-gray-600"></i></button>
                    <div id="export-menu" class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl hidden z-20">
                        <button class="export-option w-full text-left px-4 py-2 hover:bg-gray-50" data-type="pdf"><i
                                data-lucide="file-text" class="w-4 h-4 inline mr-2"></i>PDF Report</button>
                        <button class="export-option w-full text-left px-4 py-2 hover:bg-gray-50" data-type="excel"><i
                                data-lucide="file-spreadsheet" class="w-4 h-4 inline mr-2"></i>Excel Data</button>
                        <button class="export-option w-full text-left px-4 py-2 hover:bg-gray-50" data-type="image"><i
                                data-lucide="image" class="w-4 h-4 inline mr-2"></i>Dashboard Image</button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Error Banner (Hidden by default) -->
        <div id="error-banner" class="error-banner hidden">
            <div class="flex justify-between items-center">
                <span id="error-message"></span>
                <button id="retry-btn" class="retry-btn">Coba Lagi</button>
            </div>
        </div>

        <!-- Date Range Filter -->
        <div class="mb-6 bg-white p-4 rounded-xl shadow-md flex flex-col sm:flex-row items-center gap-4">
            <div class="relative flex-1 w-full sm:w-auto">
                <i data-lucide="calendar" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400"></i>
                <input id="date-range-picker"
                    class="pl-10 pr-4 py-2 w-full rounded-lg border bg-gray-50 focus:outline-none focus:ring-2 focus:ring-purple-500"
                    placeholder="Pilih rentang tanggal...">
            </div>
            <button id="clear-date-filter"
                class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 w-full sm:w-auto">
                Reset
            </button>
        </div>


        <!-- ========== PAGE CONTAINER ========== -->
        <div id="page-container"></div>
    </main>

    <!-- Modals -->
    <div id="password-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[101] p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h4 class="font-bold text-lg">Akses Terbatas</h4>
                <button class="modal-close-btn text-gray-500 hover:text-gray-800 p-2 rounded-full"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Silakan masukkan password untuk mengakses halaman ini.</p>
            <form id="password-form">
                <div>
                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password-input"
                        class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                    <p id="password-error" class="text-red-500 text-sm mt-1 hidden">Password salah!</p>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit"
                        class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">Buka</button>
                    <button type="button"
                        class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 modal-close-btn">Batal</button>
                </div>
            </form>
        </div>
    </div>
    <div id="detail-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[100] p-4">
        <div
            class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h4 id="detail-modal-title" class="font-bold text-lg">Detail Data</h4>
                <button class="modal-close-btn text-gray-500 hover:text-gray-800 p-2 rounded-full"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <div id="detail-modal-body" class="space-y-1 text-sm"></div>
        </div>
    </div>
    <div id="add-data-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[100] p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h4 class="font-bold text-lg">Tambah Data Baru</h4>
                <button class="modal-close-btn text-gray-500 hover:text-gray-800 p-2 rounded-full"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <form id="add-data-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                    <input type="text" name="nama"
                        class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">NIK</label>
                    <input type="text" name="nik"
                        class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Jabatan</label>
                    <input type="text" name="jabatan"
                        class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Perusahaan</label>
                    <input type="text" name="perusahaan"
                        class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit"
                        class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">Simpan</button>
                    <button type="button"
                        class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 modal-close-btn">Batal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- TEMPLATE KONTEN HALAMAN -->
    <template id="page-templates">
        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md card">
                    <h3 class="text-lg font-semibold text-gray-800" data-translate-key="employee_summary_title">
                        Ringkasan Karyawan Hari Ini</h3>
                    <p class="text-sm text-gray-500 mb-4" data-translate-key="employee_summary_subtitle">Snapshot
                        Kesejahteraan Karyawan Real-time</p>
                    <div id="employee-summary-content" class="flex flex-col md:flex-row items-center gap-6">
                        <div class="w-full md:w-1/2">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <p id="emp-cleared" class="text-3xl font-bold text-green-600">-</p>
                                    <p class="text-sm text-gray-500" data-translate-key="employee_summary_cleared">Siap
                                        bekerja</p>
                                </div>
                                <div>
                                    <p id="emp-stay-home" class="text-3xl font-bold text-red-600">-</p>
                                    <p class="text-sm text-gray-500" data-translate-key="employee_summary_stay_home">
                                        Izin di rumah</p>
                                </div>
                                <div>
                                    <p id="emp-serious" class="text-3xl font-bold text-orange-500">-</p>
                                    <p class="text-sm text-gray-500" data-translate-key="employee_summary_serious">Kasus
                                        serius</p>
                                </div>
                                <div>
                                    <p id="emp-not-reported" class="text-3xl font-bold text-gray-400">-</p>
                                    <p class="text-sm text-gray-500" data-translate-key="employee_summary_not_reported">
                                        Tidak melapor</p>
                                </div>
                            </div>
                        </div>
                        <div class="w-full md:w-1/2 h-48"><canvas id="employeeSummaryChart"></canvas></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md card">
                    <h3 class="text-lg font-semibold text-gray-800" data-translate-key="visitor_summary_title">Ringkasan
                        Pengunjung Hari Ini</h3>
                    <p class="text-sm text-gray-500 mb-4" data-translate-key="visitor_summary_subtitle">Pengunjung Saat
                        Ini atau yang Diharapkan</p>
                    <div id="visitor-summary-content" class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <div class="bg-green-100 p-3 rounded-lg"><i data-lucide="check-circle"
                                    class="w-6 h-6 text-green-600"></i></div>
                            <div>
                                <p id="visitor-on-site" class="text-2xl font-bold text-gray-800">-</p>
                                <p class="text-sm text-gray-500" data-translate-key="visitor_summary_on_site">Saat ini
                                    di Lokasi</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="bg-orange-100 p-3 rounded-lg"><i data-lucide="hourglass"
                                    class="w-6 h-6 text-orange-600"></i></div>
                            <div>
                                <p id="visitor-expected" class="text-2xl font-bold text-gray-800">-</p>
                                <p class="text-sm text-gray-500" data-translate-key="visitor_summary_expected">
                                    Diharapkan Datang Hari Ini</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md mb-6 card">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800" data-translate-key="weekly_activity_title">
                            Aktivitas Minggu Ini</h3>
                        <div class="flex items-center space-x-6 mt-2">
                            <div>
                                <p id="weekly-staff" class="text-3xl font-bold text-blue-600">-</p>
                                <p class="text-sm text-gray-500" data-translate-key="weekly_activity_staff">Staf</p>
                            </div>
                            <div>
                                <p id="weekly-visitors" class="text-3xl font-bold text-teal-500">-</p>
                                <p class="text-sm text-gray-500" data-translate-key="weekly_activity_visitors">
                                    Pengunjung</p>
                            </div>
                        </div>
                    </div>
                    <button class="text-sm text-purple-600 font-semibold flex items-center"><i data-lucide="eye"
                            class="w-4 h-4 mr-2"></i><span data-translate-key="weekly_activity_show_all">Lihat
                            semua</span></button>
                </div>
                <div id="weekly-chart-content" class="h-72"><canvas id="thisWeekActivityChart"></canvas></div>
            </div>
        </div>

        <!-- Induksi Page -->
        <div id="induksi-page" class="page-content">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" id="induksi-tabs">
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-purple-500 px-1 pb-4 text-sm font-medium text-purple-600"
                            data-tab="dashboard-induksi" data-translate-key="induksi_tab_dashboard">Dashboard
                            Induksi</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="new-hire" data-translate-key="induksi_tab_new_hire">Induksi New Hire</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="pasca-cuti" data-translate-key="induksi_tab_pasca_cuti">Induksi Pasca Cuti</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="temporary" data-translate-key="induksi_tab_temporary">Temporary</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="visitor" data-translate-key="induksi_tab_visitor">Visitor</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="absensi" data-translate-key="induksi_tab_absensi">Absensi</a>
                    </nav>
                </div>
                <div class="mt-6">
                    <div id="dashboard-induksi-content" class="tab-content active">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div class="bg-gray-50 p-4 rounded-lg shadow card">
                                <div class="flex items-center"><i data-lucide="building-2"
                                        class="w-8 h-8 text-purple-500 mr-4"></i>
                                    <div>
                                        <p id="induksi-core-today" class="text-2xl font-bold">0</p>
                                        <p class="text-sm text-gray-500">Induksi Hari Ini (Core)</p>
                                    </div>
                                </div>
                                <div id="induksi-core-detail" class="text-xs text-gray-500 mt-2 space-y-1"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg shadow card">
                                <div class="flex items-center"><i data-lucide="users"
                                        class="w-8 h-8 text-green-500 mr-4"></i>
                                    <div>
                                        <p id="induksi-mitra-today" class="text-2xl font-bold">0</p>
                                        <p class="text-sm text-gray-500">Induksi Hari Ini (Mitra)</p>
                                    </div>
                                </div>
                                <div id="induksi-mitra-detail" class="text-xs text-gray-500 mt-2 space-y-1"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg shadow card">
                                <div class="flex items-center"><i data-lucide="user"
                                        class="w-8 h-8 text-blue-500 mr-4"></i>
                                    <div>
                                        <p id="induksi-visitor-today" class="text-2xl font-bold">0</p>
                                        <p class="text-sm text-gray-500">Induksi Hari Ini (Visitor)</p>
                                    </div>
                                </div>
                                <div id="induksi-visitor-detail" class="text-xs text-gray-500 mt-2 space-y-1"></div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg shadow card">
                                <div class="flex items-center mb-2"><i data-lucide="calendar-check"
                                        class="w-8 h-8 text-orange-500 mr-4"></i>
                                    <p class="text-sm text-gray-500">Status Hari Ini</p>
                                </div>
                                <div class="flex justify-around">
                                    <div class="text-center">
                                        <p id="status-new-hire" class="text-xl font-bold">0</p>
                                        <p class="text-xs">New Hire</p>
                                    </div>
                                    <div class="text-center">
                                        <p id="status-cuti" class="text-xl font-bold">0</p>
                                        <p class="text-xs">Cuti</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                            <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-gray-50 p-4 rounded-lg shadow card">
                                    <h3 class="font-semibold mb-2">Statistik Skor Hari Ini</h3>
                                    <div class="flex justify-between text-center">
                                        <div id="skor-terendah">...</div>
                                        <div id="skor-tertinggi">...</div>
                                        <div id="skor-rata">...</div>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg shadow card flex items-center"><i
                                        data-lucide="key-round" class="w-10 h-10 text-orange-500 mr-4"></i>
                                    <div>
                                        <h3 class="font-semibold">Password Hari Ini</h3>
                                        <p id="kode-akses-value" class="text-2xl font-bold">...</p>
                                    </div>
                                </div>
                            </div>
                            <div
                                class="bg-gradient-to-br from-green-500 to-emerald-600 text-white p-4 rounded-lg shadow card flex flex-col items-center justify-center text-center">
                                <p class="font-bold text-lg" id="day-name">-</p>
                                <p class="text-5xl font-bold" id="date-number">-</p>
                                <p class="text-sm" id="month-year">-</p>
                                <p id="clock" class="mt-2 text-lg bg-black bg-opacity-20 px-3 py-1 rounded-full">
                                    00:00:00</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 gap-6 mt-6">
                            <div class="bg-gray-50 p-4 rounded-lg shadow card">
                                <h3 class="font-semibold mb-2">Total Pendaftaran: <span id="total-pendaftaran"
                                        class="font-bold">0</span></h3>
                                <div id="pendaftaran-breakdown" class="overflow-x-auto">
                                    <div class="flex gap-x-4 gap-y-1 text-xs whitespace-nowrap"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg shadow card">
                                <h3 class="font-semibold mb-2">Total Approval Permit: <span id="total-approval"
                                        class="font-bold">0</span></h3>
                                <div id="approval-breakdown" class="overflow-x-auto">
                                    <div class="flex gap-x-4 gap-y-1 text-xs whitespace-nowrap"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg shadow card">
                                <h3 class="font-semibold mb-2">Permit Temporary Aktif: <span id="total-temporary"
                                        class="font-bold">0</span></h3>
                                <div id="temporary-breakdown" class="overflow-x-auto">
                                    <div class="flex gap-x-4 gap-y-1 text-xs whitespace-nowrap"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="new-hire-content" class="tab-content">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <h3 class="text-lg font-semibold">Data Induksi Karyawan Baru</h3><button
                                id="add-new-hire-btn"
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center space-x-2"><i
                                    data-lucide="plus"></i><span>Tambah Data</span></button>
                        </div>
                        <div class="table-controls mobile-stack"><input type="text" id="new-hire-search"
                                placeholder="Cari dalam tabel..."
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 mobile-full"><select
                                id="new-hire-filter"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Semua Status</option>
                                <option value="ok">OK</option>
                                <option value="hold">Hold</option>
                                <option value="need">Need</option>
                            </select><select id="new-hire-per-page"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="10">10 per halaman</option>
                                <option value="25">25 per halaman</option>
                                <option value="50" selected>50 per halaman</option>
                            </select></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase border-b">
                                        <th class="py-3 px-4 sortable" data-column="tanggal">Tanggal</th>
                                        <th class="py-3 px-4 sortable" data-column="NIK">NIK</th>
                                        <th class="py-3 px-4 sortable" data-column="NAMA">Nama</th>
                                        <th class="py-3 px-4 sortable" data-column="JABATAN">Jabatan</th>
                                        <th class="py-3 px-4 sortable" data-column="perusahaan">Perusahaan</th>
                                        <th class="py-3 px-4 sortable" data-column="STATUS">Status</th>
                                        <th class="py-3 px-4 sortable" data-column="SCORE">Skor</th>
                                        <th class="py-3 px-4">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="new-hire-table-body" class="text-sm text-gray-700"></tbody>
                            </table>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-between items-center mt-4">
                            <div id="new-hire-summary" class="text-sm text-gray-500 mb-2 sm:mb-0"></div>
                            <div id="new-hire-pagination" class="pagination"></div>
                        </div>
                    </div>
                    <div id="pasca-cuti-content" class="tab-content">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Data Induksi Pasca Cuti</h3>
                        </div>
                        <div class="table-controls mobile-stack"><input type="text" id="pasca-cuti-search"
                                placeholder="Cari dalam tabel..."
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 mobile-full"><select
                                id="pasca-cuti-filter"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Semua Status</option>
                                <option value="ok">OK</option>
                                <option value="hold">Hold</option>
                                <option value="need">Need</option>
                            </select><select id="pasca-cuti-per-page"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="10">10 per halaman</option>
                                <option value="25">25 per halaman</option>
                                <option value="50" selected>50 per halaman</option>
                            </select></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase border-b">
                                        <th class="py-3 px-4 sortable" data-column="DATE">Tanggal</th>
                                        <th class="py-3 px-4 sortable" data-column="NIK">NIK</th>
                                        <th class="py-3 px-4 sortable" data-column="NAMA">Nama</th>
                                        <th class="py-3 px-4 sortable" data-column="JABATAN">Jabatan</th>
                                        <th class="py-3 px-4 sortable" data-column="PERUSAHAAN">Perusahaan</th>
                                        <th class="py-3 px-4 sortable" data-column="STATUS INDUKSI">Status</th>
                                        <th class="py-3 px-4 sortable" data-column="SCORE">Skor</th>
                                        <th class="py-3 px-4">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="pasca-cuti-table-body" class="text-sm text-gray-700"></tbody>
                            </table>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-between items-center mt-4">
                            <div id="pasca-cuti-summary" class="text-sm text-gray-500 mb-2 sm:mb-0"></div>
                            <div id="pasca-cuti-pagination" class="pagination"></div>
                        </div>
                    </div>
                    <div id="temporary-content" class="tab-content">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Data Induksi Temporary</h3>
                        </div>
                        <div class="table-controls mobile-stack"><input type="text" id="temporary-search"
                                placeholder="Cari dalam tabel..."
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 mobile-full"><select
                                id="temporary-filter"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Semua Status</option>
                                <option value="ok">OK</option>
                                <option value="hold">Hold</option>
                                <option value="need">Need</option>
                            </select><select id="temporary-per-page"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="10">10 per halaman</option>
                                <option value="25">25 per halaman</option>
                                <option value="50" selected>50 per halaman</option>
                            </select></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase border-b">
                                        <th class="py-3 px-4 sortable" data-column="DATE">Tanggal</th>
                                        <th class="py-3 px-4 sortable" data-column="NIK">NIK</th>
                                        <th class="py-3 px-4 sortable" data-column="NAMA">Nama</th>
                                        <th class="py-3 px-4 sortable" data-column="JABATAN">Jabatan</th>
                                        <th class="py-3 px-4 sortable" data-column="PERUSAHAAN">Perusahaan</th>
                                        <th class="py-3 px-4 sortable" data-column="STATUS">Status</th>
                                        <th class="py-3 px-4 sortable" data-column="SCORE">Skor</th>
                                        <th class="py-3 px-4">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="temporary-table-body" class="text-sm text-gray-700"></tbody>
                            </table>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-between items-center mt-4">
                            <div id="temporary-summary" class="text-sm text-gray-500 mb-2 sm:mb-0"></div>
                            <div id="temporary-pagination" class="pagination"></div>
                        </div>
                    </div>
                    <div id="visitor-content" class="tab-content">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Data Induksi Visitor</h3>
                        </div>
                        <div class="table-controls mobile-stack"><input type="text" id="visitor-search"
                                placeholder="Cari dalam tabel..."
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 mobile-full"><select
                                id="visitor-filter"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Semua Status</option>
                                <option value="ok">OK</option>
                                <option value="hold">Hold</option>
                                <option value="need">Need</option>
                            </select><select id="visitor-per-page"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="10">10 per halaman</option>
                                <option value="25">25 per halaman</option>
                                <option value="50" selected>50 per halaman</option>
                            </select></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase border-b">
                                        <th class="py-3 px-4 sortable" data-column="DATE">Tanggal</th>
                                        <th class="py-3 px-4 sortable" data-column="NIK">NIK</th>
                                        <th class="py-3 px-4 sortable" data-column="NAMA">Nama</th>
                                        <th class="py-3 px-4 sortable" data-column="JABATAN">Jabatan</th>
                                        <th class="py-3 px-4 sortable" data-column="PERUSAHAAN">Perusahaan</th>
                                        <th class="py-3 px-4 sortable" data-column="STATUS">Status</th>
                                        <th class="py-3 px-4 sortable" data-column="SCORE">Skor</th>
                                        <th class="py-3 px-4">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="visitor-table-body" class="text-sm text-gray-700"></tbody>
                            </table>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-between items-center mt-4">
                            <div id="visitor-summary" class="text-sm text-gray-500 mb-2 sm:mb-0"></div>
                            <div id="visitor-pagination" class="pagination"></div>
                        </div>
                    </div>
                    <div id="absensi-content" class="tab-content">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Data Pendaftaran Induksi</h3>
                        </div>
                        <div class="table-controls mobile-stack"><input type="text" id="absensi-search"
                                placeholder="Cari dalam tabel..."
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 mobile-full"><select
                                id="absensi-per-page"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="10">10 per halaman</option>
                                <option value="25">25 per halaman</option>
                                <option value="50" selected>50 per halaman</option>
                            </select></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase border-b">
                                        <th class="py-3 px-4 sortable" data-column="Timestamp">Waktu</th>
                                        <th class="py-3 px-4 sortable" data-column="NAMA">Nama</th>
                                        <th class="py-3 px-4 sortable" data-column="NIK KTP">NIK</th>
                                        <th class="py-3 px-4 sortable" data-column="PERUSAHAAN">Perusahaan</th>
                                        <th class="py-3 px-4 sortable" data-column="JENIS INDUKSI">Jenis Induksi</th>
                                        <th class="py-3 px-4">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="absensi-table-body" class="text-sm text-gray-700"></tbody>
                            </table>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-between items-center mt-4">
                            <div id="absensi-summary" class="text-sm text-gray-500 mb-2 sm:mb-0"></div>
                            <div id="absensi-pagination" class="pagination"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pelatihan Page -->
        <div id="pelatihan-page" class="page-content">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" id="pelatihan-tabs">
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-purple-500 px-1 pb-4 text-sm font-medium text-purple-600"
                            data-tab="dashboard-pelatihan" data-translate-key="pelatihan_tab_dashboard">Dashboard
                            Pelatihan</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="pelatihan-manpower" data-translate-key="pelatihan_tab_manpower">Pelatihan
                            Manpower</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="matrix-kompetensi" data-translate-key="pelatihan_tab_matrix">Matrix Kompetensi</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="jadwal-pelatihan" data-translate-key="pelatihan_tab_jadwal">Jadwal Pelatihan</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="atmp" data-translate-key="pelatihan_tab_atmp">ATMP</a>
                    </nav>
                </div>
                <div class="mt-6">
                    <div id="dashboard-pelatihan-content" class="tab-content active">
                        <div class="space-y-6">
                            <div id="pelatihan-stats-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                                <div class="bg-gray-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-gray-500"
                                        data-translate-key="pelatihan_dashboard_card1_title">Total Kompetensi Tercatat
                                    </p>
                                    <p class="text-3xl font-bold text-gray-800">-</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-gray-500"
                                        data-translate-key="pelatihan_dashboard_card2_title">Total Manpower Terlatih</p>
                                    <p class="text-3xl font-bold text-gray-800">-</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-gray-500"
                                        data-translate-key="pelatihan_dashboard_card3_title">Total Kebutuhan Pelatihan
                                    </p>
                                    <p class="text-3xl font-bold text-gray-800">-</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="pelatihan_dashboard_kompetensi_title">Grafik Sebaran
                                        Kompetensi POP, POM, POU</h3>
                                    <div class="h-64"><canvas id="kompetensiChart"></canvas></div>
                                </div>
                                <div class="bg-gray-50 p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="pelatihan_dashboard_progress_title">Progress Pelatihan
                                        Keseluruhan</h3>
                                    <div class="h-64 flex items-center justify-center"><canvas
                                            id="progressPelatihanChart"></canvas></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="pelatihan_dashboard_top5_title">Top 5 Pelatihan yang Paling
                                        Dibutuhkan</h3>
                                    <div class="h-64"><canvas id="topPelatihanChart"></canvas></div>
                                </div>
                                <div class="bg-gray-50 p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="pelatihan_dashboard_jadwal_title">Jadwal Mendatang</h3>
                                    <ul id="jadwal-mendatang-list" class="space-y-4"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="pelatihan-manpower-content" class="tab-content">
                        <h3 class="text-lg font-semibold mb-4">Detail Kompetensi Manpower</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-1">
                                <div class="mb-4"><input type="text" id="manpower-search"
                                        placeholder="Cari nama manpower..."
                                        class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div class="max-h-96 overflow-y-auto bg-gray-50 p-2 rounded-lg border">
                                    <ul id="manpower-list" class="space-y-1"></ul>
                                </div>
                            </div>
                            <div id="manpower-detail" class="md:col-span-2 p-4 border rounded-lg bg-white">
                                <p class="text-gray-500">Pilih nama dari daftar untuk melihat detail kompetensi.</p>
                            </div>
                        </div>
                    </div>
                    <div id="matrix-kompetensi-content" class="tab-content">
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0"><i data-lucide="info" class="h-5 w-5 text-blue-400"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700"><strong>Matrix Kompetensi</strong> - Fitur ini
                                        sedang dalam pengembangan. Matrix ini akan menampilkan pemetaan kompetensi
                                        setiap karyawan berdasarkan jabatan dan area kerja.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="jadwal-pelatihan-content" class="tab-content">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <h3 class="text-lg font-semibold">Jadwal Pelatihan - <span id="calendar-month-year"></span>
                            </h3>
                            <div><button id="prev-month" class="p-2 rounded-md hover:bg-gray-100"><i
                                        data-lucide="chevron-left" class="pointer-events-none"></i></button><button
                                    id="next-month" class="p-2 rounded-md hover:bg-gray-100"><i
                                        data-lucide="chevron-right" class="pointer-events-none"></i></button></div>
                        </div>
                        <div id="calendar-grid"
                            class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                        </div>
                    </div>
                    <div id="atmp-content" class="tab-content">
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0"><i data-lucide="calendar"
                                        class="h-5 w-5 text-yellow-400"></i></div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700"><strong>Annual Training Master Plan
                                            (ATMP)</strong> - Fitur ini sedang dalam pengembangan. ATMP akan menampilkan
                                        rencana pelatihan tahunan yang komprehensif untuk semua karyawan.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Laporan Insiden Page -->
        <div id="laporan-page" class="page-content">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" id="laporan-tabs">
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-purple-500 px-1 pb-4 text-sm font-medium text-purple-600"
                            data-tab="dashboard-laporan" data-translate-key="laporan_tab_dashboard">Dashboard
                            Insiden</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="data-laporan" data-translate-key="laporan_tab_data">Data Laporan</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="hse-performance" data-translate-key="laporan_tab_hse">HSE Performance</a>
                    </nav>
                </div>
                <div class="mt-6">
                    <div id="dashboard-laporan-content" class="tab-content active">
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div class="bg-blue-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-blue-700" data-translate-key="laporan_dashboard_card1_title">
                                        Total Insiden</p>
                                    <p id="total-insiden" class="text-3xl font-bold text-blue-900">-</p>
                                </div>
                                <div class="bg-red-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-red-700" data-translate-key="laporan_dashboard_card2_title">
                                        Kasus Berat (LTI)</p>
                                    <p id="total-lti" class="text-3xl font-bold text-red-900">-</p>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-orange-700"
                                        data-translate-key="laporan_dashboard_card3_title">Kasus Ringan (Non-LTI)</p>
                                    <p id="total-non-lti" class="text-3xl font-bold text-orange-900">-</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-green-700"
                                        data-translate-key="laporan_dashboard_card4_title">Nyaris Celaka</p>
                                    <p id="total-near-miss" class="text-3xl font-bold text-green-900">-</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                                <div class="lg:col-span-3 bg-gray-50 p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="laporan_dashboard_tren_title">Tren Insiden Bulanan</h3>
                                    <div class="h-80"><canvas id="trenInsidenChart"></canvas></div>
                                </div>
                                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="laporan_dashboard_klasifikasi_title">Klasifikasi Insiden
                                    </h3>
                                    <div class="h-80 flex items-center"><canvas id="klasifikasiInsidenChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="data-laporan-content" class="tab-content">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <h3 class="text-lg font-semibold" data-translate-key="laporan_data_title">Semua Laporan
                                Insiden</h3><button
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center space-x-2"><i
                                    data-lucide="plus"></i><span data-translate-key="laporan_data_button_new">Buat
                                    Laporan Baru</span></button>
                        </div>
                        <div class="table-controls mobile-stack"><input type="text" id="laporan-search"
                                placeholder="Cari dalam tabel..."
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 mobile-full"><select
                                id="laporan-filter"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Semua Klasifikasi</option>
                                <option value="LTI">LTI</option>
                                <option value="Non-LTI">Non-LTI</option>
                                <option value="Near Miss">Near Miss</option>
                            </select><select id="laporan-per-page"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="10">10 per halaman</option>
                                <option value="25">25 per halaman</option>
                                <option value="50" selected>50 per halaman</option>
                            </select></div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase border-b">
                                        <th class="py-3 px-4 sortable" data-column="id"
                                            data-translate-key="laporan_data_table_id">ID</th>
                                        <th class="py-3 px-4 sortable" data-column="tanggalKejadian"
                                            data-translate-key="laporan_data_table_tanggal">Tanggal</th>
                                        <th class="py-3 px-4 sortable" data-column="judulInsiden"
                                            data-translate-key="laporan_data_table_judul">Judul Insiden</th>
                                        <th class="py-3 px-4 sortable" data-column="kategoriKecelakaan"
                                            data-translate-key="laporan_data_table_klasifikasi">Klasifikasi</th>
                                        <th class="py-3 px-4 sortable" data-column="statusLpi"
                                            data-translate-key="laporan_data_table_status">Status</th>
                                        <th class="py-3 px-4" data-translate-key="laporan_data_table_aksi">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="laporan-insiden-table-body" class="text-sm text-gray-700"></tbody>
                            </table>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-between items-center mt-4">
                            <div id="laporan-summary" class="text-sm text-gray-500 mb-2 sm:mb-0"></div>
                            <div id="laporan-pagination" class="pagination"></div>
                        </div>
                    </div>
                    <div id="hse-performance-content" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg card component-loading">
                                <p class="text-sm text-gray-500" data-translate-key="laporan_hse_ltifr">LTIFR (YTD)</p>
                                <p id="ltifr-ytd" class="text-3xl font-bold text-red-600">-</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg card component-loading">
                                <p class="text-sm text-gray-500" data-translate-key="laporan_hse_trir">TRIR (YTD)</p>
                                <p id="trir-ytd" class="text-3xl font-bold text-orange-600">-</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg card component-loading">
                                <p class="text-sm text-gray-500" data-translate-key="laporan_hse_manhours">Total Man
                                    Hours</p>
                                <p id="manhours-ytd" class="text-3xl font-bold text-blue-600">-</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg card component-loading">
                            <h3 class="text-md font-semibold text-gray-700 mb-4"
                                data-translate-key="laporan_hse_chart_title">Performa LTIFR & TRIR Bulanan</h3>
                            <div class="h-80"><canvas id="hsePerformanceChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Laporan Observasi Page (NEW) -->
        <div id="observasi-page" class="page-content">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" id="observasi-tabs">
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-purple-500 px-1 pb-4 text-sm font-medium text-purple-600"
                            data-tab="dashboard-observasi" data-translate-key="observasi_tab_dashboard">Dashboard
                            Observasi</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="data-observasi" data-translate-key="observasi_tab_data">Data Observasi</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="analisis-observasi" data-translate-key="observasi_tab_analisis">Analisis
                            Observasi</a>
                    </nav>
                </div>
                <div class="mt-6">
                    <div id="dashboard-observasi-content" class="tab-content active">
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div class="bg-blue-50 p-4 rounded-lg card">
                                    <p class="text-sm text-blue-700"
                                        data-translate-key="observasi_dashboard_card1_title">Total Observasi</p>
                                    <p id="total-observasi" class="text-3xl font-bold text-blue-900">-</p>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg card">
                                    <p class="text-sm text-orange-700"
                                        data-translate-key="observasi_dashboard_card2_title">Observasi Terbuka</p>
                                    <p id="total-observasi-terbuka" class="text-3xl font-bold text-orange-900">-</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg card">
                                    <p class="text-sm text-green-700"
                                        data-translate-key="observasi_dashboard_card3_title">Observasi Tertutup</p>
                                    <p id="total-observasi-tertutup" class="text-3xl font-bold text-green-900">-</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg card">
                                    <p class="text-sm text-gray-700"
                                        data-translate-key="observasi_dashboard_card4_title">Tingkat Penutupan</p>
                                    <p id="tingkat-penutupan-observasi" class="text-3xl font-bold text-gray-900">-</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                                <div class="lg:col-span-3 bg-gray-50 p-6 rounded-lg card">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="observasi_dashboard_tren_title">Tren Observasi Bulanan</h3>
                                    <div class="h-80"><canvas id="trenObservasiChart"></canvas></div>
                                </div>
                                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg card">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="observasi_dashboard_kategori_title">Kategori Observasi</h3>
                                    <div class="h-80 flex items-center"><canvas id="kategoriObservasiChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="data-observasi-content" class="tab-content">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <h3 class="text-lg font-semibold" data-translate-key="observasi_data_title">Semua Laporan
                                Observasi</h3>
                            <button
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center space-x-2"><i
                                    data-lucide="plus"></i><span data-translate-key="observasi_data_button_new">Buat
                                    Laporan Baru</span></button>
                        </div>
                        <div class="table-controls mobile-stack">
                            <input type="text" id="observasi-search" placeholder="Cari dalam tabel..."
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 mobile-full">
                            <select id="observasi-filter"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Semua Status</option>
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                            </select>
                            <select id="observasi-per-page"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="10">10 per halaman</option>
                                <option value="25">25 per halaman</option>
                                <option value="50" selected>50 per halaman</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase border-b">
                                        <th class="py-3 px-4 sortable" data-column="id"
                                            data-translate-key="observasi_data_table_id">ID</th>
                                        <th class="py-3 px-4 sortable" data-column="tanggal"
                                            data-translate-key="observasi_data_table_tanggal">Tanggal</th>
                                        <th class="py-3 px-4 sortable" data-column="lokasi"
                                            data-translate-key="observasi_data_table_lokasi">Lokasi</th>
                                        <th class="py-3 px-4 sortable" data-column="kategori"
                                            data-translate-key="observasi_data_table_kategori">Kategori</th>
                                        <th class="py-3 px-4 sortable" data-column="status"
                                            data-translate-key="observasi_data_table_status">Status</th>
                                        <th class="py-3 px-4" data-translate-key="observasi_data_table_aksi">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="laporan-observasi-table-body" class="text-sm text-gray-700"></tbody>
                            </table>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-between items-center mt-4">
                            <div id="observasi-summary" class="text-sm text-gray-500 mb-2 sm:mb-0"></div>
                            <div id="observasi-pagination" class="pagination"></div>
                        </div>
                    </div>
                    <div id="analisis-observasi-content" class="tab-content">
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0"><i data-lucide="info" class="h-5 w-5 text-blue-400"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700"><strong>Analisis Observasi</strong> - Fitur ini
                                        sedang dalam pengembangan. Halaman ini akan menampilkan analisis mendalam dari
                                        data observasi keselamatan.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // ========== GLOBAL STATE MANAGEMENT ==========
        const appState = {
            data: {},
            loading: { global: true, components: new Set() },
            currentPage: 'dashboard',
            currentTheme: localStorage.getItem('theme') || 'light',
            currentLanguage: localStorage.getItem('language') || 'id',
            cache: { expiry: 30 * 60 * 1000 }, // 30 minutes
            tables: {},
            errors: [],
            notifications: [],
            deferredInstallPrompt: null,
            targetPage: null,
            startDate: null,
            endDate: null,
        };

        // ========== UTILITY & UI FUNCTIONS ==========
        const debounce = (func, wait) => { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; };
        const updateSplashScreen = (progress, text) => { document.getElementById("splash-progress").style.width = `${progress}%`; document.getElementById("splash-text").textContent = text; };
        const showError = (message, canRetry = true) => { document.getElementById('error-message').textContent = message; document.getElementById('retry-btn').style.display = canRetry ? 'block' : 'none'; document.getElementById('error-banner').classList.remove('hidden'); };
        const hideError = () => { document.getElementById('error-banner').classList.add('hidden'); };
        const addNotification = (title, message, type = 'info') => { appState.notifications.unshift({ id: Date.now(), title, message, type, timestamp: new Date() }); updateNotificationUI(); };
        const updateNotificationUI = () => {
            const badge = document.getElementById("notification-badge");
            const list = document.getElementById("notification-list");
            const count = appState.notifications.length;
            if (badge) { count > 0 ? (badge.textContent = count > 9 ? '9+' : count, badge.classList.remove("hidden")) : badge.classList.add("hidden"); }
            if (list) { list.innerHTML = count === 0 ? '<div class="p-4 text-gray-500 text-center">Tidak ada notifikasi</div>' : appState.notifications.map(n => `<div class="p-3 hover:bg-gray-50 border-b last:border-b-0"><p class="font-semibold text-sm text-gray-800">${n.title}</p><p class="text-xs text-gray-600 mt-1">${n.message}</p><p class="text-xs text-gray-400 mt-2 text-right">${n.timestamp.toLocaleTimeString("id-ID", { hour: '2-digit', minute: '2-digit' })}</p></div>`).join(""); }
        };

        // ========== CACHE MANAGEMENT (DISABLED LOCALSTORAGE) ==========
        const getCachedData = (key) => { return null; };
        const setCachedData = (key, data) => { /* Caching disabled */ };

        // ========== DATA FETCHING ==========
        const SPREADSHEET_IDS = {
            induksi: '19SWnTTs34iX-fnrqovnCwwLcS2oAMt4Yu0apIdB5wV8',
            pelatihan: '1rYjpyZMyvOHibsF-z_y-sAH9PZd1m79KNk_UB8_K5lM',
            insiden: '1bFevC9EGzYmyQTLSCMxu53_7sH7Ab24GT4O0A4nZXTA',
            observasi: '1-DUMMY-SHEET-ID-FOR-OBSERVATION-DATA' // Placeholder for future use
        };
        async function fetchSheetData(sheetId, sheetName) {
            const originalUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(originalUrl)}`;

            const maxRetries = 3;
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    const response = await fetch(proxyUrl, { signal: AbortSignal.timeout(60000) });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status} for ${sheetName}`);
                    const csvText = await response.text();
                    const data = parseCsv(csvText);
                    return data;
                } catch (error) {
                    console.warn(`Attempt ${attempt} failed for ${sheetName}: ${error.message}.`);
                    if (attempt === maxRetries) {
                        console.error(`Fetch failed permanently for ${sheetName} after ${maxRetries} attempts.`);
                        addNotification("Data Gagal Dimuat", `Gagal mengambil data untuk: ${sheetName}.`, "error");
                        return []; // Return empty array on final failure
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
                }
            }
            return []; // Should not be reached, but as a fallback
        }
        function parseCsv(text) {
            const lines = text.trim().split('\n');
            if (lines.length < 1) return [];
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            return lines.slice(1).map(line => {
                const values = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
                const obj = {};
                headers.forEach((header, index) => { obj[header] = values[index] ? values[index].replace(/"/g, '').trim() : ''; });
                return obj;
            });
        }

        function generateDummyObservasiData(count) {
            const data = [];
            const locations = ['Area Tambang', 'Workshop', 'Kantor', 'Jalan Hauling', 'Mess'];
            const categories = ['APD', 'Peralatan', 'Prosedur', 'Lingkungan', 'Perilaku'];
            const statuses = ['Open', 'Closed'];
            const today = new Date();
            for (let i = 0; i < count; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() - Math.floor(Math.random() * 90));
                data.push({
                    id: `OBS-${1000 + i}`,
                    tanggal: date.toLocaleDateString('en-CA'),
                    lokasi: locations[Math.floor(Math.random() * locations.length)],
                    kategori: categories[Math.floor(Math.random() * categories.length)],
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    deskripsi: 'Ini adalah deskripsi dummy untuk observasi keselamatan.',
                    pelapor: `User ${100 + i}`
                });
            }
            return data.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
        }

        async function loadAllData() {
            const splashSteps = [
                { key: "pascaCuti", promise: () => fetchSheetData(SPREADSHEET_IDS.induksi, "PASCA_CUTI"), text: "Loading leave return data..." },
                { key: "newHire", promise: () => fetchSheetData(SPREADSHEET_IDS.induksi, "NEW_HIRE"), text: "Loading new hire data..." },
                { key: "temporary", promise: () => fetchSheetData(SPREADSHEET_IDS.induksi, "TEMPORARY"), text: "Loading temporary staff data..." },
                { key: "visitor", promise: () => fetchSheetData(SPREADSHEET_IDS.induksi, "VISITOR"), text: "Loading visitor data..." },
                { key: "kodeAkses", promise: () => fetchSheetData(SPREADSHEET_IDS.induksi, 'KODE_AKSES'), text: "Syncing access codes..." },
                { key: "setting", promise: () => fetchSheetData(SPREADSHEET_IDS.induksi, "setting"), text: "Applying settings..." },
                { key: "pendaftaranInduksi", promise: () => fetchSheetData(SPREADSHEET_IDS.induksi, "pendaftaran_induksi"), text: "Checking registrations..." },
                { key: "monitoringInternal", promise: () => fetchSheetData(SPREADSHEET_IDS.pelatihan, "monitoring_internal"), text: "Loading training data..." },
                { key: "jadwalTraining", promise: () => fetchSheetData(SPREADSHEET_IDS.pelatihan, "jadwal_training"), text: "Fetching training schedules..." },
                { key: "kompetensiManpower", promise: () => fetchSheetData(SPREADSHEET_IDS.pelatihan, "kompetensi_manpower"), text: "Syncing competencies..." },
                { key: "dataDasbor", promise: () => fetchSheetData(SPREADSHEET_IDS.insiden, "Data_Dasbor"), text: "Loading incident reports..." },
                { key: "performance", promise: () => fetchSheetData(SPREADSHEET_IDS.insiden, "PERFORMANCE"), text: "Analyzing performance..." },
                { key: "observasi", promise: () => Promise.resolve(generateDummyObservasiData(123)), text: "Loading observation reports..." },
            ];
            const allData = {};
            for (let i = 0; i < splashSteps.length; i++) {
                const step = splashSteps[i];
                updateSplashScreen(((i + 1) / splashSteps.length) * 100, step.text);
                allData[step.key] = await step.promise();
            }
            updateSplashScreen(100, "Finalizing dashboard...");
            addNotification("Sinkronisasi Selesai", "Semua sinkronisasi data telah selesai. Periksa notifikasi untuk melihat jika ada error.", "success");
            return allData;
        }

        // ========== TABLE MANAGEMENT ==========
        class TableManager {
            constructor(tableId, data, headers, options = {}) {
                this.tableId = tableId;
                this.originalData = [...data];
                this.headers = headers;
                this.currentPage = 1;
                this.itemsPerPage = parseInt(options.itemsPerPage || 50); // Default to 50
                this.sortColumn = null;
                this.sortDirection = 'asc';
                this.searchTerm = '';
                this.filterValue = '';
                this.dateColumn = options.dateColumn;
                this.statusColumn = options.statusColumn;

                // Sort data initially by date, newest first
                if (this.dateColumn) {
                    this.originalData.sort((a, b) => {
                        const dateA = new Date(a[this.dateColumn] || 0);
                        const dateB = new Date(b[this.dateColumn] || 0);
                        return dateB - dateA; // Descending order
                    });
                }
                this.filteredData = [...this.originalData];
                this.init();
            }
            init() { this.setupControls(); this.render(); }
            setupControls() {
                const searchInput = document.getElementById(this.tableId.replace('-table-body', '-search'));
                if (searchInput) searchInput.addEventListener('input', debounce((e) => { this.searchTerm = e.target.value.toLowerCase(); this.applyFilters(); }, 300));
                const filterSelect = document.getElementById(this.tableId.replace('-table-body', '-filter'));
                if (filterSelect) filterSelect.addEventListener('change', (e) => { this.filterValue = e.target.value.toLowerCase(); this.applyFilters(); });
                const perPageSelect = document.getElementById(this.tableId.replace('-table-body', '-per-page'));
                if (perPageSelect) perPageSelect.addEventListener('change', (e) => { this.itemsPerPage = parseInt(e.target.value); this.currentPage = 1; this.render(); });
                const table = document.getElementById(this.tableId).closest('table');
                table.querySelectorAll('th.sortable').forEach(header => { header.addEventListener('click', () => { const column = header.dataset.column; if (this.sortColumn === column) { this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc'; } else { this.sortColumn = column; this.sortDirection = 'asc'; } this.updateSortIcons(header); this.applySort(); }); });
            }
            updateSortIcons(activeHeader) {
                const table = document.getElementById(this.tableId).closest('table');
                table.querySelectorAll('th.sortable').forEach(header => { header.classList.remove('sort-asc', 'sort-desc'); });
                activeHeader.classList.add(this.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            }
            applyFilters() {
                this.filteredData = this.originalData.filter(item => {
                    if (this.dateColumn && appState.startDate && appState.endDate) {
                        const itemDateStr = item[this.dateColumn];
                        if (!itemDateStr) return false;
                        const itemDate = new Date(itemDateStr);
                        const endDate = new Date(appState.endDate);
                        endDate.setHours(23, 59, 59, 999);
                        if (itemDate < appState.startDate || itemDate > endDate) {
                            return false;
                        }
                    }
                    if (this.searchTerm && !Object.values(item).some(value => String(value).toLowerCase().includes(this.searchTerm))) return false;
                    if (this.filterValue) {
                        const statusFields = this.statusColumn ? [this.statusColumn] : ['STATUS', 'STATUS INDUKSI', 'kategoriKecelakaan', 'status'];
                        if (!statusFields.some(field => item[field] && String(item[field]).toLowerCase().includes(this.filterValue))) return false;
                    }
                    return true;
                });
                this.currentPage = 1;
                this.applySort(); // Re-apply sort after filtering
            }
            applySort() {
                if (!this.sortColumn) {
                    this.render(); // Render without sorting if no column is selected
                    return;
                };
                this.filteredData.sort((a, b) => {
                    let aVal = a[this.sortColumn] || '', bVal = b[this.sortColumn] || '';
                    const aNum = parseFloat(aVal), bNum = parseFloat(bVal);
                    if (!isNaN(aNum) && !isNaN(bNum)) { aVal = aNum; bVal = bNum; } else { aVal = String(aVal).toLowerCase(); bVal = String(bVal).toLowerCase(); }
                    if (this.sortDirection === 'asc') return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    else return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                });
                this.render();
            }
            render() { this.renderTable(); this.renderPagination(); }
            renderTable() {
                const tbody = document.getElementById(this.tableId);
                const start = (this.currentPage - 1) * this.itemsPerPage, end = start + this.itemsPerPage;
                const pageData = this.filteredData.slice(start, end);
                if (pageData.length === 0) { tbody.innerHTML = `<tr><td colspan="${this.headers.length + 1}" class="text-center py-4 text-gray-500">Tidak ada data.</td></tr>`; return; }
                tbody.innerHTML = pageData.map((row, index) => {
                    const filteredIndex = start + index; // Correct index in the filteredData array
                    let cells = this.headers.map(header => {
                        const value = row[header] || '-';
                        let cellClass = 'py-3 px-4';
                        const lowerCaseValue = String(value).toLowerCase();
                        if (header.toLowerCase().includes('status')) {
                            if (['ok', 'closed'].includes(lowerCaseValue)) cellClass += ' text-green-600 font-semibold';
                            else if (['hold', 'open'].includes(lowerCaseValue)) cellClass += ' text-orange-500 font-semibold';
                            else if (lowerCaseValue === 'need') cellClass += ' text-red-600 font-semibold';
                        }
                        else if (header.toLowerCase().includes('score')) { const score = parseFloat(value); if (!isNaN(score)) { if (score < 75) cellClass += ' text-red-600 font-bold'; else cellClass += ' text-green-600 font-bold'; } }
                        return `<td class="${cellClass}">${value}</td>`;
                    }).join('');
                    cells += `<td class="py-3 px-4"><button class="text-purple-600 hover:underline text-sm detail-btn" data-tbody-id="${this.tableId}" data-index="${filteredIndex}">Detail</button></td>`;
                    return `<tr class="border-b hover:bg-gray-50">${cells}</tr>`;
                }).join('');
            }
            renderPagination() {
                const paginationId = this.tableId.replace('-table-body', '-pagination');
                const paginationContainer = document.getElementById(paginationId);
                const summaryId = this.tableId.replace('-table-body', '-summary');
                const summaryContainer = document.getElementById(summaryId);

                if (!paginationContainer) return;

                const totalEntries = this.filteredData.length;
                const totalPages = Math.ceil(totalEntries / this.itemsPerPage);
                const startEntry = totalEntries > 0 ? (this.currentPage - 1) * this.itemsPerPage + 1 : 0;
                const endEntry = Math.min(startEntry + this.itemsPerPage - 1, totalEntries);

                if (summaryContainer) {
                    if (totalEntries > 0) {
                        summaryContainer.textContent = `Menampilkan ${startEntry} sampai ${endEntry} dari ${totalEntries} data`;
                    } else {
                        summaryContainer.textContent = 'Tidak ada data untuk ditampilkan';
                    }
                }

                if (totalPages <= 1) {
                    paginationContainer.innerHTML = '';
                    return;
                }

                let html = `<button class="pagination-btn ${this.currentPage === 1 ? 'disabled' : ''}" ${this.currentPage === 1 ? 'disabled' : ''} data-page="${this.currentPage - 1}">‹</button>`;
                for (let i = 1; i <= totalPages; i++) { html += `<button class="pagination-btn ${i === this.currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`; }
                html += `<button class="pagination-btn ${this.currentPage === totalPages ? 'disabled' : ''}" ${this.currentPage === totalPages ? 'disabled' : ''} data-page="${this.currentPage + 1}">›</button>`;
                paginationContainer.innerHTML = html;
                paginationContainer.addEventListener('click', (e) => { if (e.target.classList.contains('pagination-btn') && !e.target.disabled) { this.currentPage = parseInt(e.target.dataset.page); this.render(); } });
            }
            updateData(newData) { this.originalData = [...newData]; this.applyFilters(); }
        }

        // ========== CHART MANAGEMENT ==========
        const chartInstances = {};
        let currentDate = new Date();

        function initializeCharts() {
            const defaultChartOptions = (extraOptions = {}) => ({
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: appState.currentTheme === 'dark' ? '#f1f5f9' : '#1f2937' } } },
                scales: {
                    x: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.2)' } },
                    y: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.2)' } }
                }, ...extraOptions
            });
            const createChart = (id, type, options) => {
                const ctx = document.getElementById(id)?.getContext("2d");
                if (ctx) { if (chartInstances[id]) chartInstances[id].destroy(); chartInstances[id] = new Chart(ctx, { type, data: { labels: [], datasets: [] }, options }); }
            };
            createChart('employeeSummaryChart', 'doughnut', defaultChartOptions({ plugins: { legend: { display: false } } }));
            createChart('thisWeekActivityChart', 'line', defaultChartOptions({ scales: { y: { beginAtZero: true } } }));
            createChart('kompetensiChart', 'bar', defaultChartOptions({ plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }));
            createChart('progressPelatihanChart', 'doughnut', defaultChartOptions({ plugins: { legend: { position: 'bottom' } } }));
            createChart('topPelatihanChart', 'bar', defaultChartOptions({ indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }));
            createChart('trenInsidenChart', 'line', defaultChartOptions({ plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }));
            createChart('klasifikasiInsidenChart', 'pie', defaultChartOptions({ plugins: { legend: { position: 'right' } } }));
            createChart('hsePerformanceChart', 'line', defaultChartOptions({ scales: { y: { beginAtZero: true, position: 'left' } } }));
            createChart('trenObservasiChart', 'line', defaultChartOptions({ plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }));
            createChart('kategoriObservasiChart', 'pie', defaultChartOptions({ plugins: { legend: { position: 'right' } } }));
        }

        // ========== UI UPDATE FUNCTIONS ==========
        function updateUI(data) {
            appState.data = data;
            hideError();
            updateNamaPerusahaan(data.setting);
            initializeTables(data);
            applyGlobalFilters(); // Apply filters which will call update functions
            populateManpowerList(data.kompetensiManpower);
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth(), data.jadwalTraining);
            document.querySelectorAll('.component-loading').forEach(el => el.classList.remove('component-loading'));
        }

        function applyGlobalFilters() {
            // This function now triggers all data-dependent UI updates
            updateMainDashboard(appState.data);
            updateInduksiDashboard(appState.data);
            updatePelatihanDashboard(appState.data);
            updateLaporanDashboard(appState.data);
            updateObservasiDashboard(appState.data);

            // Re-filter all tables
            Object.values(appState.tables).forEach(table => table.applyFilters());
        }

        function updateNamaPerusahaan(settingData) {
            const companyName = settingData[0]?.namaPerusahaan || 'GAMITAS';
            const initial = companyName.charAt(0);
            document.getElementById('company-name-sidebar').innerHTML = `<span class="text-purple-600">${initial}</span>${companyName.slice(1)}`;
            document.getElementById('splash-logo').textContent = initial;
            document.getElementById('splash-company-name').textContent = companyName;
        }
        function updateMainDashboard(data) {
            const empSummary = { cleared: 320, stayHome: 26, serious: 4, notReported: 15 };
            document.getElementById('emp-cleared').textContent = empSummary.cleared;
            document.getElementById('emp-stay-home').textContent = empSummary.stayHome;
            document.getElementById('emp-serious').textContent = empSummary.serious;
            document.getElementById('emp-not-reported').textContent = empSummary.notReported;
            if (chartInstances.employeeSummaryChart) {
                chartInstances.employeeSummaryChart.data = {
                    labels: ['Izin di rumah', 'Kasus serius', 'Tidak melapor', 'Siap bekerja'],
                    datasets: [{
                        data: [empSummary.stayHome, empSummary.serious, empSummary.notReported, empSummary.cleared],
                        backgroundColor: ['#dc2626', '#f59e0b', '#6b7280', '#16a34a'],
                        borderWidth: 0
                    }]
                };
                chartInstances.employeeSummaryChart.update();
            }
            const todayStr = new Date().toLocaleDateString('en-CA');
            document.getElementById('visitor-on-site').textContent = data.visitor.filter(v => v.DATE === todayStr).length;
            document.getElementById('visitor-expected').textContent = 12; // Mock data
            const weeklyLabels = [], weeklyStaffData = [], weeklyVisitorData = [];
            let totalWeeklyStaff = 0, totalWeeklyVisitors = 0;
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const dayStr = d.toLocaleDateString('en-CA'), dayLabel = d.getDate().toString();
                const staffCount = data.newHire.filter(item => item.tanggal === dayStr).length + data.pascaCuti.filter(item => item.DATE === dayStr).length + data.temporary.filter(item => item.DATE === dayStr).length;
                const visitorCount = data.visitor.filter(item => item.DATE === dayStr).length;
                weeklyLabels.push(dayLabel); weeklyStaffData.push(staffCount); weeklyVisitorData.push(visitorCount);
                totalWeeklyStaff += staffCount; totalWeeklyVisitors += visitorCount;
            }
            document.getElementById('weekly-staff').textContent = totalWeeklyStaff;
            document.getElementById('weekly-visitors').textContent = totalWeeklyVisitors;
            if (chartInstances.thisWeekActivityChart) { chartInstances.thisWeekActivityChart.data = { labels: weeklyLabels, datasets: [{ label: 'Staf', data: weeklyStaffData, borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.4, fill: true }, { label: 'Pengunjung', data: weeklyVisitorData, borderColor: '#14b8a6', backgroundColor: 'rgba(20, 184, 166, 0.1)', tension: 0.4, fill: true }] }; chartInstances.thisWeekActivityChart.update(); }
        }
        function updateInduksiDashboard(data) {
            const today = new Date(), yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
            const todayStr = today.toLocaleDateString('en-CA'), yesterdayStr = yesterday.toLocaleDateString('en-CA');
            const mainCompany = data.setting.length > 0 ? data.setting[0].namaPerusahaan : "PT. Ganda Alam Makmur";
            const induksiToday = [...data.newHire.filter(d => d.tanggal === todayStr), ...data.pascaCuti.filter(d => d.DATE === todayStr), ...data.temporary.filter(d => d.DATE === todayStr)];
            const induksiYesterday = [...data.newHire.filter(d => d.tanggal === yesterdayStr), ...data.pascaCuti.filter(d => d.DATE === yesterdayStr), ...data.temporary.filter(d => d.DATE === yesterdayStr)];
            const visitorsToday = data.visitor.filter(d => d.DATE === todayStr), visitorsYesterday = data.visitor.filter(d => d.DATE === yesterdayStr);
            updateCard('induksi-core', induksiToday.filter(d => (d.perusahaan || d.PERUSAHAAN) === mainCompany), induksiYesterday.filter(d => (d.perusahaan || d.PERUSAHAAN) === mainCompany));
            updateCard('induksi-mitra', induksiToday.filter(d => (d.perusahaan || d.PERUSAHAAN) !== mainCompany), induksiYesterday.filter(d => (d.perusahaan || d.PERUSAHAAN) !== mainCompany));
            updateCard('induksi-visitor', visitorsToday, visitorsYesterday);
            document.getElementById('status-new-hire').textContent = data.newHire.filter(d => d.tanggal === todayStr).length;
            document.getElementById('status-cuti').textContent = data.pascaCuti.filter(d => d.DATE === todayStr).length;
            const todayScores = [...induksiToday, ...visitorsToday].map(d => parseFloat(d.SCORE)).filter(s => !isNaN(s));
            const yesterdayScores = [...induksiYesterday, ...visitorsYesterday].map(d => parseFloat(d.SCORE)).filter(s => !isNaN(s));
            updateScoreCard('skor-terendah', todayScores, yesterdayScores, Math.min, false);
            updateScoreCard('skor-tertinggi', todayScores, yesterdayScores, Math.max, true);
            updateScoreCard('skor-rata', todayScores, yesterdayScores, arr => arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0, true);
            document.getElementById('kode-akses-value').textContent = data.kodeAkses.find(k => k.tanggal === todayStr)?.kode_akses || 'N/A';
            updateBreakdownCard('pendaftaran', data.pendaftaranInduksi, 'PERUSAHAAN');
            updateBreakdownCard('approval', data.newHire.filter(d => d.STATUS && d.STATUS.toLowerCase() !== 'pending'), 'perusahaan');
            updateBreakdownCard('temporary', data.temporary, 'PERUSAHAAN');
        }
        function updateCard(id, todayData, yesterdayData) {
            const todayCount = todayData.length, yesterdayCount = yesterdayData.length, diff = todayCount - yesterdayCount;
            document.getElementById(`${id}-today`).textContent = todayCount;
            const detailEl = document.getElementById(`${id}-detail`);
            if (detailEl) {
                let icon = '', color = 'text-gray-500';
                if (diff > 0) { icon = `<i data-lucide="arrow-up" class="w-3 h-3 mr-1"></i>`; color = 'text-green-500'; }
                else if (diff < 0) { icon = `<i data-lucide="arrow-down" class="w-3 h-3 mr-1"></i>`; color = 'text-red-500'; }
                detailEl.innerHTML = `<span class="flex items-center ${color}">${icon} ${Math.abs(diff)} vs kemarin</span>`;
                lucide.createIcons();
            }
        }
        function updateScoreCard(id, todayScores, yesterdayScores, aggregator, higherIsBetter) {
            const el = document.getElementById(id); if (!el) return;
            const todayValue = todayScores.length > 0 ? aggregator(todayScores) : 0;
            const yesterdayValue = yesterdayScores.length > 0 ? aggregator(yesterdayScores) : 0;
            const diff = todayValue - yesterdayValue;
            let icon = '', color = 'text-gray-500';
            if (diff > 0) { icon = `<i data-lucide="arrow-up" class="w-3 h-3 mr-1"></i>`; color = higherIsBetter ? 'text-green-500' : 'text-red-500'; }
            else if (diff < 0) { icon = `<i data-lucide="arrow-down" class="w-3 h-3 mr-1"></i>`; color = higherIsBetter ? 'text-red-500' : 'text-green-500'; }
            el.innerHTML = `<div><p class="text-xs capitalize">${id.split('-')[1]}</p><p class="text-xl font-bold">${todayValue.toFixed(1)}</p><p class="flex items-center justify-center text-xs ${color}">${icon} ${yesterdayValue.toFixed(1)} vs kemarin</p></div>`;
            lucide.createIcons();
        }
        function updateBreakdownCard(id, data, companyField) {
            document.getElementById(`total-${id}`).textContent = data.length;
            const counts = data.reduce((acc, item) => { const company = item[companyField] || 'Lainnya'; acc[company] = (acc[company] || 0) + 1; return acc; }, {});
            const sortedCounts = Object.entries(counts).sort((a, b) => b[1] - a[1]);
            document.getElementById(`${id}-breakdown`).querySelector('div').innerHTML = sortedCounts.map(([company, count]) => `<span class="mx-4 whitespace-nowrap">${company} (<span class="font-semibold">${count}</span>)</span>`).join('');
        }
        function updatePelatihanDashboard(data) {
            const cards = document.querySelector('#pelatihan-stats-cards');
            const totalKompetensi = new Set(data.kompetensiManpower.map(item => item.KOMPETENSI)).size;
            const totalManpower = new Set(data.kompetensiManpower.map(item => item.NIK)).size;
            const totalKebutuhan = data.monitoringInternal.reduce((sum, item) => sum + (parseInt(item['NEED TRAINING']) || 0), 0);
            cards.children[0].querySelector('p.text-3xl').textContent = totalKompetensi;
            cards.children[1].querySelector('p.text-3xl').textContent = totalManpower;
            cards.children[2].querySelector('p.text-3xl').textContent = totalKebutuhan;
            const kompetensiCounts = data.kompetensiManpower.reduce((acc, item) => { const komp = item.KOMPETENSI || ""; if (komp.includes('POP')) acc.pop++; if (komp.includes('POM')) acc.pom++; if (komp.includes('POU')) acc.pou++; return acc; }, { pop: 0, pom: 0, pou: 0 });
            if (chartInstances.kompetensiChart) {
                chartInstances.kompetensiChart.data = {
                    labels: ['POP', 'POM', 'POU'],
                    datasets: [{
                        label: 'Jumlah Kompetensi',
                        data: [kompetensiCounts.pop, kompetensiCounts.pom, kompetensiCounts.pou],
                        backgroundColor: ['#8b5cf6', '#06b6d4', '#10b981']
                    }]
                };
                chartInstances.kompetensiChart.update();
            }
            const totalDone = data.monitoringInternal.reduce((sum, item) => sum + (parseInt(item.DONE) || 0), 0);
            if (chartInstances.progressPelatihanChart) {
                chartInstances.progressPelatihanChart.data = {
                    labels: ['Selesai', 'Belum Selesai'],
                    datasets: [{
                        data: [totalDone, totalKebutuhan > totalDone ? totalKebutuhan - totalDone : 0],
                        backgroundColor: ['#10b981', '#e5e7eb'],
                        borderWidth: 0
                    }]
                };
                chartInstances.progressPelatihanChart.update();
            }
            const top5 = data.monitoringInternal.filter(item => item['NEED TRAINING']).sort((a, b) => parseInt(b['NEED TRAINING']) - parseInt(a['NEED TRAINING'])).slice(0, 5);
            if (chartInstances.topPelatihanChart) {
                chartInstances.topPelatihanChart.data = {
                    labels: top5.map(item => item['INTERNAL TRAINING']),
                    datasets: [{
                        label: 'Kebutuhan',
                        data: top5.map(item => parseInt(item['NEED TRAINING'])),
                        backgroundColor: '#8b5cf6'
                    }]
                };
                chartInstances.topPelatihanChart.update();
            }
            const jadwalList = document.getElementById('jadwal-mendatang-list');
            if (jadwalList) { jadwalList.innerHTML = data.jadwalTraining.slice(0, 3).map(item => `<li class="flex items-center space-x-3"><div class="bg-purple-100 p-2 rounded-lg"><i data-lucide="calendar" class="w-5 h-5 text-purple-600"></i></div><div><p class="font-semibold text-gray-800 text-sm">${item.nama_kegiatan}</p><p class="text-xs text-gray-500">${item['tanggal mulai']} - ${item.tanggal_selesai}</p></div></li>`).join(''); lucide.createIcons(); }
        }
        function updateLaporanDashboard(data) {
            const insidenData = data.dataDasbor, perfData = data.performance;
            document.getElementById('total-insiden').textContent = insidenData.length;
            document.getElementById('total-lti').textContent = insidenData.filter(d => d.kategoriKecelakaan === 'LTI').length;
            document.getElementById('total-non-lti').textContent = insidenData.filter(d => d.kategoriKecelakaan === 'Non-LTI').length;
            document.getElementById('total-near-miss').textContent = insidenData.filter(d => d.kategoriKecelakaan === 'Near Miss').length;
            const monthlyTrend = Array(12).fill(0); insidenData.forEach(d => { const month = new Date(d.tanggalKejadian).getMonth(); if (month >= 0 && month < 12) monthlyTrend[month]++; });
            if (chartInstances.trenInsidenChart) {
                chartInstances.trenInsidenChart.data = {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'],
                    datasets: [{
                        label: 'Jumlah Insiden',
                        data: monthlyTrend,
                        borderColor: '#dc2626',
                        backgroundColor: 'rgba(220, 38, 38, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                };
                chartInstances.trenInsidenChart.update();
            }
            const classificationCounts = insidenData.reduce((acc, d) => { const cat = d.kategoriKecelakaan || 'Lainnya'; acc[cat] = (acc[cat] || 0) + 1; return acc; }, {});
            if (chartInstances.klasifikasiInsidenChart) {
                chartInstances.klasifikasiInsidenChart.data = {
                    labels: Object.keys(classificationCounts),
                    datasets: [{
                        data: Object.values(classificationCounts),
                        backgroundColor: ['#dc2626', '#f59e0b', '#10b981', '#6b7280']
                    }]
                };
                chartInstances.klasifikasiInsidenChart.update();
            }
            document.getElementById('ltifr-ytd').textContent = perfData.find(row => row.Deskripsi === 'LTIFR (YTD)')?.YTD || '-';
            document.getElementById('trir-ytd').textContent = perfData.find(row => row.Deskripsi === 'TRIR (YTD)')?.YTD || '-';
            document.getElementById('manhours-ytd').textContent = parseFloat(perfData.find(row => row.Deskripsi === 'TOTAL MANHOURS (YTD)')?.YTD || 0).toLocaleString('id-ID');
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const ltifrMonthly = perfData.find(row => row.Deskripsi === 'LTIFR'), trirMonthly = perfData.find(row => row.Deskripsi === 'TRIR');
            if (chartInstances.hsePerformanceChart && ltifrMonthly && trirMonthly) {
                chartInstances.hsePerformanceChart.data = {
                    labels: months,
                    datasets: [
                        { label: 'LTIFR', data: months.map(m => ltifrMonthly[m] || 0), borderColor: '#dc2626', tension: 0.4, yAxisID: 'y' },
                        { label: 'TRIR', data: months.map(m => trirMonthly[m] || 0), borderColor: '#f59e0b', tension: 0.4, yAxisID: 'y' }
                    ]
                };
                chartInstances.hsePerformanceChart.update();
            }
        }
        function updateObservasiDashboard(data) {
            const obsData = data.observasi;
            const total = obsData.length;
            const open = obsData.filter(d => d.status === 'Open').length;
            const closed = total - open;
            const closureRate = total > 0 ? ((closed / total) * 100).toFixed(0) + '%' : 'N/A';

            document.getElementById('total-observasi').textContent = total;
            document.getElementById('total-observasi-terbuka').textContent = open;
            document.getElementById('total-observasi-tertutup').textContent = closed;
            document.getElementById('tingkat-penutupan-observasi').textContent = closureRate;

            const monthlyTrend = Array(12).fill(0);
            obsData.forEach(d => {
                const month = new Date(d.tanggal).getMonth();
                if (month >= 0 && month < 12) monthlyTrend[month]++;
            });
            if (chartInstances.trenObservasiChart) {
                chartInstances.trenObservasiChart.data = {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'],
                    datasets: [{
                        label: 'Jumlah Observasi',
                        data: monthlyTrend,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                };
                chartInstances.trenObservasiChart.update();
            }

            const categoryCounts = obsData.reduce((acc, d) => { const cat = d.kategori || 'Lainnya'; acc[cat] = (acc[cat] || 0) + 1; return acc; }, {});
            if (chartInstances.kategoriObservasiChart) {
                chartInstances.kategoriObservasiChart.data = {
                    labels: Object.keys(categoryCounts),
                    datasets: [{
                        data: Object.values(categoryCounts),
                        backgroundColor: ['#ef4444', '#f97316', '#8b5cf6', '#10b981', '#3b82f6']
                    }]
                };
                chartInstances.kategoriObservasiChart.update();
            }
        }
        function initializeTables(data) {
            appState.tables.newHire = new TableManager('new-hire-table-body', data.newHire, ['tanggal', 'NIK', 'NAMA', 'JABATAN', 'perusahaan', 'STATUS', 'SCORE'], { dateColumn: 'tanggal' });
            appState.tables.pascaCuti = new TableManager('pasca-cuti-table-body', data.pascaCuti, ['DATE', 'NIK', 'NAMA', 'JABATAN', 'PERUSAHAAN', 'STATUS INDUKSI', 'SCORE'], { dateColumn: 'DATE' });
            appState.tables.temporary = new TableManager('temporary-table-body', data.temporary, ['DATE', 'NIK', 'NAMA', 'JABATAN', 'PERUSAHAAN', 'STATUS', 'SCORE'], { dateColumn: 'DATE' });
            appState.tables.visitor = new TableManager('visitor-table-body', data.visitor, ['DATE', 'NIK', 'NAMA', 'JABATAN', 'PERUSAHAAN', 'STATUS', 'SCORE'], { dateColumn: 'DATE' });
            appState.tables.absensi = new TableManager('absensi-table-body', data.pendaftaranInduksi, ['Timestamp', 'NAMA', 'NIK KTP', 'PERUSAHAAN', 'JENIS INDUKSI'], { dateColumn: 'Timestamp' });
            appState.tables.laporan = new TableManager('laporan-insiden-table-body', data.dataDasbor, ['id', 'tanggalKejadian', 'judulInsiden', 'kategoriKecelakaan', 'statusLpi'], { dateColumn: 'tanggalKejadian' });
            appState.tables.observasi = new TableManager('laporan-observasi-table-body', data.observasi, ['id', 'tanggal', 'lokasi', 'kategori', 'status'], { dateColumn: 'tanggal', statusColumn: 'status' });
        }
        function populateManpowerList(manpowerData) {
            const listContainer = document.getElementById('manpower-list'), searchInput = document.getElementById('manpower-search');
            if (!listContainer) return;
            const uniqueManpower = [...new Map(manpowerData.map(item => [item['NIK'], item])).values()];
            let filteredManpower = uniqueManpower;
            const renderList = () => { listContainer.innerHTML = filteredManpower.map(man => `<li class="px-3 py-2 text-sm text-gray-700 rounded-md cursor-pointer hover:bg-purple-100 hover:text-purple-700" data-nik="${man.NIK}">${man.NAMA}</li>`).join(''); };
            if (searchInput) searchInput.addEventListener('input', debounce((e) => { const searchTerm = e.target.value.toLowerCase(); filteredManpower = uniqueManpower.filter(man => man.NAMA.toLowerCase().includes(searchTerm) || man.NIK.toLowerCase().includes(searchTerm)); renderList(); }, 300));
            renderList();
        }
        function showManpowerDetails(nik, manpowerData) {
            const detailContainer = document.getElementById('manpower-detail'); if (!detailContainer) return;
            const competencies = manpowerData.filter(item => item.NIK === nik);
            if (competencies.length === 0) { detailContainer.innerHTML = `<p class="text-gray-500">Tidak ada data untuk NIK ${nik}.</p>`; return; }
            const man = competencies[0];
            detailContainer.innerHTML = `<h4 class="font-bold text-lg text-gray-800">${man.NAMA}</h4><p class="text-sm text-gray-500 mb-4">NIK: ${man.NIK} | ${man.JABATAN}</p><h5 class="font-semibold text-md text-gray-700 mt-4 mb-2">Daftar Kompetensi:</h5><div class="grid grid-cols-1 gap-2">${competencies.map(comp => `<div class="p-2 rounded-lg border ${comp.STATUS === 'VALID' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}"><p class="font-medium">${comp.KOMPETENSI}</p><p class="text-sm">${comp.STATUS}</p></div>`).join('')}</div>`;
        }
        function generateCalendar(year, month, trainingData) {
            const grid = document.getElementById('calendar-grid'), monthYearEl = document.getElementById('calendar-month-year');
            if (!grid || !monthYearEl) return;
            grid.innerHTML = '';
            const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
            monthYearEl.textContent = firstDay.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            const dayHeaders = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            dayHeaders.forEach(day => { grid.innerHTML += `<div class="text-center font-semibold py-2 bg-gray-100 text-gray-600 text-sm">${day}</div>`; });
            for (let i = 0; i < firstDay.getDay(); i++) { grid.innerHTML += `<div class="bg-gray-50"></div>`; }
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const events = trainingData.filter(t => t['tanggal mulai'] === dateStr);
                const dayEl = document.createElement('div');
                dayEl.className = 'p-2 border-t border-gray-200 bg-white min-h-24';
                dayEl.innerHTML = `<span class="text-sm font-medium text-gray-800">${day}</span>`;
                if (events.length > 0) { events.forEach(event => { dayEl.innerHTML += `<p class="text-xs mt-1 bg-purple-100 text-purple-700 rounded px-1 truncate">${event.nama_kegiatan}</p>`; }); }
                grid.appendChild(dayEl);
            }
        }
        function showDetailsInModal(dataObject) {
            const modal = document.getElementById('detail-modal'), modalBody = document.getElementById('detail-modal-body');
            let contentHtml = '<dl class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2">';
            for (const key in dataObject) { contentHtml += `<div class="bg-gray-50 px-3 py-2 rounded-md"><dt class="font-semibold text-gray-600">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</dt><dd class="text-gray-800">${dataObject[key] || '-'}</dd></div>`; }
            modalBody.innerHTML = contentHtml + '</dl>';
            modal.classList.remove('hidden');
        }
        function updateClock() {
            const clockElement = document.getElementById('clock');
            if (clockElement) {
                const now = new Date(), locale = appState.currentLanguage === 'id' ? 'id-ID' : appState.currentLanguage === 'en' ? 'en-GB' : 'ko-KR';
                document.getElementById('day-name').textContent = now.toLocaleDateString(locale, { weekday: 'long' }).toUpperCase();
                document.getElementById('date-number').textContent = now.getDate();
                document.getElementById('month-year').textContent = now.toLocaleDateString(locale, { month: 'long', year: 'numeric' });
                clockElement.textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }).replace(/\./g, ':');
            }
        }

        // ========== NAVIGATION & THEME & LANGUAGE ==========
        function switchPage(pageId) {
            appState.currentPage = pageId;
            document.querySelectorAll('.page-content').forEach(page => page.classList.remove('active'));
            document.getElementById(pageId + '-page')?.classList.add('active');
            const titles = translations[appState.currentLanguage].pageTitles[pageId] || { title: 'Halaman Tidak Ditemukan', subtitle: '' };
            document.querySelector('#header-title h2').textContent = titles.title;
            document.querySelector('#header-title p').textContent = titles.subtitle;
            document.querySelectorAll('.sidebar-link').forEach(link => link.classList.remove('active'));
            document.querySelector(`.sidebar-link[data-page="${pageId}"]`)?.classList.add('active');
            const sidebar = document.getElementById('sidebar');
            if (sidebar.classList.contains('show')) sidebar.classList.remove('show');
        }
        function setupTabs(tabContainerId) {
            const tabContainer = document.getElementById(tabContainerId); if (!tabContainer) return;
            const tabLinks = tabContainer.querySelectorAll('.tab-link'), tabContents = tabContainer.closest('.bg-white').querySelectorAll('.tab-content');
            tabLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const tabId = link.dataset.tab;
                    tabLinks.forEach(l => { l.classList.remove('border-purple-500', 'text-purple-600'); l.classList.add('border-transparent', 'text-gray-500'); });
                    link.classList.add('border-purple-500', 'text-purple-600'); link.classList.remove('border-transparent', 'text-gray-500');
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId + '-content')?.classList.add('active');
                });
            });
        }
        function toggleTheme() {
            appState.currentTheme = appState.currentTheme === "light" ? "dark" : "light";
            document.body.classList.remove("theme-light", "theme-dark");
            document.body.classList.add(`theme-${appState.currentTheme}`);
            localStorage.setItem("theme", appState.currentTheme);
            const themeToggleButton = document.getElementById("theme-toggle");
            if (themeToggleButton) {
                const newIconName = appState.currentTheme === "light" ? "moon" : "sun";
                themeToggleButton.innerHTML = `<i data-lucide="${newIconName}" class="w-5 h-5 text-gray-600"></i>`;
            }
            lucide.createIcons();
            initializeCharts();
            updateUI(appState.data);
        }
        const translations = {
            id: { sidebar_dashboard: "Dashboard", sidebar_induksi: "Induksi", sidebar_induksi_karyawan: "Induksi Karyawan", sidebar_pelatihan: "Pelatihan Internal", sidebar_pelatihan_menu: "Menu Pelatihan", sidebar_laporan_insiden: "Laporan Insiden", sidebar_laporan_observasi: "Laporan Observasi", sidebar_logout: "Keluar", header_search_placeholder: "Cari...", pageTitles: { dashboard: { title: 'Dashboard Utama', subtitle: 'Ringkasan aktivitas operasional' }, induksi: { title: 'Induksi & Izin Tambang', subtitle: 'Manajemen semua kegiatan induksi' }, pelatihan: { title: 'Pelatihan & Kompetensi', subtitle: 'Manajemen pelatihan dan kompetensi' }, laporan: { title: 'Laporan Insiden', subtitle: 'Analisis dan data insiden K3' }, observasi: { title: 'Laporan Observasi', subtitle: 'Manajemen laporan observasi keselamatan' } }, employee_summary_title: "Ringkasan Karyawan Hari Ini", employee_summary_subtitle: "Snapshot Kesejahteraan Karyawan Real-time", employee_summary_cleared: "Siap bekerja", employee_summary_stay_home: "Izin di rumah", employee_summary_serious: "Kasus serius", employee_summary_not_reported: "Tidak melapor", visitor_summary_title: "Ringkasan Pengunjung Hari Ini", visitor_summary_subtitle: "Pengunjung Saat Ini atau yang Diharapkan", visitor_summary_on_site: "Saat ini di Lokasi", visitor_summary_expected: "Diharapkan Datang Hari Ini", weekly_activity_title: "Aktivitas Minggu Ini", weekly_activity_staff: "Staf", weekly_activity_visitors: "Pengunjung", weekly_activity_show_all: "Lihat semua", induksi_tab_dashboard: "Dashboard Induksi", induksi_tab_new_hire: "Induksi Karyawan Baru", induksi_tab_pasca_cuti: "Induksi Pasca Cuti", induksi_tab_temporary: "Sementara", induksi_tab_visitor: "Pengunjung", induksi_tab_absensi: "Absensi", pelatihan_tab_dashboard: "Dashboard Pelatihan", pelatihan_tab_manpower: "Pelatihan Manpower", pelatihan_tab_matrix: "Matrix Kompetensi", pelatihan_tab_jadwal: "Jadwal Pelatihan", pelatihan_tab_atmp: "ATMP", pelatihan_dashboard_card1_title: "Total Kompetensi Tercatat", pelatihan_dashboard_card2_title: "Total Manpower Terlatih", pelatihan_dashboard_card3_title: "Total Kebutuhan Pelatihan", pelatihan_dashboard_kompetensi_title: "Grafik Sebaran Kompetensi POP, POM, POU", pelatihan_dashboard_progress_title: "Progress Pelatihan Keseluruhan", pelatihan_dashboard_top5_title: "Top 5 Pelatihan yang Paling Dibutuhkan", pelatihan_dashboard_jadwal_title: "Jadwal Mendatang", laporan_tab_dashboard: "Dashboard Insiden", laporan_tab_data: "Data Laporan", laporan_tab_hse: "Kinerja K3", laporan_dashboard_card1_title: "Total Insiden", laporan_dashboard_card2_title: "Kasus Berat (LTI)", laporan_dashboard_card3_title: "Kasus Ringan (Non-LTI)", laporan_dashboard_card4_title: "Nyaris Celaka", laporan_dashboard_tren_title: "Tren Insiden Bulanan", laporan_dashboard_klasifikasi_title: "Klasifikasi Insiden", laporan_data_title: "Semua Laporan Insiden", laporan_data_button_new: "Buat Laporan Baru", laporan_data_table_id: "ID", laporan_data_table_tanggal: "Tanggal", laporan_data_table_judul: "Judul Insiden", laporan_data_table_klasifikasi: "Klasifikasi", laporan_data_table_status: "Status", laporan_data_table_aksi: "Aksi", laporan_hse_ltifr: "LTIFR (YTD)", laporan_hse_trir: "TRIR (YTD)", laporan_hse_manhours: "Total Jam Kerja", laporan_hse_chart_title: "Performa LTIFR & TRIR Bulanan", observasi_tab_dashboard: "Dashboard Observasi", observasi_tab_data: "Data Observasi", observasi_tab_analisis: "Analisis Observasi", observasi_dashboard_card1_title: "Total Observasi", observasi_dashboard_card2_title: "Observasi Terbuka", observasi_dashboard_card3_title: "Observasi Tertutup", observasi_dashboard_card4_title: "Tingkat Penutupan", observasi_dashboard_tren_title: "Tren Observasi Bulanan", observasi_dashboard_kategori_title: "Kategori Observasi", observasi_data_title: "Semua Laporan Observasi", observasi_data_button_new: "Buat Laporan Baru", observasi_data_table_id: "ID", observasi_data_table_tanggal: "Tanggal", observasi_data_table_lokasi: "Lokasi", observasi_data_table_kategori: "Kategori", observasi_data_table_status: "Status", observasi_data_table_aksi: "Aksi" },
            en: { sidebar_dashboard: "Dashboard", sidebar_induksi: "Induction", sidebar_induksi_karyawan: "Employee Induction", sidebar_pelatihan: "Internal Training", sidebar_pelatihan_menu: "Training Menu", sidebar_laporan_insiden: "Incident Report", sidebar_laporan_observasi: "Observation Report", sidebar_logout: "Logout", header_search_placeholder: "Search...", pageTitles: { dashboard: { title: 'Main Dashboard', subtitle: 'Summary of operational activities' }, induksi: { title: 'Induction & Mine Permit', subtitle: 'Management of all induction activities' }, pelatihan: { title: 'Training & Competency', subtitle: 'Management of training and competency' }, laporan: { title: 'Incident Report', subtitle: 'Analysis and HSE incident data' }, observasi: { title: 'Observation Report', subtitle: 'Management of safety observation reports' } }, employee_summary_title: "Today's Employees Summary", employee_summary_subtitle: "Real-time Employee Well-being Snapshot", employee_summary_cleared: "Cleared for work", employee_summary_stay_home: "Stay at home", employee_summary_serious: "Serious case", employee_summary_not_reported: "Not reported", visitor_summary_title: "Today's Visitors Summary", visitor_summary_subtitle: "Current or Expected Visitors", visitor_summary_on_site: "Currently on Site", visitor_summary_expected: "Expected Later Today", weekly_activity_title: "This Week's Activity", weekly_activity_staff: "Staff", weekly_activity_visitors: "Visitors", weekly_activity_show_all: "Show all", induksi_tab_dashboard: "Induction Dashboard", induksi_tab_new_hire: "New Hire Induction", induksi_tab_pasca_cuti: "Post-Leave Induction", induksi_tab_temporary: "Temporary", induksi_tab_visitor: "Visitor", induksi_tab_absensi: "Attendance", pelatihan_tab_dashboard: "Training Dashboard", pelatihan_tab_manpower: "Manpower Training", pelatihan_tab_matrix: "Competency Matrix", pelatihan_tab_jadwal: "Training Schedule", pelatihan_tab_atmp: "ATMP", pelatihan_dashboard_card1_title: "Total Competencies Recorded", pelatihan_dashboard_card2_title: "Total Trained Manpower", pelatihan_dashboard_card3_title: "Total Training Needs", pelatihan_dashboard_kompetensi_title: "Competency Distribution Chart (POP, POM, POU)", pelatihan_dashboard_progress_title: "Overall Training Progress", pelatihan_dashboard_top5_title: "Top 5 Most Needed Trainings", pelatihan_dashboard_jadwal_title: "Upcoming Schedule", laporan_tab_dashboard: "Incident Dashboard", laporan_tab_data: "Report Data", laporan_tab_hse: "HSE Performance", laporan_dashboard_card1_title: "Total Incidents", laporan_dashboard_card2_title: "Severe Cases (LTI)", laporan_dashboard_card3_title: "Minor Cases (Non-LTI)", laporan_dashboard_card4_title: "Near Miss", laporan_dashboard_tren_title: "Monthly Incident Trend", laporan_dashboard_klasifikasi_title: "Incident Classification", laporan_data_title: "All Incident Reports", laporan_data_button_new: "Create New Report", laporan_data_table_id: "ID", laporan_data_table_tanggal: "Date", laporan_data_table_judul: "Incident Title", laporan_data_table_klasifikasi: "Classification", laporan_data_table_status: "Status", laporan_data_table_aksi: "Action", laporan_hse_ltifr: "LTIFR (YTD)", laporan_hse_trir: "TRIR (YTD)", laporan_hse_manhours: "Total Man Hours", laporan_hse_chart_title: "Monthly LTIFR & TRIR Performance", observasi_tab_dashboard: "Observation Dashboard", observasi_tab_data: "Observation Data", observasi_tab_analisis: "Observation Analysis", observasi_dashboard_card1_title: "Total Observations", observasi_dashboard_card2_title: "Open Observations", observasi_dashboard_card3_title: "Closed Observations", observasi_dashboard_card4_title: "Closure Rate", observasi_dashboard_tren_title: "Monthly Observation Trend", observasi_dashboard_kategori_title: "Observation Category", observasi_data_title: "All Observation Reports", observasi_data_button_new: "Create New Report", observasi_data_table_id: "ID", observasi_data_table_tanggal: "Date", observasi_data_table_lokasi: "Location", observasi_data_table_kategori: "Category", observasi_data_table_status: "Status", observasi_data_table_aksi: "Action" },
            ko: { sidebar_dashboard: "대시보드", sidebar_induksi: "교육", sidebar_induksi_karyawan: "직원 교육", sidebar_pelatihan: "내부 훈련", sidebar_pelatihan_menu: "훈련 메뉴", sidebar_laporan_insiden: "사고 보고서", sidebar_laporan_observasi: "관찰 보고서", sidebar_logout: "로그아웃", header_search_placeholder: "검색...", pageTitles: { dashboard: { title: '메인 대시보드', subtitle: '운영 활동 요약' }, induksi: { title: '교육 및 광산 허가', subtitle: '모든 교육 활동 관리' }, pelatihan: { title: '훈련 및 역량', subtitle: '훈련 및 역량 관리' }, laporan: { title: '사고 보고서', subtitle: 'HSE 사고 데이터 및 분석' }, observasi: { title: '관찰 보고서', subtitle: '안전 관찰 보고서 관리' } }, employee_summary_title: "오늘의 직원 요약", employee_summary_subtitle: "실시간 직원 웰빙 스냅샷", employee_summary_cleared: "업무 가능", employee_summary_stay_home: "재택", employee_summary_serious: "심각한 경우", employee_summary_not_reported: "보고되지 않음", visitor_summary_title: "오늘의 방문자 요약", visitor_summary_subtitle: "현재 또는 예상 방문자", visitor_summary_on_site: "현재 현장에 있음", visitor_summary_expected: "오늘 늦게 예상됨", weekly_activity_title: "이번 주 활동", weekly_activity_staff: "직원", weekly_activity_visitors: "방문객", weekly_activity_show_all: "모두 보기", induksi_tab_dashboard: "교육 대시보드", induksi_tab_new_hire: "신입 사원 교육", induksi_tab_pasca_cuti: "휴가 후 교육", induksi_tab_temporary: "임시직", induksi_tab_visitor: "방문객", induksi_tab_absensi: "출석", pelatihan_tab_dashboard: "훈련 대시보드", pelatihan_tab_manpower: "인력 훈련", pelatihan_tab_matrix: "역량 매트릭스", pelatihan_tab_jadwal: "훈련 일정", pelatihan_tab_atmp: "ATMP", pelatihan_dashboard_card1_title: "기록된 총 역량", pelatihan_dashboard_card2_title: "훈련된 총 인력", pelatihan_dashboard_card3_title: "총 훈련 필요", pelatihan_dashboard_kompetensi_title: "역량 분포 차트 (POP, POM, POU)", pelatihan_dashboard_progress_title: "전체 훈련 진행 상황", pelatihan_dashboard_top5_title: "가장 필요한 상위 5개 훈련", pelatihan_dashboard_jadwal_title: "예정된 일정", laporan_tab_dashboard: "사고 대시보드", laporan_tab_data: "보고서 데이터", laporan_tab_hse: "HSE 성과", laporan_dashboard_card1_title: "총 사고", laporan_dashboard_card2_title: "심각한 사례 (LTI)", laporan_dashboard_card3_title: "경미한 사례 (Non-LTI)", laporan_dashboard_card4_title: "아차 사고", laporan_dashboard_tren_title: "월간 사고 동향", laporan_dashboard_klasifikasi_title: "사고 분류", laporan_data_title: "모든 사고 보고서", laporan_data_button_new: "새 보고서 작성", laporan_data_table_id: "ID", laporan_data_table_tanggal: "날짜", laporan_data_table_judul: "사고 제목", laporan_data_table_klasifikasi: "분류", laporan_data_table_status: "상태", laporan_data_table_aksi: "조치", laporan_hse_ltifr: "LTIFR (연간 누계)", laporan_hse_trir: "TRIR (연간 누계)", laporan_hse_manhours: "총 근무 시간", laporan_hse_chart_title: "월간 LTIFR 및 TRIR 성과", observasi_tab_dashboard: "관찰 대시보드", observasi_tab_data: "관찰 데이터", observasi_tab_analisis: "관찰 분석", observasi_dashboard_card1_title: "총 관찰", observasi_dashboard_card2_title: "미해결 관찰", observasi_dashboard_card3_title: "해결된 관찰", observasi_dashboard_card4_title: "해결률", observasi_dashboard_tren_title: "월간 관찰 동향", observasi_dashboard_kategori_title: "관찰 카테고리", observasi_data_title: "모든 관찰 보고서", observasi_data_button_new: "새 보고서 작성", observasi_data_table_id: "ID", observasi_data_table_tanggal: "날짜", observasi_data_table_lokasi: "위치", observasi_data_table_kategori: "카테고리", observasi_data_table_status: "상태", observasi_data_table_aksi: "조치" }
        };
        const setLanguage = (lang) => {
            appState.currentLanguage = lang; localStorage.setItem('language', lang); document.documentElement.lang = lang;
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey, translation = translations[lang][key];
                if (translation) { el.hasAttribute('placeholder') ? el.placeholder = translation : el.innerText = translation; }
            });
            const activePageEl = document.querySelector('.page-content.active');
            if (activePageEl) { const activePageId = activePageEl.id.replace('-page', ''), titles = translations[lang].pageTitles[activePageId]; if (titles) { document.querySelector('#header-title h2').textContent = titles.title; document.querySelector('#header-title p').textContent = titles.subtitle; } }
            updateClock();
        };

        // ========== EXPORT & PWA ==========
        async function handleExport(type) {
            const { jsPDF } = window.jspdf;
            const mainContent = document.getElementById(appState.currentPage + "-page");
            if (!mainContent) { addNotification("Export Error", "Could not find content to export.", "error"); return; }
            document.getElementById("export-menu").classList.add("hidden");
            addNotification("Exporting...", `Preparing your ${type} export.`, "info");
            if (type === "image") { html2canvas(mainContent).then((canvas) => { const link = document.createElement("a"); link.download = `gamitas_dashboard_${new Date().toISOString()}.png`; link.href = canvas.toDataURL("image/png"); link.click(); }); }
            else if (type === "pdf") { const doc = new jsPDF(); const canvas = await html2canvas(mainContent); const imgData = canvas.toDataURL("image/png"); const imgProps = doc.getImageProperties(imgData); const pdfWidth = doc.internal.pageSize.getWidth(); const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width; doc.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight); doc.save(`gamitas_report_${new Date().toISOString()}.pdf`); }
            else if (type === "excel") {
                const data = appState.data.dataDasbor;
                if (data && data.length > 0) { const headers = Object.keys(data[0]); let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n" + data.map(row => headers.map(header => `"${row[header]}"`).join(",")).join("\n"); const encodedUri = encodeURI(csvContent); const link = document.createElement("a"); link.setAttribute("href", encodedUri); link.setAttribute("download", `gamitas_incident_data.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link); }
                else { addNotification("Export Error", "No incident data available to export to Excel.", "error"); }
            }
        }

        // ========== PASSWORD PROTECTION ==========
        const CORRECT_PASSWORD = "gamitas2025";

        function requestPasswordAndSwitchPage(pageId) {
            if (sessionStorage.getItem('gamitas_access_granted') === 'true') {
                switchPage(pageId);
            } else {
                showPasswordModal(pageId);
            }
        }

        function showPasswordModal(pageId) {
            appState.targetPage = pageId;
            const modal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');

            passwordInput.value = '';
            passwordError.classList.add('hidden');
            modal.classList.remove('hidden');
            passwordInput.focus();
        }

        function handlePasswordSubmit(e) {
            e.preventDefault();
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');

            if (passwordInput.value === CORRECT_PASSWORD) {
                sessionStorage.setItem('gamitas_access_granted', 'true');
                document.getElementById('password-modal').classList.add('hidden');
                if (appState.targetPage) {
                    switchPage(appState.targetPage);
                    appState.targetPage = null;
                }
            } else {
                passwordError.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners(data) {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                const pageId = link.dataset.page;
                const isProtected = pageId === 'pelatihan' || pageId === 'laporan' || pageId === 'observasi';

                if (isProtected) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        requestPasswordAndSwitchPage(pageId);
                    });
                } else {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        switchPage(pageId);
                    });
                }
            });

            document.querySelectorAll('.sidebar-dropdown-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const submenu = toggle.nextElementSibling;
                    if (submenu) {
                        submenu.classList.toggle('hidden');
                    }
                    const icon = toggle.querySelector('i[data-lucide="chevron-down"]');
                    if (icon) {
                        icon.classList.toggle('rotate-180');
                    }
                });
            });
            setupTabs('induksi-tabs'); setupTabs('pelatihan-tabs'); setupTabs('laporan-tabs'); setupTabs('observasi-tabs');
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            const langSwitcher = document.getElementById('language-switcher'), langToggleBtn = document.getElementById('language-toggle-btn'), langMenu = document.getElementById('language-menu');
            langToggleBtn.addEventListener('click', (e) => { e.stopPropagation(); langMenu.classList.toggle('hidden'); });
            langMenu.addEventListener('click', (e) => { e.preventDefault(); const target = e.target.closest('a[data-lang]'); if (target) { setLanguage(target.dataset.lang); langMenu.classList.add('hidden'); } });
            const notificationBtn = document.getElementById('notification-btn'), notificationDropdown = document.getElementById('notification-dropdown');
            notificationBtn.addEventListener('click', (e) => { e.stopPropagation(); notificationDropdown.classList.toggle('hidden'); });
            const exportBtn = document.getElementById('export-btn'), exportMenu = document.getElementById('export-menu');
            exportBtn.addEventListener('click', (e) => { e.stopPropagation(); exportMenu.classList.toggle('hidden'); });
            document.querySelectorAll(".export-option").forEach((opt) => opt.addEventListener("click", (e) => handleExport(e.currentTarget.dataset.type)));
            document.addEventListener('click', (e) => { if (!langSwitcher.contains(e.target)) langMenu.classList.add('hidden'); if (!notificationBtn.parentElement.contains(e.target)) notificationDropdown.classList.add('hidden'); if (!exportBtn.parentElement.contains(e.target)) exportMenu.classList.add('hidden'); });
            document.getElementById('retry-btn').addEventListener('click', async () => { hideError(); document.getElementById('splash-screen').style.display = 'flex'; localStorage.clear(); const newData = await loadAllData(); updateUI(newData); document.getElementById('splash-screen').style.display = 'none'; });

            // CORRECTED DETAIL BUTTON CLICK HANDLER
            document.getElementById('page-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('detail-btn')) {
                    const tbodyId = e.target.dataset.tbodyId;
                    const rowIndex = parseInt(e.target.dataset.index); // This is the index in filteredData

                    const tableKeyMap = {
                        'new-hire-table-body': 'newHire',
                        'pasca-cuti-table-body': 'pascaCuti',
                        'temporary-table-body': 'temporary',
                        'visitor-table-body': 'visitor',
                        'absensi-table-body': 'absensi',
                        'laporan-insiden-table-body': 'laporan',
                        'laporan-observasi-table-body': 'observasi'
                    };

                    const tableKey = tableKeyMap[tbodyId];
                    if (tableKey && appState.tables[tableKey]) {
                        const tableInstance = appState.tables[tableKey];
                        const dataObject = tableInstance.filteredData[rowIndex];
                        if (dataObject) {
                            showDetailsInModal(dataObject);
                        }
                    }
                }
            });

            document.getElementById('add-new-hire-btn')?.addEventListener('click', () => document.getElementById('add-data-modal').classList.remove('hidden'));
            document.getElementById('add-data-form')?.addEventListener('submit', (e) => { e.preventDefault(); const formData = new FormData(e.target), newData = Object.fromEntries(formData); newData.tanggal = new Date().toLocaleDateString('en-CA'); newData.STATUS = 'OK'; newData.SCORE = (Math.random() * 20 + 80).toFixed(1); appState.data.newHire.push(newData); appState.tables.newHire.updateData(appState.data.newHire); e.target.closest('.fixed').classList.add('hidden'); e.target.reset(); addNotification("Data Ditambah", `Data ${newData.nama} berhasil ditambahkan`, "success"); });
            document.getElementById('manpower-list')?.addEventListener('click', (e) => { if (e.target?.matches('li')) { showManpowerDetails(e.target.dataset.nik, data.kompetensiManpower); document.querySelectorAll('#manpower-list li').forEach(li => li.classList.remove('bg-purple-200')); e.target.classList.add('bg-purple-200'); } });
            document.getElementById('prev-month')?.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth(), data.jadwalTraining); });
            document.getElementById('next-month')?.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth(), data.jadwalTraining); });
            document.body.addEventListener('click', (e) => { if (e.target.classList.contains('modal-close-btn') || e.target.closest('.modal-close-btn') || e.target.matches('.fixed.inset-0')) { document.querySelectorAll('.fixed.inset-0').forEach(modal => modal.classList.add('hidden')); } });
            document.getElementById("install-button")?.addEventListener("click", () => appState.deferredInstallPrompt?.prompt());
            window.addEventListener("beforeinstallprompt", (e) => { e.preventDefault(); appState.deferredInstallPrompt = e; document.getElementById("install-button").style.display = "flex"; });
            window.addEventListener("online", () => document.getElementById("offline-banner").classList.remove("show"));
            window.addEventListener("offline", () => document.getElementById("offline-banner").classList.add("show"));
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            mobileMenuToggle.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('show'); });
            document.addEventListener('click', (e) => { if (!sidebar.contains(e.target) && !mobileMenuToggle.contains(e.target)) { sidebar.classList.remove('show'); } });

            document.getElementById('password-form')?.addEventListener('submit', handlePasswordSubmit);

            const datePicker = flatpickr("#date-range-picker", {
                mode: "range",
                dateFormat: "Y-m-d",
                onChange: function (selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        appState.startDate = selectedDates[0];
                        appState.endDate = selectedDates[1];
                        applyGlobalFilters();
                    }
                }
            });
            document.getElementById('clear-date-filter').addEventListener('click', () => {
                datePicker.clear();
                appState.startDate = null;
                appState.endDate = null;
                applyGlobalFilters();
            });

            setInterval(updateClock, 1000);
            updateClock();
        }

        // ========== MAIN APPLICATION INITIALIZATION ==========
        document.addEventListener('DOMContentLoaded', async function () {
            const splashScreen = document.getElementById('splash-screen');
            try {
                document.body.classList.add(`theme-${appState.currentTheme}`);
                const themeToggleButton = document.getElementById("theme-toggle");
                if (themeToggleButton) {
                    const iconName = appState.currentTheme === 'light' ? 'moon' : 'sun';
                    themeToggleButton.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5 text-gray-600"></i>`;
                }
                const template = document.getElementById('page-templates');
                document.getElementById('page-container').innerHTML = template.innerHTML;
                updateSplashScreen(10, "Initializing icons and charts...");
                lucide.createIcons();
                initializeCharts();
                const data = await loadAllData();
                updateSplashScreen(95, "Rendering UI...");
                updateUI(data);
                setupEventListeners(data);
                setLanguage(appState.currentLanguage);
                switchPage('dashboard');
                updateNotificationUI();
                addNotification("Selamat Datang!", "Dasbor GAMITAS siap digunakan.", "success");
                splashScreen.style.opacity = "0";
                setTimeout(() => splashScreen.style.display = "none", 500);
            } catch (error) {
                console.error("Fatal initialization error:", error);
                splashScreen.innerHTML = `<div class="text-center text-white p-4"><i data-lucide="alert-triangle" class="w-16 h-16 mx-auto mb-4"></i><h1 class="text-2xl font-bold">Application Error</h1><p>${error.message}</p><p>Please refresh or contact support.</p></div>`;
                lucide.createIcons();
                showError('Terjadi kesalahan fatal: ' + error.message, true);
            }
        });
    </script>
</body>

</html>