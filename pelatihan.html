<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Pelatihan - GAMITAS</title>

    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-light: #f8fafc;
            --bg-dark: #1e293b;
            --text-light: #1f2937;
            --text-dark: #f1f5f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Theme Styles */
        .theme-dark {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .theme-dark .bg-white {
            background-color: #334155 !important;
        }

        .theme-dark .bg-gray-50,
        .theme-dark .bg-gray-100 {
            background-color: #475569 !important;
        }

        .theme-dark .text-gray-800,
        .theme-dark .text-gray-900 {
            color: #f1f5f9 !important;
        }

        .theme-dark .text-gray-700 {
            color: #e2e8f0 !important;
        }

        .theme-dark .text-gray-600 {
            color: #cbd5e1 !important;
        }

        .theme-dark .text-gray-500 {
            color: #94a3b8 !important;
        }

        .theme-dark .border-gray-200,
        .theme-dark .border-b,
        .theme-dark .border-t {
            border-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-100:hover {
            background-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-50:hover {
            background-color: #4b5a70 !important;
        }

        .theme-dark .shadow-md,
        .theme-dark .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }

        .theme-dark input,
        .theme-dark select {
            background-color: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        .theme-dark input::placeholder {
            color: #94a3b8;
        }

        .theme-dark .tab-link.active {
            color: #a78bfa !important;
            border-color: #a78bfa !important;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .component-loading {
            position: relative;
            min-height: 100px;
            overflow: hidden;
        }

        .component-loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            animation: shimmer 1.5s infinite;
        }

        .theme-dark .component-loading::after {
            background: linear-gradient(90deg, transparent, rgba(100, 116, 139, 0.5), transparent);
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* Loading animation for refresh button */
        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="theme-light">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <div>
                <h1 class="text-2xl font-bold text-gray-800"><span class="text-purple-600">G</span>AMITAS - Pelatihan
                </h1>
                <p id="last-updated" class="text-xs text-gray-500">Memuat data...</p>
            </div>
            <div class="flex items-center space-x-2">
                <a href="./index.html"
                    class="text-purple-600 hover:text-purple-800 font-medium flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100">
                    <i data-lucide="arrow-left-circle"></i>
                    <span class="hidden sm:inline">Kembali</span>
                </a>
                <button id="refresh-button" class="p-2 rounded-full hover:bg-gray-100" title="Muat Ulang Data">
                    <i data-lucide="refresh-cw" class="w-5 h-5 text-gray-600"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100" title="Ganti Tema">
                    <i data-lucide="sun" class="w-5 h-5 text-gray-600"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="p-4 sm:p-6 lg:p-8">
        <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
            <p class="font-bold">Gagal Memuat Data</p>
            <p id="error-message-content">Terjadi kesalahan.</p>
        </div>

        <div id="pelatihan-page" class="page-content active">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" id="pelatihan-tabs">
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-purple-500 px-1 pb-4 text-sm font-medium text-purple-600"
                            data-tab="dashboard-pelatihan">Dashboard Pelatihan</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="pelatihan-manpower">Pelatihan Manpower</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="matrix-kompetensi">Matrix Kompetensi</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="jadwal-pelatihan">Jadwal Pelatihan</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="atmp">ATMP</a>
                    </nav>
                </div>
                <div class="mt-6">
                    <div id="dashboard-pelatihan-content" class="tab-content active">
                        <div class="space-y-6">
                            <div id="pelatihan-stats-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                                <div class="bg-gray-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-gray-500">Total Kompetensi Tercatat</p>
                                    <p class="text-3xl font-bold text-gray-800">-</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-gray-500">Total Manpower Terlatih</p>
                                    <p class="text-3xl font-bold text-gray-800">-</p>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-gray-500">Total Kebutuhan Pelatihan</p>
                                    <p class="text-3xl font-bold text-gray-800">-</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4">Grafik Sebaran Kompetensi POP,
                                        POM, POU</h3>
                                    <div class="h-64"><canvas id="kompetensiChart"></canvas></div>
                                </div>
                                <div class="bg-gray-50 p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4">Progress Pelatihan Keseluruhan
                                    </h3>
                                    <div class="h-64 flex items-center justify-center"><canvas
                                            id="progressPelatihanChart"></canvas></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4">Top 5 Pelatihan yang Paling
                                        Dibutuhkan</h3>
                                    <div class="h-64"><canvas id="topPelatihanChart"></canvas></div>
                                </div>
                                <div class="bg-gray-50 p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4">Jadwal Mendatang</h3>
                                    <ul id="jadwal-mendatang-list" class="space-y-4"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="pelatihan-manpower-content" class="tab-content">
                        <h3 class="text-lg font-semibold mb-4">Detail Kompetensi Manpower</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-1">
                                <div class="mb-4"><input type="text" id="manpower-search"
                                        placeholder="Cari nama manpower..."
                                        class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div class="max-h-96 overflow-y-auto bg-gray-50 p-2 rounded-lg border">
                                    <ul id="manpower-list" class="space-y-1"></ul>
                                </div>
                            </div>
                            <div id="manpower-detail" class="md:col-span-2 p-4 border rounded-lg bg-white">
                                <p class="text-gray-500">Pilih nama dari daftar untuk melihat detail kompetensi.</p>
                            </div>
                        </div>
                    </div>
                    <div id="matrix-kompetensi-content" class="tab-content">
                        <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0"><i data-lucide="info" class="h-5 w-5 text-blue-400"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-blue-700"><strong>Matrix Kompetensi</strong> - Fitur ini
                                        sedang dalam pengembangan. Matrix ini akan menampilkan pemetaan kompetensi
                                        setiap karyawan berdasarkan jabatan dan area kerja.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="jadwal-pelatihan-content" class="tab-content">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <h3 class="text-lg font-semibold">Jadwal Pelatihan - <span id="calendar-month-year"></span>
                            </h3>
                            <div><button id="prev-month" class="p-2 rounded-md hover:bg-gray-100"><i
                                        data-lucide="chevron-left" class="pointer-events-none"></i></button><button
                                    id="next-month" class="p-2 rounded-md hover:bg-gray-100"><i
                                        data-lucide="chevron-right" class="pointer-events-none"></i></button></div>
                        </div>
                        <div id="calendar-grid"
                            class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                        </div>
                    </div>
                    <div id="atmp-content" class="tab-content">
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0"><i data-lucide="calendar"
                                        class="h-5 w-5 text-yellow-400"></i></div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700"><strong>Annual Training Master Plan
                                            (ATMP)</strong> - Fitur ini sedang dalam pengembangan. ATMP akan menampilkan
                                        rencana pelatihan tahunan yang komprehensif untuk semua karyawan.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ========== GLOBAL STATE & UTILITIES ==========
        const appState = {
            data: {},
            currentTheme: localStorage.getItem('theme') || 'light',
            cache: {
                key: 'pelatihan_data_cache', // Single key for all training data
                expiry: 30 * 60 * 1000 // 30 minutes
            },
            lastUpdated: null
        };
        const debounce = (func, wait) => { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; };

        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby7jx5UXyJgpGSk8hxEnvmAC2lY76ujIKYXOei50k0KwDNqJeYSSv8k_J18Elp0sEfX/exec';


        function showErrorBanner(message) {
            const banner = document.getElementById('error-banner');
            const messageContent = document.getElementById('error-message-content');
            if (banner && messageContent) {
                messageContent.innerHTML = message;
                banner.classList.remove('hidden');
            }
        }

        function updateLastUpdatedTimestamp(timestamp) {
            const el = document.getElementById('last-updated');
            if (!el) return;
            if (timestamp) {
                appState.lastUpdated = timestamp;
                const date = new Date(timestamp);
                el.textContent = `Terakhir diperbarui: ${date.toLocaleDateString('id-ID')} ${date.toLocaleTimeString('id-ID')}`;
            } else {
                el.textContent = 'Memperbarui data...';
            }
        }

        // ========== CACHING FUNCTIONS ==========
        function getCachedData() {
            const cachedItem = localStorage.getItem(appState.cache.key);
            if (!cachedItem) return null;
            try {
                const { data, timestamp } = JSON.parse(cachedItem);
                if (Date.now() - timestamp > appState.cache.expiry) {
                    localStorage.removeItem(appState.cache.key);
                    return null;
                }
                console.log(`Loading all training data from cache.`);
                return { data, timestamp };
            } catch (error) {
                localStorage.removeItem(appState.cache.key);
                return null;
            }
        }

        function setCachedData(data) {
            const timestamp = Date.now();
            const itemToCache = { data, timestamp };
            try {
                localStorage.setItem(appState.cache.key, JSON.stringify(itemToCache));
                console.log(`Saved all training data to cache.`);
                updateLastUpdatedTimestamp(timestamp);
            } catch (error) {
                console.error(`Error saving cache:`, error);
            }
        }

        // ========== DATA FETCHING ==========
        async function fetchAllTrainingData() {
            if (APPS_SCRIPT_URL === 'URL_APPS_SCRIPT_ANDA_DI_SINI') {
                showErrorBanner('URL Apps Script belum dikonfigurasi. Silakan perbarui variabel APPS_SCRIPT_URL di dalam kode.');
                return null;
            }
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?source=pelatihan`);
                if (!response.ok) {
                    throw new Error(`Network response was not ok: ${response.statusText}`);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(`Apps Script Error: ${data.error}`);
                }
                return {
                    monitoringInternal: data.monitoring_internal || [],
                    jadwalTraining: data.jadwal_training || [],
                    kompetensiManpower: data.kompetensi_manpower || []
                };
            } catch (error) {
                console.error("Fetch failed permanently for training data:", error);
                showErrorBanner(`Gagal mengambil data dari server. Data yang ditampilkan mungkin usang. Silakan periksa koneksi internet Anda dan coba lagi.`);
                return null;
            }
        }

        // ========== CHART MANAGEMENT ==========
        const chartInstances = {};
        let currentDate = new Date();
        function initializeCharts() {
            const defaultChartOptions = (extraOptions = {}) => ({
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: appState.currentTheme === 'dark' ? '#f1f5f9' : '#1f2937' } } },
                scales: {
                    x: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.2)' } },
                    y: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.2)' } }
                }, ...extraOptions
            });
            const createChart = (id, type, options) => {
                const ctx = document.getElementById(id)?.getContext("2d");
                if (ctx) { if (chartInstances[id]) chartInstances[id].destroy(); chartInstances[id] = new Chart(ctx, { type, data: { labels: [], datasets: [] }, options }); }
            };
            createChart('kompetensiChart', 'bar', defaultChartOptions({ plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }));
            createChart('progressPelatihanChart', 'doughnut', defaultChartOptions({ plugins: { legend: { position: 'bottom' } } }));
            createChart('topPelatihanChart', 'bar', defaultChartOptions({ indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }));
        }

        // ========== UI UPDATE FUNCTIONS ==========
        function updateUI(data) {
            if (!data || !data.monitoringInternal || !data.jadwalTraining || !data.kompetensiManpower) {
                console.warn("Update UI skipped due to incomplete data.");
                return;
            };
            appState.data = data;
            updatePelatihanDashboard(data);
            populateManpowerList(data.kompetensiManpower);
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth(), data.jadwalTraining);
            document.querySelectorAll('.component-loading').forEach(el => el.classList.remove('component-loading'));
        }

        function updatePelatihanDashboard(data) {
            const cards = document.querySelector('#pelatihan-stats-cards');
            const totalKompetensi = new Set(data.kompetensiManpower.map(item => item.KOMPETENSI)).size;
            const totalManpower = new Set(data.kompetensiManpower.map(item => item.NIK)).size;
            const totalKebutuhan = data.monitoringInternal.reduce((sum, item) => sum + (parseInt(item['NEED TRAINING']) || 0), 0);
            cards.children[0].querySelector('p.text-3xl').textContent = totalKompetensi;
            cards.children[1].querySelector('p.text-3xl').textContent = totalManpower;
            cards.children[2].querySelector('p.text-3xl').textContent = totalKebutuhan;

            const kompetensiCounts = data.kompetensiManpower.reduce((acc, item) => { const komp = item.KOMPETENSI || ""; if (komp.includes('POP')) acc.pop++; if (komp.includes('POM')) acc.pom++; if (komp.includes('POU')) acc.pou++; return acc; }, { pop: 0, pom: 0, pou: 0 });
            if (chartInstances.kompetensiChart) {
                chartInstances.kompetensiChart.data = {
                    labels: ['POP', 'POM', 'POU'],
                    datasets: [{ label: 'Jumlah Kompetensi', data: [kompetensiCounts.pop, kompetensiCounts.pom, kompetensiCounts.pou], backgroundColor: ['#8b5cf6', '#06b6d4', '#10b981'] }]
                };
                chartInstances.kompetensiChart.update();
            }

            const totalDone = data.monitoringInternal.reduce((sum, item) => sum + (parseInt(item.DONE) || 0), 0);
            if (chartInstances.progressPelatihanChart) {
                chartInstances.progressPelatihanChart.data = {
                    labels: ['Selesai', 'Belum Selesai'],
                    datasets: [{ data: [totalDone, totalKebutuhan > totalDone ? totalKebutuhan - totalDone : 0], backgroundColor: ['#10b981', '#e5e7eb'], borderWidth: 0 }]
                };
                chartInstances.progressPelatihanChart.update();
            }

            const top5 = data.monitoringInternal.filter(item => item['NEED TRAINING']).sort((a, b) => parseInt(b['NEED TRAINING']) - parseInt(a['NEED TRAINING'])).slice(0, 5);
            if (chartInstances.topPelatihanChart) {
                chartInstances.topPelatihanChart.data = {
                    labels: top5.map(item => item['INTERNAL TRAINING']),
                    datasets: [{ label: 'Kebutuhan', data: top5.map(item => parseInt(item['NEED TRAINING'])), backgroundColor: '#8b5cf6' }]
                };
                chartInstances.topPelatihanChart.update();
            }

            const jadwalList = document.getElementById('jadwal-mendatang-list');
            if (jadwalList) {
                jadwalList.innerHTML = data.jadwalTraining.slice(0, 3).map(item => `<li class="flex items-center space-x-3"><div class="bg-purple-100 p-2 rounded-lg"><i data-lucide="calendar" class="w-5 h-5 text-purple-600"></i></div><div><p class="font-semibold text-gray-800 text-sm">${item.nama_kegiatan}</p><p class="text-xs text-gray-500">${item['tanggal mulai']} - ${item.tanggal_selesai}</p></div></li>`).join('');
                lucide.createIcons();
            }
        }
        function populateManpowerList(manpowerData) {
            const listContainer = document.getElementById('manpower-list'), searchInput = document.getElementById('manpower-search');
            if (!listContainer) return;
            const uniqueManpower = [...new Map(manpowerData.map(item => [item['NIK'], item])).values()];
            let filteredManpower = uniqueManpower;
            const renderList = () => { listContainer.innerHTML = filteredManpower.map(man => `<li class="px-3 py-2 text-sm text-gray-700 rounded-md cursor-pointer hover:bg-purple-100 hover:text-purple-700" data-nik="${man.NIK}">${man.NAMA}</li>`).join(''); };
            if (searchInput) searchInput.addEventListener('input', debounce((e) => { const searchTerm = e.target.value.toLowerCase(); filteredManpower = uniqueManpower.filter(man => man.NAMA.toLowerCase().includes(searchTerm) || man.NIK.toLowerCase().includes(searchTerm)); renderList(); }, 300));
            renderList();
        }
        function showManpowerDetails(nik, manpowerData) {
            const detailContainer = document.getElementById('manpower-detail'); if (!detailContainer) return;
            const competencies = manpowerData.filter(item => item.NIK === nik);
            if (competencies.length === 0) { detailContainer.innerHTML = `<p class="text-gray-500">Tidak ada data untuk NIK ${nik}.</p>`; return; }
            const man = competencies[0];
            detailContainer.innerHTML = `<h4 class="font-bold text-lg text-gray-800">${man.NAMA}</h4><p class="text-sm text-gray-500 mb-4">NIK: ${man.NIK} | ${man.JABATAN}</p><h5 class="font-semibold text-md text-gray-700 mt-4 mb-2">Daftar Kompetensi:</h5><div class="grid grid-cols-1 gap-2">${competencies.map(comp => `<div class="p-2 rounded-lg border ${comp.STATUS === 'VALID' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}"><p class="font-medium">${comp.KOMPETENSI}</p><p class="text-sm">${comp.STATUS}</p></div>`).join('')}</div>`;
        }
        function generateCalendar(year, month, trainingData) {
            const grid = document.getElementById('calendar-grid'), monthYearEl = document.getElementById('calendar-month-year');
            if (!grid || !monthYearEl) return;
            grid.innerHTML = '';
            const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
            monthYearEl.textContent = firstDay.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            const dayHeaders = ['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'];
            dayHeaders.forEach(day => { grid.innerHTML += `<div class="text-center font-semibold py-2 bg-gray-100 text-gray-600 text-sm">${day}</div>`; });
            for (let i = 0; i < firstDay.getDay(); i++) { grid.innerHTML += `<div class="bg-gray-50"></div>`; }
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const events = trainingData.filter(t => t['tanggal mulai'] === dateStr);
                const dayEl = document.createElement('div');
                dayEl.className = 'p-2 border-t border-gray-200 bg-white min-h-24';
                dayEl.innerHTML = `<span class="text-sm font-medium text-gray-800">${day}</span>`;
                if (events.length > 0) { events.forEach(event => { dayEl.innerHTML += `<p class="text-xs mt-1 bg-purple-100 text-purple-700 rounded px-1 truncate">${event.nama_kegiatan}</p>`; }); }
                grid.appendChild(dayEl);
            }
        }

        // ========== THEME & NAVIGATION ==========
        function setupTabs(tabContainerId) {
            const tabContainer = document.getElementById(tabContainerId); if (!tabContainer) return;
            const tabLinks = tabContainer.querySelectorAll('.tab-link'), tabContents = tabContainer.closest('.bg-white').querySelectorAll('.tab-content');
            tabLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const tabId = link.dataset.tab;
                    tabLinks.forEach(l => { l.classList.remove('border-purple-500', 'text-purple-600'); l.classList.add('border-transparent', 'text-gray-500'); });
                    link.classList.add('border-purple-500', 'text-purple-600'); link.classList.remove('border-transparent', 'text-gray-500');
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId + '-content')?.classList.add('active');
                });
            });
        }
        function toggleTheme() {
            appState.currentTheme = appState.currentTheme === "light" ? "dark" : "light";
            document.body.classList.remove("theme-light", "theme-dark");
            document.body.classList.add(`theme-${appState.currentTheme}`);
            localStorage.setItem("theme", appState.currentTheme);
            const themeToggleButton = document.getElementById("theme-toggle");
            if (themeToggleButton) {
                const newIconName = appState.currentTheme === "light" ? "moon" : "sun";
                themeToggleButton.innerHTML = `<i data-lucide="${newIconName}" class="w-5 h-5 text-gray-600"></i>`;
            }
            lucide.createIcons();
            initializeCharts();
            updateUI(appState.data);
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            setupTabs('pelatihan-tabs');
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('refresh-button').addEventListener('click', forceRefreshData);
            document.getElementById('manpower-list')?.addEventListener('click', (e) => { if (e.target?.matches('li')) { showManpowerDetails(e.target.dataset.nik, appState.data.kompetensiManpower); document.querySelectorAll('#manpower-list li').forEach(li => li.classList.remove('bg-purple-200')); e.target.classList.add('bg-purple-200'); } });
            document.getElementById('prev-month')?.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth(), appState.data.jadwalTraining); });
            document.getElementById('next-month')?.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth(), appState.data.jadwalTraining); });
        }

        async function forceRefreshData() {
            const refreshButton = document.getElementById('refresh-button');
            // FIXED: Check if refreshButton exists before using it
            if (!refreshButton) return;
            const icon = refreshButton.firstElementChild;

            if (icon) {
                icon.classList.add('animate-spin');
            }
            refreshButton.disabled = true;

            updateLastUpdatedTimestamp(null);

            const freshData = await fetchAllTrainingData();

            if (freshData) {
                console.log("Forced refresh successful. Updating UI and cache.");
                updateUI(freshData);
                setCachedData(freshData);
            } else {
                console.log("Forced refresh failed to retrieve new data.");
            }

            if (icon) {
                icon.classList.remove('animate-spin');
            }
            refreshButton.disabled = false;
        }

        // ========== MAIN INITIALIZATION ==========
        async function initializePage() {
            const cached = getCachedData();

            if (cached) {
                console.log("All data loaded from cache. Rendering initial UI.");
                updateUI(cached.data);
                updateLastUpdatedTimestamp(cached.timestamp);
            }

            await forceRefreshData();
        }


        document.addEventListener('DOMContentLoaded', async function () {
            document.body.classList.add(`theme-${appState.currentTheme}`);
            const themeToggleButton = document.getElementById("theme-toggle");
            if (themeToggleButton) {
                const iconName = appState.currentTheme === 'light' ? 'moon' : 'sun';
                themeToggleButton.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5 text-gray-600"></i>`;
            }

            lucide.createIcons();
            initializeCharts();

            await initializePage();

            setupEventListeners();
        });
    </script>
</body>

</html>