<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="pageTitle">Training Dashboard - GAMITAS</title>

    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-light: #f0f4f8;
            --bg-dark: #1e293b;
            --text-light: #1f2937;
            --text-dark: #f1f5f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s ease, color 0.3s ease;
            background-image:
                radial-gradient(at 0% 0%, hsla(217, 89%, 70%, 0.2) 0px, transparent 50%),
                radial-gradient(at 98% 1%, hsla(283, 89%, 70%, 0.2) 0px, transparent 50%);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.6);
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .theme-dark .glass-panel {
            background: rgba(51, 65, 85, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Dark Theme Styles */
        .theme-dark {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .theme-dark .bg-white {
            background-color: #334155 !important;
        }

        .theme-dark .bg-gray-50,
        .theme-dark .bg-gray-100 {
            background-color: #475569 !important;
        }

        .theme-dark .text-gray-800,
        .theme-dark .text-gray-900 {
            color: #f1f5f9 !important;
        }

        .theme-dark .text-gray-700 {
            color: #e2e8f0 !important;
        }

        .theme-dark .text-gray-600 {
            color: #cbd5e1 !important;
        }

        .theme-dark .text-gray-500 {
            color: #94a3b8 !important;
        }

        .theme-dark .border-gray-200,
        .theme-dark .border-b,
        .theme-dark .border-t {
            border-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-100:hover {
            background-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-50:hover {
            background-color: #4b5a70 !important;
        }

        .theme-dark .shadow-md,
        .theme-dark .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }

        .theme-dark input,
        .theme-dark select {
            background-color: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        .theme-dark input::placeholder {
            color: #94a3b8;
        }

        .theme-dark .sidebar-link.active {
            background-color: #5b21b6;
            color: white;
        }

        .theme-dark .tab-link.active {
            color: #a78bfa !important;
            border-color: #a78bfa !important;
        }

        .theme-dark .pagination button.active {
            background-color: #a78bfa;
            color: #1e293b;
            border-color: #a78bfa;
        }

        .sidebar-link.active {
            background-color: #f3e8ff;
            color: #9333ea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .component-loading {
            position: relative;
            min-height: 100px;
            overflow: hidden;
        }

        .component-loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            animation: shimmer 1.5s infinite;
        }

        .theme-dark .component-loading::after {
            background: linear-gradient(90deg, transparent, rgba(100, 116, 139, 0.5), transparent);
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .table-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .pagination {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            border: 1px solid #e2e8f0;
            background-color: white;
            cursor: pointer;
        }

        .pagination button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .pagination button.active {
            background-color: #9333ea;
            color: white;
            border-color: #9333ea;
        }

        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        th.sortable:hover {
            background-color: #f9fafb;
        }

        .theme-dark th.sortable:hover {
            background-color: #4b5a70;
        }

        th.sortable::after {
            content: '↕';
            position: absolute;
            right: 0.5rem;
            opacity: 0.5;
        }

        th.sortable.sort-asc::after {
            content: '↑';
            opacity: 1;
        }

        th.sortable.sort-desc::after {
            content: '↓';
            opacity: 1;
        }

        /* Matrix Table Styles */
        .matrix-table-container {
            width: 100%;
            overflow-x: auto;
        }

        .matrix-table {
            border-collapse: collapse;
            width: 100%;
            font-size: 0.8rem;
        }

        .matrix-table th,
        .matrix-table td {
            border: 1px solid #e2e8f0;
            padding: 0.5rem;
            text-align: left;
            white-space: nowrap;
        }

        .theme-dark .matrix-table th,
        .theme-dark .matrix-table td {
            border-color: #475569;
        }

        .matrix-table th {
            background-color: #f8fafc;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .theme-dark .matrix-table th {
            background-color: #334155;
        }

        .matrix-table .th-vertical {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            text-align: left;
            padding: 0.75rem 0.25rem;
            min-width: 30px;
        }

        .matrix-table .sticky-col {
            position: sticky;
            left: 0;
            background-color: #f8fafc;
            z-index: 5;
        }

        .theme-dark .matrix-table .sticky-col {
            background-color: #334155;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background-color: var(--bg-light);
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-container {
            transform: scale(1);
        }

        .theme-dark .modal-container {
            background-color: var(--bg-dark);
        }

        @media (max-width: 768px) {
            main {
                margin-left: 0 !important;
            }

            #sidebar {
                transform: translateX(-100%);
            }

            #sidebar.show {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body class="theme-light">

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-50 transition-transform flex flex-col">
        <div class="p-6 border-b">
            <h1 id="company-name-sidebar" class="text-2xl font-bold text-gray-800">
                <span class="text-purple-600">G</span>AMITAS
            </h1>
            <p class="text-xs text-gray-500">Integrated Safety System</p>
        </div>
        <nav class="mt-4 flex-1 overflow-y-auto">
            <ul class="space-y-1 px-4">
                <li>
                    <a href="./index.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="dashboard">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        <span data-translate-key="sidebar_dashboard">Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="./induksi.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="induksi">
                        <i data-lucide="user-check" class="w-5 h-5"></i>
                        <span data-translate-key="sidebar_induksi">Induction</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg"
                        data-page="pelatihan">
                        <i data-lucide="award" class="w-5 h-5"></i>
                        <span data-translate-key="sidebar_pelatihan">Internal Training</span>
                    </a>
                </li>
                <li>
                    <a href="./laporan_insiden.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="laporan_insiden">
                        <i data-lucide="file-warning" class="w-5 h-5"></i>
                        <span data-translate-key="sidebar_laporan_insiden">Incident Report</span>
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="observasi">
                        <i data-lucide="search-check" class="w-5 h-5"></i>
                        <span data-translate-key="sidebar_laporan_observasi">Observation Report</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="p-4 border-t">
            <a href="./index.html"
                class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span data-translate-key="sidebar_logout">Logout</span>
            </a>
        </div>
    </aside>

    <!-- Mobile Menu Toggle -->
    <button id="mobile-menu-toggle" class="fixed top-4 left-4 z-[60] p-2 rounded-lg bg-white shadow-md md:hidden">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <main class="md:ml-64 p-4 sm:p-6 lg:p-8">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-3xl font-bold text-gray-800" data-translate-key="headerTitle">Training Dashboard</h2>
                <p id="last-updated" class="text-xs text-gray-500" data-translate-key="loadingData">Loading data...</p>
            </div>
            <div class="flex items-center space-x-2">
                <button id="refresh-button" class="p-2 rounded-full hover:bg-gray-100" title="Reload Data"
                    data-translate-title-key="refreshButtonTitle">
                    <i data-lucide="refresh-cw" class="w-5 h-5 text-gray-600"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100" title="Change Theme"
                    data-translate-title-key="themeButtonTitle">
                    <i data-lucide="sun" class="w-5 h-5 text-gray-600"></i>
                </button>
                <div class="relative">
                    <select id="language-switcher" class="p-2 rounded-md border border-gray-300 bg-white text-gray-700">
                        <option value="en" selected>English</option>
                        <option value="id">Indonesia</option>
                        <option value="ko">한국어</option>
                    </select>
                </div>
            </div>
        </header>

        <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
            <p class="font-bold" data-translate-key="errorBannerTitle">Failed to Load Data</p>
            <p id="error-message-content">An error occurred.</p>
        </div>

        <div id="pelatihan-page" class="page-content active">
            <div class="glass-panel p-6 rounded-xl shadow-md">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" id="pelatihan-tabs">
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-purple-500 px-1 pb-4 text-sm font-medium text-purple-600"
                            data-tab="dashboard-pelatihan" data-translate-key="tabDashboard">Training Dashboard</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="pelatihan-manpower" data-translate-key="tabManpower">Manpower Training</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="competency-lx" data-translate-key="tabCompetencyLX">Competency LX List</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="matrix-kompetensi" data-translate-key="tabCompetencyMatrix">Competency Matrix</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="jadwal-pelatihan" data-translate-key="tabSchedule">Training Schedule</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="atmp" data-translate-key="tabATMP">ATMP</a>
                    </nav>
                </div>
                <div class="mt-6">
                    <div id="dashboard-pelatihan-content" class="tab-content active">
                        <div class="space-y-6">
                            <div id="pelatihan-stats-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
                                <div class="bg-white p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-gray-500" data-translate-key="cardTotalCompetencies">Total
                                        Registered Competencies</p>
                                    <p class="text-3xl font-bold text-gray-800">-</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-gray-500" data-translate-key="cardTotalManpower">Total
                                        Trained Manpower</p>
                                    <p class="text-3xl font-bold text-gray-800">-</p>
                                </div>
                                <div class="bg-white p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-gray-500" data-translate-key="cardTrainingNeeds">Total
                                        Training Needs</p>
                                    <p class="text-3xl font-bold text-gray-800">-</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 bg-white p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="chartTitleDistribution">POP, POM, POU Competency
                                        Distribution Graph</h3>
                                    <div class="h-64"><canvas id="kompetensiChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="chartTitleProgress">Overall Training Progress
                                    </h3>
                                    <div class="h-64 flex items-center justify-center"><canvas
                                            id="progressPelatihanChart"></canvas></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div class="lg:col-span-2 bg-white p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="chartTitleTopNeeds">Top 5 Most Needed Trainings</h3>
                                    <div class="h-64"><canvas id="topPelatihanChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="cardUpcomingSchedule">Upcoming Schedule</h3>
                                    <ul id="jadwal-mendatang-list" class="space-y-4"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="pelatihan-manpower-content" class="tab-content">
                        <h3 class="text-lg font-semibold mb-4" data-translate-key="manpowerDetailTitle">Manpower
                            Competency Details</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="md:col-span-1">
                                <div class="mb-4"><input type="text" id="manpower-search"
                                        placeholder="Search manpower name..."
                                        data-translate-placeholder-key="manpowerSearchPlaceholder"
                                        class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                </div>
                                <div class="max-h-96 overflow-y-auto bg-gray-50 p-2 rounded-lg border">
                                    <ul id="manpower-list" class="space-y-1"></ul>
                                </div>
                            </div>
                            <div id="manpower-detail-placeholder"
                                class="md:col-span-2 p-4 border rounded-lg bg-white flex items-center justify-center">
                                <p class="text-gray-500" data-translate-key="manpowerDetailPlaceholder">Select a name
                                    from the list to see competency details.</p>
                            </div>
                        </div>
                    </div>
                    <div id="competency-lx-content" class="tab-content">
                        <h3 class="text-lg font-semibold mb-4" data-translate-key="competencyLXTitle">Competency LX List
                        </h3>
                        <div class="table-controls">
                            <input type="text" id="competency-lx-search" placeholder="Search in table..."
                                data-translate-placeholder-key="tableSearchPlaceholder"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <select id="competency-lx-per-page"
                                class="px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="10">10 per page</option>
                                <option value="25">25 per page</option>
                                <option value="50" selected>50 per page</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase border-b">
                                        <th class="py-3 px-4 sortable" data-column="competency"
                                            data-translate-key="tableHeaderCompetency">Competency</th>
                                        <th class="py-3 px-4 sortable" data-column="competencyCode"
                                            data-translate-key="tableHeaderCode">Code</th>
                                        <th class="py-3 px-4 sortable" data-column="jenisCompetency"
                                            data-translate-key="tableHeaderType">Type</th>
                                        <th class="py-3 px-4 sortable" data-column="kelompokCompetency"
                                            data-translate-key="tableHeaderGroup">Group</th>
                                        <th class="py-3 px-4 sortable" data-column="peraturan"
                                            data-translate-key="tableHeaderRegulation">Regulation</th>
                                    </tr>
                                </thead>
                                <tbody id="competency-lx-table-body" class="text-sm text-gray-700"></tbody>
                            </table>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-between items-center mt-4">
                            <div id="competency-lx-summary" class="text-sm text-gray-500 mb-2 sm:mb-0"></div>
                            <div id="competency-lx-pagination" class="pagination"></div>
                        </div>
                    </div>
                    <div id="matrix-kompetensi-content" class="tab-content">
                        <h3 class="text-lg font-semibold mb-4" data-translate-key="matrixTitle">Job Competency Matrix
                        </h3>
                        <div class="bg-gray-50 p-4 rounded-lg mb-4">
                            <div class="flex flex-wrap items-center gap-4">
                                <select id="matrix-dept-filter" class="w-full md:w-auto p-2 border rounded-md"></select>
                                <select id="matrix-section-filter"
                                    class="w-full md:w-auto p-2 border rounded-md"></select>
                                <select id="matrix-jabatan-filter"
                                    class="w-full md:w-auto p-2 border rounded-md"></select>
                                <div class="flex flex-wrap gap-x-4 gap-y-2 items-center text-xs ml-auto">
                                    <span
                                        class="inline-flex items-center gap-x-1.5 py-1.5 px-3 rounded-full font-medium bg-green-100 text-green-800">N2:
                                        Sufficiently Needed</span>
                                    <span
                                        class="inline-flex items-center gap-x-1.5 py-1.5 px-3 rounded-full font-medium bg-blue-100 text-blue-800">N3:
                                        Independently Capable</span>
                                    <span
                                        class="inline-flex items-center gap-x-1.5 py-1.5 px-3 rounded-full font-medium bg-orange-100 text-orange-800">N4:
                                        Needs Supervision</span>
                                    <span
                                        class="inline-flex items-center gap-x-1.5 py-1.5 px-3 rounded-full font-medium bg-red-100 text-red-800">N5:
                                        Critically Needed</span>
                                </div>
                            </div>
                        </div>
                        <div class="matrix-table-container">
                            <table id="matrix-table" class="matrix-table">
                                <thead></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="jadwal-pelatihan-content" class="tab-content">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <h3 class="text-lg font-semibold" data-translate-key="scheduleTitle">Training Schedule -
                                <span id="calendar-month-year"></span>
                            </h3>
                            <div><button id="prev-month" class="p-2 rounded-md hover:bg-gray-100"><i
                                        data-lucide="chevron-left" class="pointer-events-none"></i></button><button
                                    id="next-month" class="p-2 rounded-md hover:bg-gray-100"><i
                                        data-lucide="chevron-right" class="pointer-events-none"></i></button></div>
                        </div>
                        <div id="calendar-grid"
                            class="grid grid-cols-7 gap-px bg-gray-200 border border-gray-200 rounded-lg overflow-hidden">
                        </div>
                    </div>
                    <div id="atmp-content" class="tab-content">
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0"><i data-lucide="calendar"
                                        class="h-5 w-5 text-yellow-400"></i></div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700"><strong data-translate-key="atmpTitle">Annual
                                            Training Master Plan
                                            (ATMP)</strong> - <span data-translate-key="atmpDescription">This feature is
                                            under development. The ATMP will display a comprehensive annual training
                                            plan for all employees.</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Password Modal -->
    <div id="password-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[101] p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h4 class="font-bold text-lg" data-translate-key="passwordModalTitle">Restricted Access</h4>
                <button class="modal-close-btn text-gray-500 hover:text-gray-800 p-2 rounded-full"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <p class="text-sm text-gray-600 mb-4" data-translate-key="passwordModalPrompt">Please enter the password to
                access this page.</p>
            <form id="password-form">
                <div>
                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1"
                        data-translate-key="passwordModalLabel">Password</label>
                    <input type="password" id="password-input"
                        class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                    <p id="password-error" class="text-red-500 text-sm mt-1 hidden"
                        data-translate-key="passwordModalError">Incorrect password!</p>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit"
                        class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700"
                        data-translate-key="passwordModalUnlock">Unlock</button>
                    <button type="button"
                        class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 modal-close-btn"
                        data-translate-key="passwordModalCancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL CONTAINER -->
    <div id="detail-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h2 id="modal-title" class="text-xl font-bold" data-translate-key="modalDetailTitle">Detail</h2>
                <button id="modal-close-button" class="p-2 rounded-full hover:bg-gray-200">
                    <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                </button>
            </div>
            <div id="modal-content" class="space-y-4"></div>
        </div>
    </div>


    <script>
        // ========== GLOBAL STATE & UTILITIES ==========
        const appState = {
            data: {},
            currentTheme: localStorage.getItem('theme') || 'light',
            currentLang: localStorage.getItem('language') || 'en',
            cache: {
                key: 'pelatihan_data_cache_v2',
                expiry: 30 * 60 * 1000 // 30 minutes
            },
            tables: {}, // Object to hold all table managers
            lastUpdated: null,
            targetPage: null,
            targetUrl: null,
            translations: {}
        };
        const debounce = (func, wait) => { let timeout; return function executedFunction(...args) { const later = () => { clearTimeout(timeout); func(...args); }; clearTimeout(timeout); timeout = setTimeout(later, wait); }; };

        const API_PELATIHAN_URL = 'https://script.google.com/macros/s/AKfycbyJcIIUFiW7IKAX4FJN__eOvFMU6PE508Q465NZ-O0qwc0CGunG7SQui3X2P9K1XJAsuQ/exec';


        function showErrorBanner(message) {
            const banner = document.getElementById('error-banner');
            const messageContent = document.getElementById('error-message-content');
            if (banner && messageContent) {
                messageContent.innerHTML = message;
                banner.classList.remove('hidden');
            }
        }

        function updateLastUpdatedTimestamp(timestamp) {
            const el = document.getElementById('last-updated');
            if (!el) return;
            if (timestamp) {
                appState.lastUpdated = timestamp;
                const date = new Date(timestamp);
                const translatedText = appState.translations[appState.currentLang]?.lastUpdatedText || "Last updated:";
                el.textContent = `${translatedText} ${date.toLocaleDateString(appState.currentLang === 'id' ? 'id-ID' : 'en-US')} ${date.toLocaleTimeString(appState.currentLang === 'id' ? 'id-ID' : 'en-US')}`;
            } else {
                el.textContent = appState.translations[appState.currentLang]?.loadingData || 'Loading data...';
            }
        }

        // ========== CACHING FUNCTIONS ==========
        function getCachedData() {
            const cachedItem = localStorage.getItem(appState.cache.key);
            if (!cachedItem) return null;
            try {
                const { data, timestamp } = JSON.parse(cachedItem);
                if (Date.now() - timestamp > appState.cache.expiry) {
                    localStorage.removeItem(appState.cache.key);
                    return null;
                }
                console.log(`Loading all training data from cache.`);
                return { data, timestamp };
            } catch (error) {
                localStorage.removeItem(appState.cache.key);
                return null;
            }
        }

        function setCachedData(data) {
            const timestamp = Date.now();
            const itemToCache = { data, timestamp };
            try {
                localStorage.setItem(appState.cache.key, JSON.stringify(itemToCache));
                console.log(`Saved all training data to cache.`);
                updateLastUpdatedTimestamp(timestamp);
            } catch (error) {
                console.error(`Error saving cache:`, error);
            }
        }

        // ========== DATA FETCHING (JSONP METHOD) ==========
        function fetchAllTrainingData() {
            return new Promise((resolve, reject) => {
                const callbackName = 'jsonp_callback_pelatihan_' + Math.round(100000 * Math.random());

                window[callbackName] = function (data) {
                    delete window[callbackName];
                    document.body.removeChild(script);

                    if (data.error) {
                        return reject(new Error(`API Error: ${data.error}. Details: ${data.details || ''}`));
                    }

                    const formattedData = {
                        monitoringInternal: data.monitoringInternal || [],
                        jadwalTraining: data.jadwalTraining || [],
                        kompetensiManpower: data.kompetensiManpower || [],
                        competencyLx: data.competencyLx || [],
                        internalMatrix: data.internalMatrix || []
                    };
                    resolve(formattedData);
                };

                const script = document.createElement('script');
                script.src = `${API_PELATIHAN_URL}?callback=${callbackName}`;

                script.onerror = function () {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    const error = new Error('Data request failed. The server is not responding or a network error occurred.');
                    showErrorBanner(`Failed to retrieve data from the server. The data displayed may be outdated. Please check your internet connection and try again.`);
                    reject(error);
                };

                document.body.appendChild(script);
            });
        }

        function stringToHslColor(str, s = 70, l = 85) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const h = hash % 360;
            return `hsl(${h}, ${s}%, ${l}%)`;
        }

        // ========== TABLE MANAGER CLASS ==========
        class TableManager {
            constructor(tableId, data, headers, options = {}) {
                this.tableId = tableId;
                this.originalData = [...data];
                this.headers = headers;
                this.currentPage = 1;
                this.itemsPerPage = parseInt(options.itemsPerPage || 50);
                this.sortColumn = null;
                this.sortDirection = 'asc';
                this.searchTerm = '';
                this.dateColumn = options.dateColumn;

                if (this.dateColumn) {
                    this.originalData.sort((a, b) => new Date(b[this.dateColumn] || 0) - new Date(a[this.dateColumn] || 0));
                }
                this.filteredData = [...this.originalData];
                this.init();
            }
            init() { this.setupControls(); this.render(); }
            setupControls() {
                const searchInput = document.getElementById(this.tableId.replace('-table-body', '-search'));
                if (searchInput) searchInput.addEventListener('input', debounce((e) => { this.searchTerm = e.target.value.toLowerCase(); this.applyFilters(); }, 300));

                const perPageSelect = document.getElementById(this.tableId.replace('-table-body', '-per-page'));
                if (perPageSelect) perPageSelect.addEventListener('change', (e) => { this.itemsPerPage = parseInt(e.target.value); this.currentPage = 1; this.render(); });

                const table = document.getElementById(this.tableId).closest('table');
                table.querySelectorAll('th.sortable').forEach(header => { header.addEventListener('click', () => { const column = header.dataset.column; if (this.sortColumn === column) { this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc'; } else { this.sortColumn = column; this.sortDirection = 'asc'; } this.updateSortIcons(header); this.applySort(); }); });
            }
            updateSortIcons(activeHeader) {
                const table = document.getElementById(this.tableId).closest('table');
                table.querySelectorAll('th.sortable').forEach(header => { header.classList.remove('sort-asc', 'sort-desc'); });
                activeHeader.classList.add(this.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            }
            applyFilters() {
                this.filteredData = this.originalData.filter(item => {
                    return !this.searchTerm || Object.values(item).some(value => String(value).toLowerCase().includes(this.searchTerm));
                });
                this.currentPage = 1;
                this.applySort();
            }
            applySort() {
                if (this.sortColumn) {
                    this.filteredData.sort((a, b) => {
                        let aVal = a[this.sortColumn] || '', bVal = b[this.sortColumn] || '';
                        if (this.sortDirection === 'asc') return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                        else return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                    });
                }
                this.render();
            }
            render() { this.renderTable(); this.renderPagination(); }
            renderTable() {
                const tbody = document.getElementById(this.tableId);
                const start = (this.currentPage - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                const pageData = this.filteredData.slice(start, end);
                if (pageData.length === 0) { tbody.innerHTML = `<tr><td colspan="${this.headers.length}" class="text-center py-4 text-gray-500">No data available.</td></tr>`; return; }

                tbody.innerHTML = pageData.map(row => {
                    const cells = this.headers.map(header => {
                        const value = row[header] || '-';
                        if (this.tableId === 'competency-lx-table-body' && ['jenisCompetency', 'kelompokCompetency', 'peraturan'].includes(header) && value !== '-') {
                            const bgColor = stringToHslColor(value);
                            return `<td class="py-3 px-4"><span class="px-2 py-1 text-xs font-medium rounded-full text-gray-800" style="background-color: ${bgColor};">${value}</span></td>`;
                        }
                        return `<td class="py-3 px-4">${value}</td>`;
                    }).join('');
                    return `<tr class="border-b hover:bg-gray-50">${cells}</tr>`;
                }).join('');
            }
            renderPagination() {
                const paginationId = this.tableId.replace('-table-body', '-pagination');
                const paginationContainer = document.getElementById(paginationId);
                const summaryId = this.tableId.replace('-table-body', '-summary');
                const summaryContainer = document.getElementById(summaryId);
                if (!paginationContainer) return;

                const totalEntries = this.filteredData.length;
                const totalPages = Math.ceil(totalEntries / this.itemsPerPage);
                const start = (this.currentPage - 1) * this.itemsPerPage;
                const startEntry = totalEntries > 0 ? start + 1 : 0;
                const endEntry = Math.min(start + this.itemsPerPage, totalEntries);

                if (summaryContainer) {
                    summaryContainer.textContent = totalEntries > 0 ? `Showing ${startEntry} to ${endEntry} of ${totalEntries} entries` : 'No data';
                }
                if (totalPages <= 1) { paginationContainer.innerHTML = ''; return; }
                let html = `<button class="pagination-btn" ${this.currentPage === 1 ? 'disabled' : ''} data-page="${this.currentPage - 1}">‹</button>`;
                for (let i = 1; i <= totalPages; i++) { html += `<button class="pagination-btn ${i === this.currentPage ? 'active' : ''}" data-page="${i}">${i}</button>`; }
                html += `<button class="pagination-btn" ${this.currentPage === totalPages ? 'disabled' : ''} data-page="${this.currentPage + 1}">›</button>`;
                paginationContainer.innerHTML = html;
                paginationContainer.addEventListener('click', (e) => { if (e.target.classList.contains('pagination-btn') && !e.target.disabled) { this.currentPage = parseInt(e.target.dataset.page); this.render(); } });
            }
        }

        // ========== CHART MANAGEMENT ==========
        const chartInstances = {};
        let currentDate = new Date();
        function initializeCharts() {
            const defaultChartOptions = (extraOptions = {}) => ({ responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: appState.currentTheme === 'dark' ? '#f1f5f9' : '#1f2937' } } }, scales: { x: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.2)' } }, y: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.2)' } } }, ...extraOptions });
            const createChart = (id, type, options) => { const ctx = document.getElementById(id)?.getContext("2d"); if (ctx) { if (chartInstances[id]) chartInstances[id].destroy(); chartInstances[id] = new Chart(ctx, { type, data: { labels: [], datasets: [] }, options }); } };
            createChart('kompetensiChart', 'bar', defaultChartOptions({ plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }));
            createChart('progressPelatihanChart', 'doughnut', defaultChartOptions({ plugins: { legend: { position: 'bottom' } } }));
            createChart('topPelatihanChart', 'bar', defaultChartOptions({ indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true } } }));
        }

        // ========== UI UPDATE FUNCTIONS ==========
        function updateUI(data) {
            if (!data) { console.warn("Update UI skipped due to incomplete data."); return; };
            appState.data = data;
            updatePelatihanDashboard(data);
            populateManpowerList(data.kompetensiManpower);
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth(), data.jadwalTraining);

            appState.tables['competencyLx'] = new TableManager('competency-lx-table-body', data.competencyLx || [],
                ['competency', 'competencyCode', 'jenisCompetency', 'kelompokCompetency', 'peraturan']
            );

            initializeMatrix(data.internalMatrix || []);

            document.querySelectorAll('.component-loading').forEach(el => el.classList.remove('component-loading'));
        }

        function updatePelatihanDashboard(data) {
            const cards = document.querySelector('#pelatihan-stats-cards');
            const totalKompetensi = new Set(data.kompetensiManpower.map(item => item.kompetensi)).size;
            const totalManpower = new Set(data.kompetensiManpower.map(item => item.nik)).size;
            const totalKebutuhan = data.monitoringInternal.reduce((sum, item) => sum + (parseInt(item.needTraining) || 0), 0);
            cards.children[0].querySelector('p.text-3xl').textContent = totalKompetensi;
            cards.children[1].querySelector('p.text-3xl').textContent = totalManpower;
            cards.children[2].querySelector('p.text-3xl').textContent = totalKebutuhan;
            const kompetensiCounts = data.kompetensiManpower.reduce((acc, item) => { const komp = item.kompetensi || ""; if (komp.includes('POP')) acc.pop++; if (komp.includes('POM')) acc.pom++; if (komp.includes('POU')) acc.pou++; return acc; }, { pop: 0, pom: 0, pou: 0 });
            if (chartInstances.kompetensiChart) { chartInstances.kompetensiChart.data = { labels: ['POP', 'POM', 'POU'], datasets: [{ label: 'Number of Competencies', data: [kompetensiCounts.pop, kompetensiCounts.pom, kompetensiCounts.pou], backgroundColor: ['#8b5cf6', '#06b6d4', '#10b981'] }] }; chartInstances.kompetensiChart.update(); }
            const totalDone = data.monitoringInternal.reduce((sum, item) => sum + (parseInt(item.done) || 0), 0);
            if (chartInstances.progressPelatihanChart) { chartInstances.progressPelatihanChart.data = { labels: ['Completed', 'Pending'], datasets: [{ data: [totalDone, totalKebutuhan > totalDone ? totalKebutuhan - totalDone : 0], backgroundColor: ['#10b981', '#e5e7eb'], borderWidth: 0 }] }; chartInstances.progressPelatihanChart.update(); }
            const top5 = data.monitoringInternal.filter(item => item.needTraining).sort((a, b) => parseInt(b.needTraining) - parseInt(a.needTraining)).slice(0, 5);
            if (chartInstances.topPelatihanChart) { chartInstances.topPelatihanChart.data = { labels: top5.map(item => item.internalTraining), datasets: [{ label: 'Needs', data: top5.map(item => parseInt(item.needTraining)), backgroundColor: '#8b5cf6' }] }; chartInstances.topPelatihanChart.update(); }
            const jadwalList = document.getElementById('jadwal-mendatang-list');
            if (jadwalList) { jadwalList.innerHTML = data.jadwalTraining.slice(0, 3).map(item => `<li class="flex items-center space-x-3"><div class="bg-purple-100 p-2 rounded-lg"><i data-lucide="calendar" class="w-5 h-5 text-purple-600"></i></div><div><p class="font-semibold text-gray-800 text-sm">${item.namaKegiatan}</p><p class="text-xs text-gray-500">${item.tanggalMulai} - ${item.tanggalSelesai}</p></div></li>`).join(''); lucide.createIcons(); }
        }
        function populateManpowerList(manpowerData) {
            const listContainer = document.getElementById('manpower-list'), searchInput = document.getElementById('manpower-search');
            if (!listContainer) return;
            const uniqueManpower = [...new Map(manpowerData.map(item => [item.nik, item])).values()];
            let filteredManpower = uniqueManpower;
            const renderList = () => { listContainer.innerHTML = filteredManpower.map(man => `<li class="px-3 py-2 text-sm text-gray-700 rounded-md cursor-pointer hover:bg-purple-100 hover:text-purple-700" data-nik="${man.nik}">${man.nama}</li>`).join(''); };
            if (searchInput) searchInput.addEventListener('input', debounce((e) => { const searchTerm = e.target.value.toLowerCase(); filteredManpower = uniqueManpower.filter(man => man.nama.toLowerCase().includes(searchTerm) || man.nik.toLowerCase().includes(searchTerm)); renderList(); }, 300));
            renderList();
        }
        function showManpowerDetails(nik, manpowerData) {
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');

            const competencies = manpowerData.filter(item => item.nik === nik);
            if (competencies.length === 0) return;
            const man = competencies[0];

            modalTitle.textContent = `Competency Details: ${man.nama}`;
            modalContent.innerHTML = `
                <p class="text-sm text-gray-500 mb-4">NIK: ${man.nik} | ${man.jabatan}</p>
                <h5 class="font-semibold text-md text-gray-700 mt-4 mb-2">Competency List:</h5>
                <div class="grid grid-cols-1 gap-2">
                    ${competencies.map(comp => `
                        <div class="p-2 rounded-lg border ${comp.status === 'VALID' ? 'bg-green-100 text-green-800' : 'bg-orange-100 text-orange-800'}">
                            <p class="font-medium">${comp.kompetensi}</p>
                            <p class="text-sm">${comp.status}</p>
                        </div>
                    `).join('')}
                </div>`;
            document.getElementById('detail-modal').classList.add('active');
        }
        function generateCalendar(year, month, trainingData) {
            const grid = document.getElementById('calendar-grid'), monthYearEl = document.getElementById('calendar-month-year');
            if (!grid || !monthYearEl) return;
            grid.innerHTML = '';
            const firstDay = new Date(year, month, 1), lastDay = new Date(year, month + 1, 0);
            monthYearEl.textContent = firstDay.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => { grid.innerHTML += `<div class="text-center font-semibold py-2 bg-gray-100 text-gray-600 text-sm">${day}</div>`; });
            for (let i = 0; i < firstDay.getDay(); i++) { grid.innerHTML += `<div class="bg-gray-50"></div>`; }
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const events = trainingData.filter(t => t.tanggalMulai === dateStr);
                const dayEl = document.createElement('div');
                dayEl.className = 'p-2 border-t border-gray-200 bg-white min-h-24';
                dayEl.innerHTML = `<span class="text-sm font-medium text-gray-800">${day}</span>`;
                if (events.length > 0) { events.forEach(event => { dayEl.innerHTML += `<p class="text-xs mt-1 bg-purple-100 text-purple-700 rounded px-1 truncate">${event.namaKegiatan}</p>`; }); }
                grid.appendChild(dayEl);
            }
        }

        function initializeMatrix(matrixData) {
            const deptFilter = document.getElementById('matrix-dept-filter');
            const sectionFilter = document.getElementById('matrix-section-filter');
            const jabatanFilter = document.getElementById('matrix-jabatan-filter');
            const tableHead = document.querySelector('#matrix-table thead');
            const tableBody = document.querySelector('#matrix-table tbody');

            if (!matrixData.length) return;

            const competencyHeaders = Object.keys(matrixData[0]).filter(key => !['departement', 'section', 'jabatan'].includes(key));

            const populateFilter = (element, data, key) => {
                const options = ['All', ...new Set(data.map(item => item[key]))];
                element.innerHTML = options.map(opt => `<option value="${opt}">${opt}</option>`).join('');
            };

            populateFilter(deptFilter, matrixData, 'departement');
            populateFilter(sectionFilter, matrixData, 'section');
            populateFilter(jabatanFilter, matrixData, 'jabatan');

            const renderMatrix = () => {
                const selectedDept = deptFilter.value;
                const selectedSection = sectionFilter.value;
                const selectedJabatan = jabatanFilter.value;

                const filteredData = matrixData.filter(row =>
                    (selectedDept === 'All' || row.departement === selectedDept) &&
                    (selectedSection === 'All' || row.section === selectedSection) &&
                    (selectedJabatan === 'All' || row.jabatan === selectedJabatan)
                );

                let headerHtml = '<tr><th class="sticky-col">Department</th><th class="sticky-col" style="left: 100px;">Section</th><th class="sticky-col" style="left: 200px;">Position</th>';
                headerHtml += competencyHeaders.map(h => `<th class="th-vertical">${h.replace(/([A-Z])/g, ' $1').trim()}</th>`).join('');
                headerHtml += '</tr>';
                tableHead.innerHTML = headerHtml;

                tableBody.innerHTML = filteredData.map(row => {
                    let rowHtml = `<tr><td class="sticky-col">${row.departement}</td><td class="sticky-col" style="left: 100px;">${row.section}</td><td class="sticky-col" style="left: 200px;">${row.jabatan}</td>`;
                    rowHtml += competencyHeaders.map(h => {
                        const level = row[h];
                        let cellContent = '';
                        if (level) {
                            let bgColor, textColor, icon, label;
                            switch (level) {
                                case 'N2':
                                    bgColor = 'bg-green-100'; textColor = 'text-green-800'; label = 'Sufficiently Needed';
                                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
                                    break;
                                case 'N3':
                                    bgColor = 'bg-blue-100'; textColor = 'text-blue-800'; label = 'Independently Capable';
                                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
                                    break;
                                case 'N4':
                                    bgColor = 'bg-orange-100'; textColor = 'text-orange-800'; label = 'Needs Supervision';
                                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`;
                                    break;
                                case 'N5':
                                    bgColor = 'bg-red-100'; textColor = 'text-red-800'; label = 'Critically Needed';
                                    icon = `<svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline-block mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>`;
                                    break;
                                default:
                                    bgColor = ''; textColor = 'text-gray-800'; icon = ''; label = level;
                            }
                            cellContent = `<span class="px-2 py-1 text-xs font-medium rounded-full inline-flex items-center ${bgColor} ${textColor}">${icon} ${label}</span>`;
                        }
                        return `<td class="text-center">${cellContent}</td>`;
                    }).join('');
                    rowHtml += '</tr>';
                    return rowHtml;
                }).join('');
            };

            [deptFilter, sectionFilter, jabatanFilter].forEach(el => el.addEventListener('change', renderMatrix));
            renderMatrix();
        }


        // ========== THEME & NAVIGATION ==========
        function setupTabs(tabContainerId) {
            const tabContainer = document.getElementById(tabContainerId);
            if (!tabContainer) return;
            const tabLinks = tabContainer.querySelectorAll('.tab-link');
            const tabContents = tabContainer.closest('.glass-panel').querySelectorAll('.tab-content');
            tabLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const tabId = link.dataset.tab;
                    tabLinks.forEach(l => { l.classList.remove('border-purple-500', 'text-purple-600'); l.classList.add('border-transparent', 'text-gray-500'); });
                    link.classList.add('border-purple-500', 'text-purple-600'); link.classList.remove('border-transparent', 'text-gray-500');
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId + '-content')?.classList.add('active');
                });
            });
        }
        function toggleTheme() {
            appState.currentTheme = appState.currentTheme === "light" ? "dark" : "light";
            document.body.classList.remove("theme-light", "theme-dark");
            document.body.classList.add(`theme-${appState.currentTheme}`);
            localStorage.setItem("theme", appState.currentTheme);
            const themeToggleButton = document.getElementById("theme-toggle");
            if (themeToggleButton) {
                const newIconName = appState.currentTheme === "light" ? "moon" : "sun";
                themeToggleButton.innerHTML = `<i data-lucide="${newIconName}" class="w-5 h-5 text-gray-600"></i>`;
            }
            lucide.createIcons();
            initializeCharts();
            updateUI(appState.data);
        }

        // ========== PASSWORD PROTECTION ==========
        const CORRECT_PASSWORD = "gamitas2025";
        function requestPasswordAndSwitchPage(pageId, externalUrl = null) {
            if (sessionStorage.getItem('gamitas_access_granted') === 'true') {
                if (externalUrl) { window.open(externalUrl, '_self'); }
            } else {
                showPasswordModal(pageId, externalUrl);
            }
        }
        function showPasswordModal(pageId, externalUrl = null) {
            appState.targetPage = pageId;
            appState.targetUrl = externalUrl;
            const modal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            modal.classList.add('active');
            passwordInput.focus();
        }
        function handlePasswordSubmit(e) {
            e.preventDefault();
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');
            if (passwordInput.value === CORRECT_PASSWORD) {
                sessionStorage.setItem('gamitas_access_granted', 'true');
                document.getElementById('password-modal').classList.remove('active');
                if (appState.targetUrl) {
                    window.open(appState.targetUrl, '_self');
                }
                appState.targetPage = null;
                appState.targetUrl = null;
            } else {
                passwordError.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // ========== LANGUAGE FUNCTIONS ==========
        async function loadTranslations() {
            appState.translations = {
                en: {
                    pageTitle: "Training Dashboard - GAMITAS",
                    headerTitle: "GAMITAS - Training",
                    loadingData: "Loading data...",
                    lastUpdatedText: "Last updated:",
                    refreshButtonTitle: "Reload Data",
                    themeButtonTitle: "Change Theme",
                    errorBannerTitle: "Failed to Load Data",
                    sidebar_dashboard: "Dashboard",
                    sidebar_induksi: "Induction",
                    sidebar_pelatihan: "Internal Training",
                    sidebar_laporan_insiden: "Incident Report",
                    sidebar_laporan_observasi: "Observation Report",
                    sidebar_logout: "Logout",
                    tabDashboard: "Training Dashboard",
                    tabManpower: "Manpower Training",
                    tabCompetencyLX: "Competency LX List",
                    tabCompetencyMatrix: "Competency Matrix",
                    tabSchedule: "Training Schedule",
                    tabATMP: "ATMP",
                    cardTotalCompetencies: "Total Registered Competencies",
                    cardTotalManpower: "Total Trained Manpower",
                    cardTrainingNeeds: "Total Training Needs",
                    chartTitleDistribution: "POP, POM, POU Competency Distribution Graph",
                    chartTitleProgress: "Overall Training Progress",
                    chartLabelCompleted: "Completed",
                    chartLabelPending: "Pending",
                    chartTitleTopNeeds: "Top 5 Most Needed Trainings",
                    cardUpcomingSchedule: "Upcoming Schedule",
                    manpowerDetailTitle: "Manpower Competency Details",
                    manpowerSearchPlaceholder: "Search manpower name...",
                    manpowerDetailPlaceholder: "Select a name from the list to see competency details.",
                    competencyLXTitle: "Competency LX List",
                    tableSearchPlaceholder: "Search in table...",
                    itemsPerPage: "per page",
                    tableHeaderCompetency: "Competency",
                    tableHeaderCode: "Code",
                    tableHeaderType: "Type",
                    tableHeaderGroup: "Group",
                    tableHeaderRegulation: "Regulation",
                    matrixTitle: "Job Competency Matrix",
                    matrixFilterAll: "All",
                    scheduleTitle: "Training Schedule",
                    atmpTitle: "Annual Training Master Plan (ATMP)",
                    atmpDescription: "This feature is under development. The ATMP will display a comprehensive annual training plan for all employees.",
                    modalDetailTitle: "Detail",
                    passwordModalTitle: "Restricted Access",
                    passwordModalPrompt: "Please enter the password to access this page.",
                    passwordModalLabel: "Password",
                    passwordModalError: "Incorrect password!",
                    passwordModalUnlock: "Unlock",
                    passwordModalCancel: "Cancel",
                },
                id: {
                    pageTitle: "Dasbor Pelatihan - GAMITAS",
                    headerTitle: "GAMITAS - Pelatihan",
                    loadingData: "Memuat data...",
                    lastUpdatedText: "Terakhir diperbarui:",
                    refreshButtonTitle: "Muat Ulang Data",
                    themeButtonTitle: "Ganti Tema",
                    errorBannerTitle: "Gagal Memuat Data",
                    sidebar_dashboard: "Dasbor",
                    sidebar_induksi: "Induksi",
                    sidebar_pelatihan: "Pelatihan Internal",
                    sidebar_laporan_insiden: "Laporan Insiden",
                    sidebar_laporan_observasi: "Laporan Observasi",
                    sidebar_logout: "Keluar",
                    tabDashboard: "Dasbor Pelatihan",
                    tabManpower: "Pelatihan Tenaga Kerja",
                    tabCompetencyLX: "Daftar Kompetensi LX",
                    tabCompetencyMatrix: "Matriks Kompetensi",
                    tabSchedule: "Jadwal Pelatihan",
                    tabATMP: "ATMP",
                    cardTotalCompetencies: "Total Kompetensi Terdaftar",
                    cardTotalManpower: "Total Tenaga Kerja Terlatih",
                    cardTrainingNeeds: "Total Kebutuhan Pelatihan",
                    chartTitleDistribution: "Grafik Distribusi Kompetensi POP, POM, POU",
                    chartTitleProgress: "Progres Pelatihan Keseluruhan",
                    chartLabelCompleted: "Selesai",
                    chartLabelPending: "Tertunda",
                    chartTitleTopNeeds: "5 Pelatihan Paling Dibutuhkan",
                    cardUpcomingSchedule: "Jadwal Mendatang",
                    manpowerDetailTitle: "Detail Kompetensi Tenaga Kerja",
                    manpowerSearchPlaceholder: "Cari nama tenaga kerja...",
                    manpowerDetailPlaceholder: "Pilih nama dari daftar untuk melihat detail.",
                    competencyLXTitle: "Daftar Kompetensi LX",
                    tableSearchPlaceholder: "Cari di tabel...",
                    itemsPerPage: "per halaman",
                    tableHeaderCompetency: "Kompetensi",
                    tableHeaderCode: "Kode",
                    tableHeaderType: "Jenis",
                    tableHeaderGroup: "Kelompok",
                    tableHeaderRegulation: "Peraturan",
                    matrixTitle: "Matriks Kompetensi Jabatan",
                    matrixFilterAll: "Semua",
                    scheduleTitle: "Jadwal Pelatihan",
                    atmpTitle: "Rencana Induk Pelatihan Tahunan (ATMP)",
                    atmpDescription: "Fitur ini sedang dalam pengembangan. ATMP akan menampilkan rencana pelatihan tahunan yang komprehensif untuk semua karyawan.",
                    modalDetailTitle: "Detail",
                    passwordModalTitle: "Akses Terbatas",
                    passwordModalPrompt: "Silakan masukkan kata sandi untuk mengakses halaman ini.",
                    passwordModalLabel: "Kata Sandi",
                    passwordModalError: "Kata sandi salah!",
                    passwordModalUnlock: "Buka",
                    passwordModalCancel: "Batal",
                },
                ko: {
                    pageTitle: "교육 대시보드 - GAMITAS",
                    headerTitle: "GAMITAS - 교육",
                    loadingData: "데이터 로딩 중...",
                    lastUpdatedText: "마지막 업데이트:",
                    refreshButtonTitle: "데이터 새로고침",
                    themeButtonTitle: "테마 변경",
                    errorBannerTitle: "데이터 로드 실패",
                    sidebar_dashboard: "대시보드",
                    sidebar_induksi: "입문 교육",
                    sidebar_pelatihan: "내부 교육",
                    sidebar_laporan_insiden: "사고 보고서",
                    sidebar_laporan_observasi: "관찰 보고서",
                    sidebar_logout: "로그아웃",
                    tabDashboard: "교육 대시보드",
                    tabManpower: "인력 교육",
                    tabCompetencyLX: "역량 LX 목록",
                    tabCompetencyMatrix: "역량 매트릭스",
                    tabSchedule: "교육 일정",
                    tabATMP: "ATMP",
                    cardTotalCompetencies: "총 등록된 역량",
                    cardTotalManpower: "총 교육받은 인력",
                    cardTrainingNeeds: "총 교육 필요",
                    chartTitleDistribution: "POP, POM, POU 역량 분포 그래프",
                    chartTitleProgress: "전체 교육 진행률",
                    chartLabelCompleted: "완료",
                    chartLabelPending: "보류 중",
                    chartTitleTopNeeds: "가장 필요한 교육 Top 5",
                    cardUpcomingSchedule: "예정된 일정",
                    manpowerDetailTitle: "인력 역량 세부 정보",
                    manpowerSearchPlaceholder: "인력 이름 검색...",
                    manpowerDetailPlaceholder: "목록에서 이름을 선택하여 역량 세부 정보를 확인하세요.",
                    competencyLXTitle: "역량 LX 목록",
                    tableSearchPlaceholder: "표에서 검색...",
                    itemsPerPage: "페이지당",
                    tableHeaderCompetency: "역량",
                    tableHeaderCode: "코드",
                    tableHeaderType: "유형",
                    tableHeaderGroup: "그룹",
                    tableHeaderRegulation: "규정",
                    matrixTitle: "직무 역량 매트릭스",
                    matrixFilterAll: "전체",
                    scheduleTitle: "교육 일정",
                    atmpTitle: "연간 교육 마스터 플랜 (ATMP)",
                    atmpDescription: "이 기능은 개발 중입니다. ATMP는 모든 직원을 위한 포괄적인 연간 교육 계획을 표시합니다.",
                    modalDetailTitle: "세부 정보",
                    passwordModalTitle: "접근 제한",
                    passwordModalPrompt: "이 페이지에 액세스하려면 비밀번호를 입력하십시오.",
                    passwordModalLabel: "비밀번호",
                    passwordModalError: "비밀번호가 잘못되었습니다!",
                    passwordModalUnlock: "잠금 해제",
                    passwordModalCancel: "취소",
                }
            };
        }

        function setLanguage(lang) {
            appState.currentLang = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang;

            const translations = appState.translations[lang];
            if (!translations) return;

            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (translations[key]) {
                    el.textContent = translations[key];
                }
            });

            document.querySelectorAll('[data-translate-placeholder-key]').forEach(el => {
                const key = el.dataset.translatePlaceholderKey;
                if (translations[key]) {
                    el.placeholder = translations[key];
                }
            });

            document.querySelectorAll('[data-translate-title-key]').forEach(el => {
                const key = el.dataset.translateTitleKey;
                if (translations[key]) {
                    el.title = translations[key];
                }
            });

            // Re-render dynamic parts that depend on language
            updateLastUpdatedTimestamp(appState.lastUpdated);
            if (appState.data && Object.keys(appState.data).length > 0) {
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth(), appState.data.jadwalTraining);
            }
        }


        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                const pageId = link.dataset.page;
                const externalUrl = link.dataset.externalUrl;
                const isProtected = pageId === 'laporan_insiden' || pageId === 'observasi';

                if (isProtected) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        requestPasswordAndSwitchPage(pageId, externalUrl || link.href);
                    });
                }
            });
            document.querySelector('.sidebar-link[data-page="pelatihan"]')?.classList.add('active');

            setupTabs('pelatihan-tabs');
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('refresh-button').addEventListener('click', forceRefreshData);
            document.getElementById('manpower-list')?.addEventListener('click', (e) => { if (e.target?.matches('li')) { showManpowerDetails(e.target.dataset.nik, appState.data.kompetensiManpower); document.querySelectorAll('#manpower-list li').forEach(li => li.classList.remove('bg-purple-200')); e.target.classList.add('bg-purple-200'); } });
            document.getElementById('prev-month')?.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth(), appState.data.jadwalTraining); });
            document.getElementById('next-month')?.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); generateCalendar(currentDate.getFullYear(), currentDate.getMonth(), appState.data.jadwalTraining); });

            // Modal listeners
            const modal = document.getElementById('detail-modal');
            modal.addEventListener('click', (e) => { if (e.target.id === 'detail-modal') modal.classList.remove('active'); });
            document.getElementById('modal-close-button').addEventListener('click', () => modal.classList.remove('active'));

            // Password Modal Listeners
            document.getElementById('password-form')?.addEventListener('submit', handlePasswordSubmit);
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-close-btn') || e.target.closest('.modal-close-btn') || e.target.matches('.modal-overlay')) {
                    document.querySelectorAll('.modal-overlay').forEach(modalEl => modalEl.classList.remove('active'));
                }
            });

            // Sidebar mobile toggle
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            mobileMenuToggle.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('show'); });
            document.addEventListener('click', (e) => { if (!sidebar.contains(e.target) && !mobileMenuToggle.contains(e.target)) { sidebar.classList.remove('show'); } });

            // Language Switcher
            document.getElementById('language-switcher').addEventListener('change', (e) => {
                setLanguage(e.target.value);
            });
        }

        async function forceRefreshData() {
            const refreshButton = document.getElementById('refresh-button');
            if (!refreshButton) return;
            const icon = refreshButton.firstElementChild;

            if (icon) {
                icon.classList.add('animate-spin');
            }
            refreshButton.disabled = true;

            updateLastUpdatedTimestamp(null);

            try {
                const freshData = await fetchAllTrainingData();
                console.log("Forced refresh successful. Updating UI and cache.");
                updateUI(freshData);
                setCachedData(freshData);
            } catch (error) {
                console.log("Forced refresh failed to retrieve new data.", error);
            } finally {
                if (icon) {
                    icon.classList.remove('animate-spin');
                }
                refreshButton.disabled = false;
            }
        }

        // ========== MAIN INITIALIZATION ==========
        async function initializePage() {
            await loadTranslations();
            document.getElementById('language-switcher').value = appState.currentLang;
            setLanguage(appState.currentLang);

            const cached = getCachedData();

            if (cached) {
                console.log("All data loaded from cache. Rendering initial UI.");
                updateUI(cached.data);
                updateLastUpdatedTimestamp(cached.timestamp);
                // Fetch new data in background
                forceRefreshData();
            } else {
                // No cache, so do a full fetch
                await forceRefreshData();
            }
        }


        document.addEventListener('DOMContentLoaded', async function () {
            document.body.classList.add(`theme-${appState.currentTheme}`);
            const themeToggleButton = document.getElementById("theme-toggle");
            if (themeToggleButton) {
                const iconName = appState.currentTheme === 'light' ? 'moon' : 'sun';
                themeToggleButton.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5 text-gray-600"></i>`;
            }

            lucide.createIcons();
            initializeCharts();

            await initializePage();

            setupEventListeners();
        });
    </script>
</body>

</html>