<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Terpadu GAMITAS</title>

    <!-- PWA and Mobile Meta Tags -->
    <meta name="theme-color" content="#9333ea" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="GAMITAS" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>G</text></svg>">
    <link rel="manifest"
        href="data:application/json;base64,eyJuYW1lIjoiR0FNSVRBUyAtIFNhZmV0eSBEYXNoYm9hcmQiLCJzaG9ydF9uYW1lIjoiR0FNSVRBUyIsImRlc2NyaXB0aW9uIjoiSW50ZWdyYXRlZCBTYWZldHkgU3lzdGVtIERhc2hib2FyZCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZjhmYWZjIiwidGhlbWVfY29sb3IiOiIjOTMzM2VhIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvOTMzM2VhL2ZmZmZmZj90ZXh0PUciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn0seyJzcmMiOiJodHRwczovL3BsYWNlaG9sZC5jby81MTJ4NTEyLzkzMzNlYS9mZmZmZmY/dGV4dD1HIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=" />

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        /* Basic Setup */
        :root {
            --bg-light: #f8fafc;
            --bg-dark: #1e293b;
            --text-light: #1f2937;
            --text-dark: #f1f5f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Theme */
        .theme-dark {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .theme-dark .bg-white {
            background-color: #334155 !important;
        }

        .theme-dark .bg-gray-50,
        .theme-dark .bg-gray-100 {
            background-color: #475569 !important;
        }

        .theme-dark .text-gray-800,
        .theme-dark .text-gray-900 {
            color: #f1f5f9 !important;
        }

        .theme-dark .text-gray-700 {
            color: #e2e8f0 !important;
        }

        .theme-dark .text-gray-600 {
            color: #cbd5e1 !important;
        }

        .theme-dark .text-gray-500 {
            color: #94a3b8 !important;
        }

        .theme-dark .border-gray-200,
        .theme-dark .border-b,
        .theme-dark .border-t {
            border-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-100:hover {
            background-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-50:hover {
            background-color: #4b5a70 !important;
        }

        .theme-dark .shadow-md,
        .theme-dark .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }

        .theme-dark input,
        .theme-dark select {
            background-color: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        .theme-dark input::placeholder {
            color: #94a3b8;
        }

        /* Active States */
        .sidebar-link.active {
            background-color: #f3e8ff;
            color: #9333ea;
            font-weight: 600;
        }

        .theme-dark .sidebar-link.active {
            background-color: #5b21b6;
            color: white;
        }

        .tab-link.active {
            color: #9333ea !important;
            border-color: #9333ea !important;
        }

        .theme-dark .tab-link.active {
            color: #a78bfa !important;
            border-color: #a78bfa !important;
        }

        /* Animations */
        .page-content,
        .tab-content {
            display: none;
        }

        .page-content.active,
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Loading States */
        .component-loading {
            position: relative;
            min-height: 100px;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .theme-dark .component-loading {
            background-color: #4b5563;
        }

        .component-loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        .theme-dark .component-loading::after {
            background: linear-gradient(90deg, transparent, rgba(100, 116, 139, 0.3), transparent);
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Banners */
        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            padding: 0.5rem;
            text-align: center;
            z-index: 2000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .offline-banner.show {
            transform: translateY(0);
        }

        .error-banner {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .theme-dark .error-banner {
            background-color: #4a2323;
            border-color: #993131;
            color: #fecaca;
        }

        /* Responsive */
        @media (max-width: 768px) {
            main {
                margin-left: 0 !important;
            }

            #sidebar {
                transform: translateX(-100%);
            }

            #sidebar.show {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body class="theme-light">

    <!-- Splash Screen -->
    <div id="splash-screen"
        class="fixed inset-0 bg-gradient-to-br from-purple-600 via-blue-600 to-green-500 flex items-center justify-center z-[9999]">
        <div class="text-center text-white">
            <div class="w-24 h-24 mx-auto mb-6 relative">
                <div class="absolute inset-0 bg-white rounded-full opacity-20 animate-ping"></div>
                <div class="relative w-24 h-24 bg-white rounded-full flex items-center justify-center">
                    <span id="splash-logo" class="text-4xl font-bold text-purple-600">G</span>
                </div>
            </div>
            <h1 id="splash-company-name" class="text-4xl font-bold mb-2">GAMITAS</h1>
            <p class="text-xl opacity-90">Advanced Safety Dashboard</p>
            <div class="flex items-center justify-center space-x-2 my-6">
                <div class="w-3 h-3 bg-white rounded-full animate-bounce"></div>
                <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
            <div class="w-64 h-2 bg-white bg-opacity-20 rounded-full overflow-hidden mx-auto mb-4">
                <div id="splash-progress" class="h-full bg-white rounded-full transition-all duration-300 ease-out"
                    style="width: 0%"></div>
            </div>
            <p id="splash-text" class="text-sm opacity-80">Initializing...</p>
        </div>
    </div>

    <!-- Banners -->
    <div id="offline-banner" class="offline-banner">
        <i data-lucide="wifi-off" class="w-4 h-4 inline mr-2"></i>
        Mode Offline - Data mungkin tidak terbaru
    </div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-50 transition-transform flex flex-col">
        <div class="p-6 border-b">
            <h1 id="company-name-sidebar" class="text-2xl font-bold text-gray-800">
                <span class="text-purple-600">G</span>AMITAS
            </h1>
            <p class="text-xs text-gray-500">Integrated Safety System</p>
        </div>
        <nav class="mt-4 flex-1 overflow-y-auto">
            <ul class="space-y-1 px-4">
                <li>
                    <a href="#" class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg"
                        data-page="dashboard">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="induksi" data-external-url="./induksi.html">
                        <i data-lucide="user-check" class="w-5 h-5"></i>
                        <span>Induksi</span>
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="pelatihan" data-external-url="./pelatihan.html">
                        <i data-lucide="award" class="w-5 h-5"></i>
                        <span>Pelatihan Internal</span>
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="laporan_insiden" data-external-url="./laporan_insiden.html">
                        <i data-lucide="file-warning" class="w-5 h-5"></i>
                        <span>Laporan Insiden</span>
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="observasi">
                        <i data-lucide="search-check" class="w-5 h-5"></i>
                        <span>Laporan Observasi</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="p-4 border-t">
            <button id="theme-toggle"
                class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
                <i data-lucide="sun" class="w-5 h-5"></i>
                <span>Ganti Tema</span>
            </button>
        </div>
    </aside>

    <button id="mobile-menu-toggle" class="fixed top-4 left-4 z-[60] p-2 rounded-lg bg-white shadow-md md:hidden">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <!-- Main Content -->
    <main class="md:ml-64 p-4 sm:p-6 lg:p-8 overflow-y-auto min-h-screen transition-all">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
            <div id="header-title">
                <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                <p id="last-updated" class="text-gray-500 text-sm">Memuat data...</p>
            </div>
            <div class="flex items-center space-x-2 sm:space-x-4">
                <button id="refresh-button" class="p-2 rounded-full hover:bg-gray-100" title="Muat Ulang Data">
                    <i data-lucide="refresh-cw" class="w-5 h-5 text-gray-600"></i>
                </button>
            </div>
        </header>

        <div id="error-banner" class="error-banner hidden">
            <div class="flex justify-between items-center">
                <span id="error-message"></span>
                <button id="retry-btn" class="bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-700">Coba
                    Lagi</button>
            </div>
        </div>

        <!-- Page Container -->
        <div id="page-container"></div>
    </main>

    <!-- Page Templates -->
    <template id="page-templates">
        <div id="dashboard-page" class="page-content">
            <!-- Induksi Summary -->
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Ringkasan Induksi Hari Ini</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Card Induksi Core -->
                <div id="card-induksi-core" class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center"><i data-lucide="building-2" class="w-8 h-8 text-purple-500 mr-4"></i>
                        <div>
                            <p id="induksi-core-today" class="text-2xl font-bold">-</p>
                            <p class="text-sm text-gray-500">Induksi (Core)</p>
                        </div>
                    </div>
                </div>
                <!-- Card Induksi Mitra -->
                <div id="card-induksi-mitra" class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center"><i data-lucide="users" class="w-8 h-8 text-green-500 mr-4"></i>
                        <div>
                            <p id="induksi-mitra-today" class="text-2xl font-bold">-</p>
                            <p class="text-sm text-gray-500">Induksi (Mitra)</p>
                        </div>
                    </div>
                </div>
                <!-- Card Induksi Visitor -->
                <div id="card-induksi-visitor" class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center"><i data-lucide="user" class="w-8 h-8 text-blue-500 mr-4"></i>
                        <div>
                            <p id="induksi-visitor-today" class="text-2xl font-bold">-</p>
                            <p class="text-sm text-gray-500">Induksi (Visitor)</p>
                        </div>
                    </div>
                </div>
                <!-- Card Kode Akses -->
                <div id="card-kode-akses" class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center"><i data-lucide="key-round" class="w-8 h-8 text-orange-500 mr-4"></i>
                        <div>
                            <p id="kode-akses-value" class="text-2xl font-bold">-</p>
                            <p class="text-sm text-gray-500">Kode Akses Hari Ini</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pelatihan Summary -->
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Ringkasan Pelatihan</h3>
            <div id="pelatihan-stats-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-500">Total Kompetensi</p>
                    <p id="total-kompetensi" class="text-3xl font-bold text-gray-800">-</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-500">Total Manpower Terlatih</p>
                    <p id="total-manpower-terlatih" class="text-3xl font-bold text-gray-800">-</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-500">Total Kebutuhan Pelatihan</p>
                    <p id="total-kebutuhan-pelatihan" class="text-3xl font-bold text-gray-800">-</p>
                </div>
            </div>

            <!-- Insiden Summary -->
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Top 5 Penyebab Insiden</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow">
                    <h4 class="font-semibold text-gray-700 mb-3">Penyebab Langsung</h4>
                    <ul id="top-risk-langsung" class="space-y-2 text-sm text-gray-600">
                        <li class="h-6 rounded bg-gray-200"></li>
                        <li class="h-6 rounded bg-gray-200"></li>
                        <li class="h-6 rounded bg-gray-200"></li>
                    </ul>
                </div>
                <div class="bg-white p-6 rounded-xl shadow">
                    <h4 class="font-semibold text-gray-700 mb-3">Penyebab Dasar</h4>
                    <ul id="top-risk-dasar" class="space-y-2 text-sm text-gray-600">
                        <li class="h-6 rounded bg-gray-200"></li>
                        <li class="h-6 rounded bg-gray-200"></li>
                        <li class="h-6 rounded bg-gray-200"></li>
                    </ul>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Tren Insiden Bulanan</h3>
                    <div class="h-72 component-loading" id="insiden-chart-container"><canvas
                            id="insidenTrendChart"></canvas></div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Jadwal Training Mendatang</h3>
                    <div id="jadwal-training-list" class="space-y-3 max-h-72 overflow-y-auto">
                        <div class="h-8 rounded w-full bg-gray-200"></div>
                        <div class="h-8 rounded w-full bg-gray-200"></div>
                        <div class="h-8 rounded w-full bg-gray-200"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="observasi-page" class="page-content">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                    <div class="flex">
                        <div class="flex-shrink-0"><i data-lucide="info" class="h-5 w-5 text-blue-400"></i></div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700"><strong>Halaman Observasi</strong> - Fitur ini sedang dalam
                                pengembangan.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // ========== GLOBAL STATE & CONFIGURATION ==========
        const appState = {
            data: {},
            currentPage: 'dashboard',
            currentTheme: localStorage.getItem('theme') || 'light',
            cache: {
                key: 'gamitas_dashboard_cache_v2',
                expiry: 15 * 60 * 1000 // 15 minutes
            },
            lastUpdated: null
        };

        // URLs for your deployed Apps Script Web Apps
        const API_URLS = {
            induksi: "https://script.google.com/macros/s/AKfycbwCCaANsivS48PiOIMIMSexlnbM1-fc3mtuiCzFbrnjcGEw2IgipIqQrGxjPsDld7Ohkw/exec",
            insiden: "https://script.google.com/macros/s/AKfycbx9D4Dcb3G6OdaxduqS-po676WJVI-WTonTSrOAZasab55lguTW2bLAYinMHPzrYr141Q/exec",
            pelatihan: "https://script.google.com/macros/s/AKfycbyJcIIUFiW7IKAX4FJN__eOvFMU6PE508Q465NZ-O0qwc0CGunG7SQui3X2P9K1XJAsuQ/exec"
        };

        // ========== CORE DATA FETCHING LOGIC ==========

        /**
         * Fetches data from Apps Scripts that use doGet (Induksi, Insiden).
         * @param {string} url - The base URL of the Web App.
         * @param {string} action - The action parameter for the script.
         * @returns {Promise<any>}
         */
        function fetchGetData(url, action) {
            return new Promise((resolve, reject) => {
                const callbackName = `jsonp_callback_${action}_${Math.round(100000 * Math.random())}`;
                const script = document.createElement('script'); // Define script here to be in scope

                window[callbackName] = (data) => {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    if (data.error) {
                        reject(new Error(`API Error [${action}]: ${data.details || data.error}`));
                    } else {
                        resolve(data);
                    }
                };

                script.src = `${url}?action=${action}&callback=${callbackName}`;
                script.onerror = () => {
                    delete window[callbackName];
                    if (script.parentNode) {
                        document.body.removeChild(script);
                    }
                    reject(new Error(`Network or script error for ${action}.`));
                };
                document.body.appendChild(script);
            });
        }

        /**
         * Orchestrates fetching all data from the three separate APIs.
         */
        async function fetchAllData() {
            updateSplashScreen(40, "Mengambil data Induksi...");
            const induksiPromise = fetchGetData(API_URLS.induksi, 'getDashboardData');

            updateSplashScreen(60, "Mengambil data Insiden...");
            const insidenPromise = fetchGetData(API_URLS.insiden, 'getChartData');

            updateSplashScreen(80, "Mengambil data Pelatihan...");
            const pelatihanStatsPromise = fetchGetData(API_URLS.pelatihan, 'getStatsData');
            const pelatihanSchedulePromise = fetchGetData(API_URLS.pelatihan, 'getUpcomingScheduleData');

            const results = await Promise.allSettled([
                induksiPromise,
                insidenPromise,
                pelatihanStatsPromise,
                pelatihanSchedulePromise
            ]);

            const combinedData = {};
            const errors = [];

            // Process Induksi Data (Index 0)
            if (results[0].status === 'fulfilled') {
                combinedData.induksi = results[0].value;
            } else {
                errors.push(`Induksi: ${results[0].reason.message}`);
            }

            // Process Insiden Data (Index 1)
            if (results[1].status === 'fulfilled') {
                combinedData.insiden = results[1].value;
            } else {
                errors.push(`Insiden: ${results[1].reason.message}`);
            }

            // Process Pelatihan Stats Data (Index 2)
            if (results[2].status === 'fulfilled') {
                combinedData.pelatihanStats = results[2].value;
            } else {
                errors.push(`Statistik Pelatihan: ${results[2].reason.message}`);
            }

            // Process Pelatihan Schedule Data (Index 3)
            if (results[3].status === 'fulfilled') {
                combinedData.pelatihanSchedule = results[3].value;
            } else {
                errors.push(`Jadwal Pelatihan: ${results[3].reason.message}`);
            }

            if (errors.length > 0) {
                showError(`Gagal memuat sebagian atau semua data: ${errors.join(', ')}.`, true);
            }

            // FIX: Always return the combinedData object, even if it's empty.
            // This prevents the application from crashing if all fetches fail.
            // The calling function (initializeApp) will handle the empty case.
            return combinedData;
        }

        // ========== UI UPDATE FUNCTIONS ==========

        function updateUI(data) {
            if (!data || Object.keys(data).length === 0) {
                showError("Tidak ada data untuk ditampilkan.", false);
                return;
            }
            appState.data = data;
            hideError();

            // Call individual UI update functions
            updateInduksiSummary(data.induksi);
            updatePelatihanSummary(data.pelatihanStats);
            updateInsidenSummary(data.insiden);
            updateJadwalTraining(data.pelatihanSchedule);
            updateInsidenChart(data.insiden);

            // Remove loading placeholders
            document.querySelectorAll('.component-loading').forEach(el => el.classList.remove('component-loading'));
            document.querySelectorAll('.bg-gray-200').forEach(el => el.classList.remove('bg-gray-200'));
        }

        function updateInduksiSummary(induksiData) {
            if (!induksiData || !induksiData.dashboard) {
                console.warn("Data induksi tidak ditemukan untuk pembaruan UI.");
                return;
            }
            const dash = induksiData.dashboard;
            document.getElementById('induksi-core-today').textContent = dash.induksiCoreToday ?? '-';
            document.getElementById('induksi-mitra-today').textContent = dash.induksiMitraToday ?? '-';
            document.getElementById('induksi-visitor-today').textContent = dash.induksiVisitorToday ?? '-';
            document.getElementById('kode-akses-value').textContent = dash.kodeAkses ?? 'N/A';
            document.getElementById('company-name-sidebar').innerHTML = `<span class="text-purple-600">${(induksiData.setting?.namaPerusahaan || 'G').charAt(0)}</span>${(induksiData.setting?.namaPerusahaan || 'AMITAS').slice(1)}`;
        }

        function updatePelatihanSummary(statsData) {
            if (!statsData) {
                console.warn("Data statistik pelatihan tidak ditemukan.");
                return;
            }
            document.getElementById('total-kompetensi').textContent = statsData.totalCompetencies ?? '-';
            document.getElementById('total-manpower-terlatih').textContent = statsData.totalTrainedManpower ?? '-';
            document.getElementById('total-kebutuhan-pelatihan').textContent = statsData.totalTrainingNeeds ?? '-';
        }

        function updateInsidenSummary(insidenData) {
            if (!insidenData) {
                console.warn("Data insiden tidak ditemukan.");
                return;
            }
            const renderList = (elementId, data) => {
                const container = document.getElementById(elementId);
                if (!container) return;
                container.innerHTML = '';
                if (!data || Object.keys(data).length === 0) {
                    container.innerHTML = '<li class="text-gray-500">Tidak ada data.</li>';
                    return;
                }
                Object.entries(data).forEach(([cause, count]) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center';
                    li.innerHTML = `<span>${cause}</span><span class="font-bold text-purple-600">${count}</span>`;
                    container.appendChild(li);
                });
            };
            renderList('top-risk-langsung', insidenData.byPenyebabLangsung);
            renderList('top-risk-dasar', insidenData.byPenyebabDasar);
        }

        function updateJadwalTraining(scheduleData) {
            const listContainer = document.getElementById('jadwal-training-list');
            if (!listContainer) return;
            if (!scheduleData || scheduleData.length === 0) {
                listContainer.innerHTML = '<p class="text-sm text-gray-500">Tidak ada jadwal training mendatang.</p>';
                return;
            }
            listContainer.innerHTML = scheduleData.map(item => `
                <div class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100">
                    <div class="bg-purple-100 p-2 rounded-full"><i data-lucide="calendar" class="w-5 h-5 text-purple-600"></i></div>
                    <div>
                        <p class="font-semibold text-sm text-gray-800">${item.namaKegiatan}</p>
                        <p class="text-xs text-gray-500">${new Date(item.tanggalMulai).toLocaleDateString('id-ID')} - ${new Date(item.tanggalSelesai).toLocaleDateString('id-ID')}</p>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // ========== CHART MANAGEMENT ==========
        const chartInstances = {};

        function initializeCharts() {
            const defaultOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.1)' } },
                    y: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.1)' }, beginAtZero: true }
                }
            };
            const ctx = document.getElementById('insidenTrendChart')?.getContext('2d');
            if (ctx) {
                if (chartInstances.insidenTrend) chartInstances.insidenTrend.destroy();
                chartInstances.insidenTrend = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [] },
                    options: defaultOptions
                });
            }
        }

        function updateInsidenChart(insidenData) {
            const chart = chartInstances.insidenTrend;
            if (!chart || !insidenData || !insidenData.monthlyTrend) {
                console.warn("Chart atau data tren insiden tidak ditemukan.");
                return;
            }
            const trendData = insidenData.monthlyTrend;
            const currentYear = new Date().getFullYear();
            const yearData = trendData[currentYear] || Array(12).fill(0);

            chart.data.labels = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            chart.data.datasets = [{
                label: `Insiden Tahun ${currentYear}`,
                data: yearData,
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                tension: 0.4,
                fill: true
            }];
            chart.update();
        }

        // ========== HELPERS & UTILITIES ==========
        const updateSplashScreen = (progress, text) => { document.getElementById("splash-progress").style.width = `${progress}%`; document.getElementById("splash-text").textContent = text; };
        const showError = (message, canRetry) => { document.getElementById('error-message').textContent = message; document.getElementById('retry-btn').style.display = canRetry ? 'block' : 'none'; document.getElementById('error-banner').classList.remove('hidden'); };
        const hideError = () => { document.getElementById('error-banner').classList.add('hidden'); };
        function updateLastUpdatedTimestamp(timestamp) {
            const el = document.getElementById('last-updated');
            if (!el) return;
            if (timestamp) {
                appState.lastUpdated = timestamp;
                const date = new Date(timestamp);
                el.textContent = `Diperbarui: ${date.toLocaleTimeString('id-ID')}`;
            } else {
                el.textContent = 'Memperbarui...';
            }
        }
        function getCachedData() {
            const item = localStorage.getItem(appState.cache.key);
            if (!item) return null;
            const { data, timestamp } = JSON.parse(item);
            if (Date.now() - timestamp > appState.cache.expiry) {
                localStorage.removeItem(appState.cache.key);
                return null;
            }
            return { data, timestamp };
        }
        function setCachedData(data) {
            const timestamp = Date.now();
            localStorage.setItem(appState.cache.key, JSON.stringify({ data, timestamp }));
            updateLastUpdatedTimestamp(timestamp);
        }

        // ========== PAGE & THEME MANAGEMENT ==========
        function switchPage(pageId) {
            appState.currentPage = pageId;
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(`${pageId}-page`)?.classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.sidebar-link[data-page="${pageId}"]`)?.classList.add('active');
            document.getElementById('header-title').querySelector('h2').textContent = pageId.charAt(0).toUpperCase() + pageId.slice(1);
            if (document.getElementById('sidebar').classList.contains('show')) {
                document.getElementById('sidebar').classList.remove('show');
            }
        }
        function toggleTheme() {
            appState.currentTheme = appState.currentTheme === "light" ? "dark" : "light";
            document.body.classList.toggle("theme-dark", appState.currentTheme === "dark");
            localStorage.setItem("theme", appState.currentTheme);
            document.getElementById("theme-toggle").innerHTML = `<i data-lucide="${appState.currentTheme === 'light' ? 'moon' : 'sun'}" class="w-5 h-5"></i><span>Ganti Tema</span>`;
            lucide.createIcons();
            initializeCharts();
            updateUI(appState.data);
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.dataset.page;
                    const externalUrl = link.dataset.externalUrl;
                    if (externalUrl) {
                        window.open(externalUrl, '_blank');
                    } else {
                        switchPage(pageId);
                    }
                });
            });
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('refresh-button').addEventListener('click', forceRefreshData);
            document.getElementById('retry-btn').addEventListener('click', forceRefreshData);
            document.getElementById('mobile-menu-toggle').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('sidebar').classList.toggle('show');
            });
            document.addEventListener('click', (e) => {
                const sidebar = document.getElementById('sidebar');
                const toggle = document.getElementById('mobile-menu-toggle');
                if (sidebar.classList.contains('show') && !sidebar.contains(e.target) && !toggle.contains(e.target)) {
                    sidebar.classList.remove('show');
                }
            });
            window.addEventListener("offline", () => document.getElementById("offline-banner").classList.add("show"));
            window.addEventListener("online", () => document.getElementById("offline-banner").classList.remove("show"));
        }

        // ========== INITIALIZATION ==========
        async function forceRefreshData() {
            const refreshButton = document.getElementById('refresh-button');
            const icon = refreshButton.firstElementChild;
            icon.classList.add('animate-spin');
            refreshButton.disabled = true;
            updateLastUpdatedTimestamp(null);

            try {
                const freshData = await fetchAllData();
                updateUI(freshData);
                setCachedData(freshData);
            } catch (error) {
                console.error("Force refresh failed:", error);
                showError(error.message, true);
            } finally {
                icon.classList.remove('animate-spin');
                refreshButton.disabled = false;
            }
        }

        async function initializeApp() {
            const splashScreen = document.getElementById('splash-screen');
            updateSplashScreen(10, "Mempersiapkan antarmuka...");

            const cached = getCachedData();
            if (cached) {
                console.log("Memuat data dari cache.");
                updateSplashScreen(20, "Memuat data dari cache...");
                updateUI(cached.data);
                updateLastUpdatedTimestamp(cached.timestamp);
            }

            try {
                const freshData = await fetchAllData();
                updateSplashScreen(95, "Menyelesaikan...");

                if (freshData && Object.keys(freshData).length > 0) {
                    updateUI(freshData);
                    setCachedData(freshData);
                } else if (!cached) {
                    console.error("Initial fetch failed and no cache is available.");
                    showError("Gagal memuat data awal. Silakan periksa koneksi Anda dan coba lagi.", true);
                }

            } catch (error) {
                console.error("Initialization error:", error);
                if (!cached) {
                    showError(error.message, true);
                }
            } finally {
                switchPage('dashboard');
                splashScreen.style.opacity = "0";
                setTimeout(() => splashScreen.style.display = "none", 500);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.body.classList.toggle("theme-dark", appState.currentTheme === "dark");
            document.getElementById('page-container').innerHTML = document.getElementById('page-templates').innerHTML;

            lucide.createIcons();
            initializeCharts();
            setupEventListeners();

            initializeApp();
        });
    </script>
</body>

</html>