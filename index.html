<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Terpadu GAMITAS</title>

    <!-- PWA and Mobile Meta Tags -->
    <meta name="theme-color" content="#9333ea" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="apple-mobile-web-app-title" content="GAMITAS" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>G</text></svg>">
    <link rel="manifest"
        href="data:application/json;base64,eyJuYW1lIjoiR0FNSVRBUyAtIFNhZmV0eSBEYXNoYm9hcmQiLCJzaG9ydF9uYW1lIjoiR0FNSVRBUyIsImRlc2NyaXB0aW9uIjoiSW50ZWdyYXRlZCBTYWZldHkgU3lzdGVtIERhc2hib2FyZCIsInN0YXJ0X3VybCI6Ii4iLCJkaXNwbGF5Ijoic3RhbmRhbG9uZSIsImJhY2tncm91bmRfY29sb3IiOiIjZjhmYWZjIiwidGhlbWVfY29sb3IiOiIjOTMzM2VhIiwiaWNvbnMiOlt7InNyYyI6Imh0dHBzOi8vcGxhY2Vob2xkLmNvLzE5MngxOTIvOTMzM2VhL2ZmZmZmZj90ZXh0PUciLCJzaXplcyI6IjE5MngxOTIiLCJ0eXBlIjoiaW1hZ2UvcG5nIn0seyJzcmMiOiJodHRwczovL3BsYWNlaG9sZC5jby81MTJ4NTEyLzkzMzNlYS9mZmZmZmY/dGV4dD1HIiwic2l6ZXMiOiI1MTJ4NTEyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=" />

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-light: #f8fafc;
            --bg-dark: #1e293b;
            --text-light: #1f2937;
            --text-dark: #f1f5f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .theme-dark {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .theme-dark .bg-white {
            background-color: #334155 !important;
        }

        .theme-dark .bg-gray-50,
        .theme-dark .bg-gray-100 {
            background-color: #475569 !important;
        }

        .theme-dark .text-gray-800,
        .theme-dark .text-gray-900 {
            color: #f1f5f9 !important;
        }

        .theme-dark .text-gray-700 {
            color: #e2e8f0 !important;
        }

        .theme-dark .text-gray-600 {
            color: #cbd5e1 !important;
        }

        .theme-dark .text-gray-500 {
            color: #94a3b8 !important;
        }

        .theme-dark .border-gray-200,
        .theme-dark .border-b,
        .theme-dark .border-t {
            border-color: #475569 !important;
        }

        .sidebar-link.active {
            background-color: #f3e8ff;
            color: #9333ea;
            font-weight: 600;
        }

        .theme-dark .sidebar-link.active {
            background-color: #5b21b6;
            color: white;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .component-loading {
            position: relative;
            min-height: 100px;
            background-color: #e5e7eb;
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .theme-dark .component-loading {
            background-color: #4b5563;
        }

        .component-loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 1.5s infinite;
        }

        .theme-dark .component-loading::after {
            background: linear-gradient(90deg, transparent, rgba(100, 116, 139, 0.3), transparent);
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .error-banner {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }

        .theme-dark .error-banner {
            background-color: #4a2323;
            border-color: #993131;
            color: #fecaca;
        }

        @media (max-width: 768px) {
            main {
                margin-left: 0 !important;
            }

            #sidebar {
                transform: translateX(-100%);
            }

            #sidebar.show {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body class="theme-light">

    <!-- Splash Screen -->
    <div id="splash-screen"
        class="fixed inset-0 bg-gradient-to-br from-purple-600 via-blue-600 to-green-500 flex items-center justify-center z-[9999]">
        <div class="text-center text-white">
            <div class="w-24 h-24 mx-auto mb-6 relative">
                <div class="absolute inset-0 bg-white rounded-full opacity-20 animate-ping"></div>
                <div class="relative w-24 h-24 bg-white rounded-full flex items-center justify-center">
                    <span id="splash-logo" class="text-4xl font-bold text-purple-600">G</span>
                </div>
            </div>
            <h1 id="splash-company-name" class="text-4xl font-bold mb-2">GAMITAS</h1>
            <p class="text-xl opacity-90">Advanced Safety Dashboard</p>
            <div class="flex items-center justify-center space-x-2 my-6">
                <div class="w-3 h-3 bg-white rounded-full animate-bounce"></div>
                <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-3 h-3 bg-white rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
            <div class="w-64 h-2 bg-white bg-opacity-20 rounded-full overflow-hidden mx-auto mb-4">
                <div id="splash-progress" class="h-full bg-white rounded-full transition-all duration-300 ease-out"
                    style="width: 0%"></div>
            </div>
            <p id="splash-text" class="text-sm opacity-80">Initializing...</p>
        </div>
    </div>

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-50 transition-transform flex flex-col">
        <div class="p-6 border-b">
            <h1 id="company-name-sidebar" class="text-2xl font-bold text-gray-800">
                <span class="text-purple-600">G</span>AMITAS
            </h1>
            <p class="text-xs text-gray-500">Integrated Safety System</p>
        </div>
        <nav class="mt-4 flex-1 overflow-y-auto">
            <ul class="space-y-1 px-4">
                <li><a href="#" class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg"
                        data-page="dashboard"><i data-lucide="layout-dashboard" class="w-5 h-5"></i><span
                            data-translate-key="sidebar_dashboard">Dashboard</span></a></li>
                <li><a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="induksi" data-external-url="./induksi.html"><i data-lucide="user-check"
                            class="w-5 h-5"></i><span data-translate-key="sidebar_induksi">Induksi</span></a></li>
                <li><a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="pelatihan" data-external-url="./pelatihan.html"><i data-lucide="award"
                            class="w-5 h-5"></i><span data-translate-key="sidebar_pelatihan">Pelatihan
                            Internal</span></a></li>
                <li><a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="laporan_insiden" data-external-url="./laporan_insiden.html"><i
                            data-lucide="file-warning" class="w-5 h-5"></i><span
                            data-translate-key="sidebar_laporan_insiden">Laporan Insiden</span></a></li>
                <li><a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="team_member" data-external-url="./team_member.html"><i data-lucide="users-2"
                            class="w-5 h-5"></i><span data-translate-key="sidebar_team_member">Team Member</span></a>
                </li>
            </ul>
        </nav>
        <div class="p-4 border-t">
            <button id="theme-toggle"
                class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100"><i
                    data-lucide="sun" class="w-5 h-5"></i><span data-translate-key="sidebar_theme">Ganti
                    Tema</span></button>
        </div>
    </aside>

    <button id="mobile-menu-toggle" class="fixed top-4 left-4 z-[60] p-2 rounded-lg bg-white shadow-md md:hidden">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <!-- Main Content -->
    <main class="md:ml-64 p-4 sm:p-6 lg:p-8 overflow-y-auto min-h-screen transition-all">
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
            <div id="header-title">
                <h2 class="text-3xl font-bold text-gray-800">Dashboard</h2>
                <p id="last-updated" class="text-gray-500 text-sm">Memuat data...</p>
            </div>
            <div class="flex items-center space-x-2 sm:space-x-4">
                <div class="relative" id="language-switcher">
                    <button id="language-toggle-btn" class="p-2 rounded-full hover:bg-gray-100"><i data-lucide="globe"
                            class="w-5 h-5 text-gray-600"></i></button>
                    <div id="language-menu"
                        class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl hidden z-20">
                        <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="en"><img src="https://flagcdn.com/gb.svg" class="w-5 h-auto mr-3"
                                alt="English Flag"><span>English</span></a>
                        <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="id"><img src="https://flagcdn.com/id.svg" class="w-5 h-auto mr-3"
                                alt="Indonesia Flag"><span>Bahasa Indonesia</span></a>
                        <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                            data-lang="ko"><img src="https://flagcdn.com/kr.svg" class="w-5 h-auto mr-3"
                                alt="Korean Flag"><span>한국어</span></a>
                    </div>
                </div>
                <button id="refresh-button" class="p-2 rounded-full hover:bg-gray-100" title="Muat Ulang Data">
                    <i data-lucide="refresh-cw" class="w-5 h-5 text-gray-600"></i>
                </button>
            </div>
        </header>

        <div id="error-banner" class="error-banner hidden">
            <div class="flex justify-between items-center">
                <span id="error-message"></span>
                <button id="retry-btn" class="bg-red-600 text-white px-3 py-1 rounded-md text-sm hover:bg-red-700">Coba
                    Lagi</button>
            </div>
        </div>

        <!-- Page Container -->
        <div id="page-container"></div>

        <footer class="mt-8 pt-4 border-t text-center text-xs text-gray-500">
            <p>HSE Team Training Promotion and System development</p>
            <p>Develop by <a href="https://ahmadfaqihdidin.github.io/" target="_blank" rel="noopener noreferrer"
                    class="text-purple-600 hover:underline">Ahmad Faqih I</a></p>
        </footer>
    </main>

    <!-- Page Templates -->
    <template id="page-templates">
        <div id="dashboard-page" class="page-content">
            <!-- Induksi Summary -->
            <h3 class="text-xl font-semibold text-gray-800 mb-4" data-translate-key="dashboard_title_induksi">Ringkasan
                Induksi Hari Ini</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center"><i data-lucide="building-2" class="w-8 h-8 text-purple-500 mr-4"></i>
                        <div>
                            <p id="induksi-core-today" class="text-2xl font-bold">-</p>
                            <p class="text-sm text-gray-500" data-translate-key="card_induksi_core">Induksi (Core)</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center"><i data-lucide="users" class="w-8 h-8 text-green-500 mr-4"></i>
                        <div>
                            <p id="induksi-mitra-today" class="text-2xl font-bold">-</p>
                            <p class="text-sm text-gray-500" data-translate-key="card_induksi_mitra">Induksi (Mitra)</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center"><i data-lucide="user" class="w-8 h-8 text-blue-500 mr-4"></i>
                        <div>
                            <p id="induksi-visitor-today" class="text-2xl font-bold">-</p>
                            <p class="text-sm text-gray-500" data-translate-key="card_induksi_visitor">Induksi (Visitor)
                            </p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <div class="flex items-center"><i data-lucide="key-round" class="w-8 h-8 text-orange-500 mr-4"></i>
                        <div>
                            <p id="kode-akses-value" class="text-2xl font-bold">-</p>
                            <p class="text-sm text-gray-500" data-translate-key="card_kode_akses">Kode Akses Hari Ini
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pelatihan Summary -->
            <h3 class="text-xl font-semibold text-gray-800 mb-4" data-translate-key="dashboard_title_pelatihan">
                Ringkasan Pelatihan</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-center">
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-500" data-translate-key="card_total_kompetensi">Total Kompetensi</p>
                    <p id="total-kompetensi" class="text-3xl font-bold text-gray-800">-</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-500" data-translate-key="card_total_manpower">Total Manpower Terlatih
                    </p>
                    <p id="total-manpower-terlatih" class="text-3xl font-bold text-gray-800">-</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow">
                    <p class="text-sm text-gray-500" data-translate-key="card_total_kebutuhan">Total Kebutuhan Pelatihan
                    </p>
                    <p id="total-kebutuhan-pelatihan" class="text-3xl font-bold text-gray-800">-</p>
                </div>
            </div>

            <!-- Insiden Summary -->
            <h3 class="text-xl font-semibold text-gray-800 mb-4" data-translate-key="dashboard_title_insiden">Top 5
                Penyebab Insiden</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow">
                    <h4 class="font-semibold text-gray-700 mb-3" data-translate-key="card_penyebab_langsung">Penyebab
                        Langsung</h4>
                    <ul id="top-risk-langsung" class="space-y-2 text-sm text-gray-600">
                        <li class="h-6 rounded bg-gray-200"></li>
                        <li class="h-6 rounded bg-gray-200"></li>
                        <li class="h-6 rounded bg-gray-200"></li>
                    </ul>
                </div>
                <div class="bg-white p-6 rounded-xl shadow">
                    <h4 class="font-semibold text-gray-700 mb-3" data-translate-key="card_penyebab_dasar">Penyebab Dasar
                    </h4>
                    <ul id="top-risk-dasar" class="space-y-2 text-sm text-gray-600">
                        <li class="h-6 rounded bg-gray-200"></li>
                        <li class="h-6 rounded bg-gray-200"></li>
                        <li class="h-6 rounded bg-gray-200"></li>
                    </ul>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-xl shadow">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4" data-translate-key="chart_title_insiden">Tren
                        Insiden Bulanan</h3>
                    <div class="h-72 component-loading relative" id="insiden-chart-wrapper">
                        <canvas id="insidenTrendChart"></canvas>
                        <div id="insiden-chart-message"
                            class="absolute inset-0 items-center justify-center h-full text-gray-500 hidden"></div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4" data-translate-key="chart_title_jadwal">Jadwal
                        Training Mendatang</h3>
                    <div id="jadwal-training-list" class="space-y-3 max-h-72 overflow-y-auto">
                        <div class="h-8 rounded w-full bg-gray-200"></div>
                        <div class="h-8 rounded w-full bg-gray-200"></div>
                        <div class="h-8 rounded w-full bg-gray-200"></div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <script>
        // #############################################################################
        // ### KODE UNTUK FILE: api_gabungan.gs (FINAL & OPTIMAL) ###
        // #############################################################################
        /*
        const CONFIG = {
          induksi: { id: "19SWnTTs34iX-fnrqovnCwwLcS2oAMt4Yu0apIdB5wV8", sheets: { "new-hire": { name: "Induksi_NewHire", headers: ["date", "nik", "nama", "jabatan", "perusahaan", "checklist", "spdk", "apvSystem", "status", "score"] }, "pasca-cuti": { name: "Induksi_PascaCuti", headers: ["date", "nik", "nama", "jabatan", "perusahaan", "statusInduksi", "score", "spdkChecklist"] }, "temporary": { name: "Induksi_Temporary", headers: ["date", "nik", "nama", "jabatan", "perusahaan", "status", "score"] }, "visitor": { name: "Induksi_Visitor", headers: ["date", "nik", "nama", "jabatan", "perusahaan", "status", "score"] }, "kodeAkses": { name: "KodeAkses", headers: ["date", "kodeAkses"] }, "setting": { name: "Setting", headers: ["namaPerusahaan"] }, } },
          insiden: { id: "1bFevC9EGzYmyQTLSCMxu53_7sH7Ab24GT4O0A4nZXTA", sheets: { "dataDasbor": { name: "Data_Dasbor", headers: ["id", "judulInsiden", "tanggalKejadian", "tahun", "hariKejadian", "jamMulaiKecelakaan", "jamSelesaiKecelakaan", "kategoriKecelakaan", "kategoriCedera", "kategoriPdUnit", "jenisKontakInsiden", "penyebabLangsung", "penyebabDasar", "perusahaan", "jabatan", "unitTerlibat", "usia", "masaKerja", "statusKaryawan", "poh", "tempatTinggal", "lokasiKejadian", "lokasiRincian", "latitude", "longitude", "biayaPengobatan", "biayaPerbaikan", "biayaTidakLangsung", "totalBiaya", "kategoriPd", "statusLpi", "sanksi", "tipeCedera", "bagianCidera"] } } },
          pelatihan: { id: "1rYjpyZMyvOHibsF-z_y-sAH9PZd1m79KNk_UB8_K5lM", sheets: { "monitoring-internal": { name: "monitoring_internal", headers: ["internalTraining", "code", "done", "allMp", "off", "progress", "needTraining"] }, "jadwal-training": { name: "jadwal_training", headers: ["tanggalMulai", "tanggalSelesai", "namaKegiatan", "ruangan", "jumlahPeserta", "pic", "kode", "totalHari"] }, "kompetensi-manpower": { name: "kompetensi_manpower", headers: ["noPermit", "nik", "nama", "dept", "section", "jabatan", "kompetensi", "status"] }, } }
        };
        function getSheetDataAsObjects(ss, sheetKey, config) { const conf = config.sheets[sheetKey]; if (!conf) return []; const sheet = ss.getSheetByName(conf.name); if (!sheet || sheet.getLastRow() < 2) return []; const values = sheet.getRange(2, 1, sheet.getLastRow() - 1, conf.headers.length).getValues(); return values.map(row => conf.headers.reduce((obj, key, i) => { let cell = row[i]; obj[key] = cell instanceof Date && !isNaN(cell) ? Utilities.formatDate(cell, Session.getScriptTimeZone(), "yyyy-MM-dd") : cell; return obj; }, {}));}
        function getInduksiData(ss) { const today = new Date().toLocaleDateString("en-CA"); const d = { nh: getSheetDataAsObjects(ss, "new-hire", CONFIG.induksi), pc: getSheetDataAsObjects(ss, "pasca-cuti", CONFIG.induksi), t: getSheetDataAsObjects(ss, "temporary", CONFIG.induksi), v: getSheetDataAsObjects(ss, "visitor", CONFIG.induksi), ka: getSheetDataAsObjects(ss, "kodeAkses", CONFIG.induksi), s: getSheetDataAsObjects(ss, "setting", CONFIG.induksi) }; const mc = "PT. GAM"; const it = [...d.nh, ...d.pc, ...d.t].filter(i => i.date === today); const vt = d.v.filter(i => i.date === today); return { setting: d.s[0] || {}, dashboard: { induksiCoreToday: it.filter(i => i.perusahaan?.toLowerCase() === mc.toLowerCase()).length, induksiMitraToday: it.filter(i => i.perusahaan?.toLowerCase() !== mc.toLowerCase()).length, induksiVisitorToday: vt.length, kodeAkses: (d.ka.find(k => k.date === today) || { kodeAkses: "N/A" }).kodeAkses, } }; }
        function getInsidenData(ss) { const d = getSheetDataAsObjects(ss, "dataDasbor", CONFIG.insiden); const c = (data, key) => data.reduce((a, item) => { const v = item[key] || "N/A"; if (v !== "N/A") a[v] = (a[v] || 0) + 1; return a; }, {}); const t = (data, key, n = 5) => Object.fromEntries(Object.entries(c(data, key)).sort(([, a], [, b]) => b - a).slice(0, n)); return { monthlyTrend: d.reduce((a, i) => { if (!i.tanggalKejadian) return a; try { const dt = new Date(i.tanggalKejadian); const y = dt.getFullYear(); const m = dt.getMonth(); if (!isNaN(y) && !isNaN(m)) { if (!a[y]) a[y] = Array(12).fill(0); a[y][m]++; } } catch (e) {} return a; }, {}), byPenyebabLangsung: t(d, "penyebabLangsung"), byPenyebabDasar: t(d, "penyebabDasar"), }; }
        function getPelatihanStatsData(ss) { const km = getSheetDataAsObjects(ss, "kompetensi-manpower", CONFIG.pelatihan); const mi = getSheetDataAsObjects(ss, "monitoring-internal", CONFIG.pelatihan); return { totalCompetencies: new Set(km.map(i => i.kompetensi).filter(Boolean)).size, totalTrainedManpower: new Set(km.map(i => i.nik).filter(Boolean)).size, totalTrainingNeeds: mi.reduce((a, i) => a + (parseInt(i.needTraining) || 0), 0) }; }
        function getPelatihanScheduleData(ss) { const d = getSheetDataAsObjects(ss, "jadwal-training", CONFIG.pelatihan); const t = new Date(); t.setHours(0, 0, 0, 0); return d.filter(i => i.tanggalMulai && new Date(i.tanggalMulai) >= t).sort((a, b) => new Date(a.tanggalMulai) - new Date(b.tanggalMulai)).slice(0, 5); }
        function doGet(e) { const c = e.parameter.callback; let d = {}; let err = []; try { d.induksi = getInduksiData(SpreadsheetApp.openById(CONFIG.induksi.id)); } catch (e) { err.push(`Induksi: ${e.message}`); } try { d.insiden = getInsidenData(SpreadsheetApp.openById(CONFIG.insiden.id)); } catch (e) { err.push(`Insiden: ${e.message}`); } try { const ss = SpreadsheetApp.openById(CONFIG.pelatihan.id); d.pelatihanStats = getPelatihanStatsData(ss); d.pelatihanSchedule = getPelatihanScheduleData(ss); } catch (e) { err.push(`Pelatihan: ${e.message}`); } return ContentService.createTextOutput(`${c}(${JSON.stringify({ data: d, errors: err })})`).setMimeType(ContentService.MimeType.JAVASCRIPT); }
        */
        // #############################################################################

        // ========== GLOBAL STATE & CONFIGURATION ==========
        const appState = {
            data: {},
            currentPage: 'dashboard',
            currentTheme: localStorage.getItem('theme') || 'light',
            currentLanguage: localStorage.getItem('language') || 'en',
            cache: { key: 'gamitas_dashboard_cache_v8', expiry: 15 * 60 * 1000 },
        };

        const API_GABUNGAN_URL = "https://script.google.com/macros/s/AKfycbyrXX07iEXdzFrcfKnysazEiXR7LAdBz5-IazWr67HAygIVj860c-jlWH3eEh_J-BTt/exec";

        // ========== TRANSLATIONS ==========
        const translations = {
            en: { sidebar_dashboard: "Dashboard", sidebar_induksi: "Induction", sidebar_pelatihan: "Internal Training", sidebar_laporan_insiden: "Incident Report", sidebar_team_member: "Team Member", sidebar_theme: "Change Theme", dashboard_title_induksi: "Today's Induction Summary", card_induksi_core: "Induction (Core)", card_induksi_mitra: "Induction (Partner)", card_induksi_visitor: "Induction (Visitor)", card_kode_akses: "Today's Access Code", dashboard_title_pelatihan: "Training Summary", card_total_kompetensi: "Total Competencies", card_total_manpower: "Total Trained Manpower", card_total_kebutuhan: "Total Training Needs", dashboard_title_insiden: "Top 5 Incident Causes", card_penyebab_langsung: "Direct Causes", card_penyebab_dasar: "Root Causes", chart_title_insiden: "Monthly Incident Trend", chart_title_jadwal: "Upcoming Training Schedule", team_intro_title: "Meet Our Team", team_intro_subtitle: "The team behind the development of this system." },
            id: { sidebar_dashboard: "Dasbor", sidebar_induksi: "Induksi", sidebar_pelatihan: "Pelatihan Internal", sidebar_laporan_insiden: "Laporan Insiden", sidebar_team_member: "Anggota Tim", sidebar_theme: "Ganti Tema", dashboard_title_induksi: "Ringkasan Induksi Hari Ini", card_induksi_core: "Induksi (Core)", card_induksi_mitra: "Induksi (Mitra)", card_induksi_visitor: "Induksi (Visitor)", card_kode_akses: "Kode Akses Hari Ini", dashboard_title_pelatihan: "Ringkasan Pelatihan", card_total_kompetensi: "Total Kompetensi", card_total_manpower: "Total Manpower Terlatih", card_total_kebutuhan: "Total Kebutuhan Pelatihan", dashboard_title_insiden: "Top 5 Penyebab Insiden", card_penyebab_langsung: "Penyebab Langsung", card_penyebab_dasar: "Penyebab Dasar", chart_title_insiden: "Tren Insiden Bulanan", chart_title_jadwal: "Jadwal Training Mendatang", team_intro_title: "Perkenalkan Tim Kami", team_intro_subtitle: "Tim di balik pengembangan sistem ini." },
            ko: { sidebar_dashboard: "대시보드", sidebar_induksi: "입문 교육", sidebar_pelatihan: "내부 훈련", sidebar_laporan_insiden: "사고 보고서", sidebar_team_member: "팀원", sidebar_theme: "테마 변경", dashboard_title_induksi: "오늘의 입문 교육 요약", card_induksi_core: "입문 교육 (핵심)", card_induksi_mitra: "입문 교육 (파트너)", card_induksi_visitor: "입문 교육 (방문자)", card_kode_akses: "오늘의 액세스 코드", dashboard_title_pelatihan: "훈련 요약", card_total_kompetensi: "총 역량", card_total_manpower: "총 훈련된 인력", card_total_kebutuhan: "총 훈련 필요", dashboard_title_insiden: "상위 5개 사고 원인", card_penyebab_langsung: "직접적인 원인", card_penyebab_dasar: "근본 원인", chart_title_insiden: "월간 사고 동향", chart_title_jadwal: "예정된 훈련 일정", team_intro_title: "우리 팀을 만나보세요", team_intro_subtitle: "이 시스템 개발의 배후에 있는 팀입니다." }
        };

        // ========== CORE DATA FETCHING LOGIC ==========
        function fetchGetData(url) {
            return new Promise((resolve, reject) => {
                if (url.includes("GANTI_DENGAN_URL")) { return reject(new Error("URL API Gabungan belum diatur.")); }
                const cb = `cb_${Date.now()}`;
                const script = document.createElement('script');
                const timer = setTimeout(() => { cleanup(); reject(new Error("Request timed out.")); }, 60000);
                const cleanup = () => { clearTimeout(timer); delete window[cb]; if (script.parentElement) script.parentElement.removeChild(script); };
                window[cb] = (res) => { cleanup(); if (res.data) resolve(res); else reject(new Error("Format respons tidak valid.")); };
                script.src = `${url}?callback=${cb}`;
                script.onerror = () => { cleanup(); reject(new Error("Gagal menghubungi API Gabungan.")); };
                document.head.appendChild(script);
            });
        }

        async function fetchAllData() {
            updateSplashScreen(50, "Menghubungi server...");
            const response = await fetchGetData(API_GABUNGAN_URL);
            if (response.errors && response.errors.length > 0) { showError(`Error dari server: ${response.errors.join('; ')}`, true); }
            if (response.data && Object.keys(response.data).length > 0) { return response.data; }
            else { throw new Error("Gagal mengambil data dari server."); }
        }

        // ========== UI UPDATE FUNCTIONS ==========
        function updateUI(data) {
            if (!data) return;
            appState.data = data;
            updateInduksiSummary(data.induksi);
            updatePelatihanSummary(data.pelatihanStats);
            updateInsidenSummary(data.insiden);
            updateJadwalTraining(data.pelatihanSchedule);
            updateInsidenChart(data.insiden);
            document.querySelectorAll('.component-loading').forEach(el => { el.classList.remove('component-loading'); el.style.minHeight = 'auto'; });
            document.querySelectorAll('.bg-gray-200').forEach(el => el.classList.remove('bg-gray-200'));
        }

        function updateInduksiSummary(d) {
            if (!d || !d.dashboard) return;
            document.getElementById('induksi-core-today').textContent = d.dashboard.induksiCoreToday ?? '-';
            document.getElementById('induksi-mitra-today').textContent = d.dashboard.induksiMitraToday ?? '-';
            document.getElementById('induksi-visitor-today').textContent = d.dashboard.induksiVisitorToday ?? '-';
            document.getElementById('kode-akses-value').textContent = d.dashboard.kodeAkses ?? 'N/A';
            const name = d.setting?.namaPerusahaan || 'GAMITAS';
            document.getElementById('company-name-sidebar').innerHTML = `<span class="text-purple-600">GAM</span>ITAS`;
        }

        function updatePelatihanSummary(d) {
            if (!d) return;
            document.getElementById('total-kompetensi').textContent = d.totalCompetencies ?? '-';
            document.getElementById('total-manpower-terlatih').textContent = d.totalTrainedManpower ?? '-';
            document.getElementById('total-kebutuhan-pelatihan').textContent = d.totalTrainingNeeds ?? '-';
        }

        function updateInsidenSummary(d) {
            if (!d) return;
            const renderList = (id, data) => {
                const container = document.getElementById(id);
                if (!container) return;
                container.innerHTML = '';
                if (!data || Object.keys(data).length === 0) { container.innerHTML = '<li class="text-gray-500">Tidak ada data.</li>'; return; }
                Object.entries(data).forEach(([cause, count]) => { container.innerHTML += `<li class="flex justify-between items-center"><span>${cause}</span><span class="font-bold text-purple-600">${count}</span></li>`; });
            };
            renderList('top-risk-langsung', d.byPenyebabLangsung);
            renderList('top-risk-dasar', d.byPenyebabDasar);
        }

        function updateJadwalTraining(d) {
            const container = document.getElementById('jadwal-training-list');
            if (!container || !d) return;
            if (d.length === 0) { container.innerHTML = '<p class="text-sm text-gray-500">Tidak ada jadwal.</p>'; return; }
            container.innerHTML = d.map(item => `
                <div class="flex items-center space-x-3 p-2 rounded-lg hover:bg-gray-100">
                    <div class="bg-purple-100 p-2 rounded-full"><i data-lucide="calendar" class="w-5 h-5 text-purple-600"></i></div>
                    <div><p class="font-semibold text-sm text-gray-800">${item.namaKegiatan}</p><p class="text-xs text-gray-500">${new Date(item.tanggalMulai).toLocaleDateString('id-ID')}</p></div>
                </div>`).join('');
            lucide.createIcons();
        }

        // ========== CHART MANAGEMENT ==========
        const chartInstances = {};
        function initializeCharts() {
            const options = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.1)' } }, y: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.1)' }, beginAtZero: true } } };
            const ctx = document.getElementById('insidenTrendChart')?.getContext('2d');
            if (ctx) { if (chartInstances.insidenTrend) chartInstances.insidenTrend.destroy(); chartInstances.insidenTrend = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [] }, options }); }
        }

        function updateInsidenChart(d) {
            const chart = chartInstances.insidenTrend;
            const messageEl = document.getElementById('insiden-chart-message');
            const canvasEl = document.getElementById('insidenTrendChart');
            if (!chart || !messageEl || !canvasEl) return;
            if (!d || !d.monthlyTrend) { messageEl.textContent = 'Data tren insiden tidak tersedia.'; messageEl.style.display = 'flex'; canvasEl.style.display = 'none'; return; }
            const yearData = d.monthlyTrend[new Date().getFullYear()] || Array(12).fill(0);
            if (yearData.every(item => item === 0)) { messageEl.textContent = 'Tidak ada data insiden untuk tahun ini.'; messageEl.style.display = 'flex'; canvasEl.style.display = 'none'; return; }
            messageEl.style.display = 'none'; canvasEl.style.display = 'block';
            chart.data.labels = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
            chart.data.datasets = [{ label: 'Insiden', data: yearData, borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.4, fill: true }];
            chart.update();
        }

        // ========== HELPERS & UTILITIES ==========
        const updateSplashScreen = (p, t) => { document.getElementById("splash-progress").style.width = `${p}%`; document.getElementById("splash-text").textContent = t; };
        const showError = (m, r) => { document.getElementById('error-message').innerHTML = `<ul class="list-disc list-inside text-sm">${m.split(';').map(e => `<li>${e.trim()}</li>`).join('')}</ul>`; document.getElementById('retry-btn').style.display = r ? 'block' : 'none'; document.getElementById('error-banner').classList.remove('hidden'); };
        const hideError = () => { document.getElementById('error-banner').classList.add('hidden'); };
        const updateLastUpdatedTimestamp = (t) => { const el = document.getElementById('last-updated'); if (el) { if (t) { appState.lastUpdated = t; el.textContent = `Diperbarui: ${new Date(t).toLocaleTimeString('id-ID')}`; } else { el.textContent = 'Memperbarui...'; } } };
        const getCachedData = () => { const i = localStorage.getItem(appState.cache.key); if (!i) return null; try { const { d, t } = JSON.parse(i); if (Date.now() - t > appState.cache.expiry) { localStorage.removeItem(appState.cache.key); return null; } return { d, t }; } catch (e) { return null; } };
        const setCachedData = (d) => { const t = Date.now(); try { localStorage.setItem(appState.cache.key, JSON.stringify({ d, t })); updateLastUpdatedTimestamp(t); } catch (e) { console.error("Gagal menyimpan cache:", e); } };

        // ========== PAGE & LANGUAGE MANAGEMENT ==========
        function setLanguage(lang) {
            appState.currentLanguage = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang;
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                const translation = translations[lang][key];
                if (translation) {
                    el.innerText = translation;
                }
            });
            switchPage(appState.currentPage); // Refresh page title
        }

        function switchPage(pageId) {
            appState.currentPage = pageId;
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.getElementById(`${pageId}-page`)?.classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.sidebar-link[data-page="${pageId}"]`)?.classList.add('active');
            const headerTitle = document.querySelector('#header-title h2');
            if (headerTitle) { headerTitle.textContent = translations[appState.currentLanguage][`sidebar_${pageId}`] || "Dashboard"; }
            if (document.getElementById('sidebar').classList.contains('show')) { document.getElementById('sidebar').classList.remove('show'); }
        }
        function toggleTheme() {
            appState.currentTheme = appState.currentTheme === "light" ? "dark" : "light";
            document.body.classList.toggle("theme-dark", appState.currentTheme === "dark");
            localStorage.setItem("theme", appState.currentTheme);
            document.getElementById("theme-toggle").innerHTML = `<i data-lucide="${appState.currentTheme === 'light' ? 'moon' : 'sun'}" class="w-5 h-5"></i><span data-translate-key="sidebar_theme">Ganti Tema</span>`;
            setLanguage(appState.currentLanguage);
            lucide.createIcons();
            initializeCharts();
            updateUI(appState.data);
        }

        // ========== EVENT LISTENERS & INTRO ==========
        function setupEventListeners() {
            document.querySelectorAll('.sidebar-link').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const pageId = link.dataset.page; if (link.dataset.externalUrl) { window.open(link.dataset.externalUrl, '_blank'); } else { switchPage(pageId); } }); });
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('refresh-button').addEventListener('click', forceRefreshData);
            document.getElementById('retry-btn').addEventListener('click', forceRefreshData);
            document.getElementById('mobile-menu-toggle').addEventListener('click', (e) => { e.stopPropagation(); document.getElementById('sidebar').classList.toggle('show'); });
            document.addEventListener('click', (e) => { const s = document.getElementById('sidebar'), t = document.getElementById('mobile-menu-toggle'); if (s.classList.contains('show') && !s.contains(e.target) && !t.contains(e.target)) { s.classList.remove('show'); } });

            const langToggle = document.getElementById('language-toggle-btn');
            const langMenu = document.getElementById('language-menu');
            langToggle.addEventListener('click', (e) => { e.stopPropagation(); langMenu.classList.toggle('hidden'); });
            document.addEventListener('click', (e) => { if (!langToggle.parentElement.contains(e.target)) langMenu.classList.add('hidden'); });
            langMenu.addEventListener('click', (e) => { if (e.target.closest('[data-lang]')) { setLanguage(e.target.closest('[data-lang]').dataset.lang); langMenu.classList.add('hidden'); } });
        }

        // ========== INITIALIZATION ==========
        async function forceRefreshData() {
            const btn = document.getElementById('refresh-button'), icon = btn.firstElementChild;
            icon.classList.add('animate-spin'); btn.disabled = true;
            updateLastUpdatedTimestamp(null);
            localStorage.removeItem(appState.cache.key); // Clear cache on force refresh
            try {
                const freshData = await fetchAllData();
                updateUI(freshData);
                setCachedData(freshData);
                hideError();
            } catch (error) {
                console.error("Force refresh failed:", error);
                showError(error.message, true);
            } finally {
                icon.classList.remove('animate-spin'); btn.disabled = false;
            }
        }

        async function initializeApp() {
            const splash = document.getElementById('splash-screen');
            updateSplashScreen(10, "Mempersiapkan antarmuka...");
            const cached = getCachedData();
            if (cached) { updateSplashScreen(20, "Memuat data dari cache..."); updateUI(cached.d); updateLastUpdatedTimestamp(cached.t); }
            try {
                const freshData = await fetchAllData();
                updateSplashScreen(95, "Menyelesaikan...");
                updateUI(freshData);
                setCachedData(freshData);
                hideError();
            } catch (error) {
                console.error("Initialization error:", error);
                if (!cached) { showError(error.message, true); }
            } finally {
                splash.style.opacity = "0";
                setTimeout(() => {
                    splash.style.display = "none";
                    switchPage('dashboard');
                }, 500);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.body.classList.toggle("theme-dark", appState.currentTheme === "dark");
            document.getElementById('page-container').innerHTML = document.getElementById('page-templates').innerHTML;
            lucide.createIcons();
            initializeCharts();
            setupEventListeners();
            setLanguage(appState.currentLanguage);
            initializeApp();
        });
    </script>
</body>

</html>
