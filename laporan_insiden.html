<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Insiden - GAMITAS</title>

    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-light: #f8fafc;
            --bg-dark: #1e293b;
            --text-light: #1f2937;
            --text-dark: #f1f5f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Theme Styles */
        .theme-dark {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .theme-dark .bg-white {
            background-color: #334155 !important;
        }

        .theme-dark .bg-gray-50,
        .theme-dark .bg-gray-100 {
            background-color: #475569 !important;
        }

        .theme-dark .text-gray-800,
        .theme-dark .text-gray-900 {
            color: #f1f5f9 !important;
        }

        .theme-dark .text-gray-700 {
            color: #e2e8f0 !important;
        }

        .theme-dark .text-gray-600 {
            color: #cbd5e1 !important;
        }

        .theme-dark .text-gray-500 {
            color: #94a3b8 !important;
        }

        .theme-dark .border-gray-200,
        .theme-dark .border-b,
        .theme-dark .border-t {
            border-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-100:hover {
            background-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-50:hover {
            background-color: #4b5a70 !important;
        }

        .theme-dark .shadow-md,
        .theme-dark .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }

        .theme-dark input,
        .theme-dark select {
            background-color: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        .theme-dark input::placeholder {
            color: #94a3b8;
        }

        .theme-dark .tab-link.active {
            color: #a78bfa !important;
            border-color: #a78bfa !important;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .component-loading {
            position: relative;
            min-height: 100px;
            overflow: hidden;
        }

        .component-loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            animation: shimmer 1.5s infinite;
        }

        .theme-dark .component-loading::after {
            background: linear-gradient(90deg, transparent, rgba(100, 116, 139, 0.5), transparent);
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="theme-light">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <div>
                <h1 class="text-2xl font-bold text-gray-800"><span class="text-purple-600">G</span>AMITAS - Laporan
                    Insiden</h1>
                <p id="last-updated" class="text-xs text-gray-500">Memuat data...</p>
            </div>
            <div class="flex items-center space-x-2">
                <a href="./index.html"
                    class="text-purple-600 hover:text-purple-800 font-medium flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100">
                    <i data-lucide="arrow-left-circle"></i>
                    <span class="hidden sm:inline">Kembali</span>
                </a>
                <button id="refresh-button" class="p-2 rounded-full hover:bg-gray-100" title="Muat Ulang Data">
                    <i data-lucide="refresh-cw" class="w-5 h-5 text-gray-600"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100" title="Ganti Tema">
                    <i data-lucide="sun" class="w-5 h-5 text-gray-600"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="p-4 sm:p-6 lg:p-8">
        <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
            <p class="font-bold">Gagal Memuat Data</p>
            <p id="error-message-content">Terjadi kesalahan.</p>
        </div>

        <div id="laporan-page" class="page-content active">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" id="laporan-tabs">
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-purple-500 px-1 pb-4 text-sm font-medium text-purple-600"
                            data-tab="dashboard-laporan">Dashboard Insiden</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="data-laporan">Data Laporan</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="hse-performance">HSE Performance</a>
                    </nav>
                </div>
                <div class="mt-6">
                    <div id="dashboard-laporan-content" class="tab-content active">
                        <div class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div class="bg-blue-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-blue-700">Total Insiden</p>
                                    <p id="total-insiden" class="text-3xl font-bold text-blue-900">-</p>
                                </div>
                                <div class="bg-red-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-red-700">Kasus Berat (LTI)</p>
                                    <p id="total-lti" class="text-3xl font-bold text-red-900">-</p>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-orange-700">Kasus Ringan (Non-LTI)</p>
                                    <p id="total-non-lti" class="text-3xl font-bold text-orange-900">-</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-green-700">Nyaris Celaka</p>
                                    <p id="total-near-miss" class="text-3xl font-bold text-green-900">-</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                                <div class="lg:col-span-3 bg-gray-50 p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4">Tren Insiden Bulanan</h3>
                                    <div class="h-80"><canvas id="trenInsidenChart"></canvas></div>
                                </div>
                                <div class="lg:col-span-2 bg-gray-50 p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4">Klasifikasi Insiden</h3>
                                    <div class="h-80 flex items-center"><canvas id="klasifikasiInsidenChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="data-laporan-content" class="tab-content">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                            <h3 class="text-lg font-semibold">Semua Laporan Insiden</h3><button
                                class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center space-x-2"><i
                                    data-lucide="plus"></i><span>Buat Laporan Baru</span></button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase border-b">
                                        <th class="py-3 px-4">ID</th>
                                        <th class="py-3 px-4">Tanggal</th>
                                        <th class="py-3 px-4">Judul Insiden</th>
                                        <th class="py-3 px-4">Klasifikasi</th>
                                        <th class="py-3 px-4">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="laporan-insiden-table-body" class="text-sm text-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                    <div id="hse-performance-content" class="tab-content">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg card component-loading">
                                <p class="text-sm text-gray-500">LTIFR (YTD)</p>
                                <p id="ltifr-ytd" class="text-3xl font-bold text-red-600">-</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg card component-loading">
                                <p class="text-sm text-gray-500">TRIR (YTD)</p>
                                <p id="trir-ytd" class="text-3xl font-bold text-orange-600">-</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg card component-loading">
                                <p class="text-sm text-gray-500">Total Man Hours</p>
                                <p id="manhours-ytd" class="text-3xl font-bold text-blue-600">-</p>
                            </div>
                        </div>
                        <div class="bg-gray-50 p-6 rounded-lg card component-loading">
                            <h3 class="text-md font-semibold text-gray-700 mb-4">Performa LTIFR & TRIR Bulanan</h3>
                            <div class="h-80"><canvas id="hsePerformanceChart"></canvas></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ========== GLOBAL STATE & UTILITIES ==========
        const appState = {
            data: {},
            currentTheme: localStorage.getItem('theme') || 'light',
            cache: {
                key: 'insiden_data_cache',
                expiry: 30 * 60 * 1000 // 30 minutes
            },
            lastUpdated: null
        };
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx0aYGEksnIrt1_YXDbzS1TFqQU6DV4CV0dSC7QH35N33bp6kIGB6bD9-do_v0G8gvGAA/exec';

        function showErrorBanner(message) {
            const banner = document.getElementById('error-banner');
            const messageContent = document.getElementById('error-message-content');
            if (banner && messageContent) {
                messageContent.innerHTML = message;
                banner.classList.remove('hidden');
            }
        }

        function updateLastUpdatedTimestamp(timestamp) {
            const el = document.getElementById('last-updated');
            if (!el) return;
            if (timestamp) {
                appState.lastUpdated = timestamp;
                const date = new Date(timestamp);
                el.textContent = `Terakhir diperbarui: ${date.toLocaleDateString('id-ID')} ${date.toLocaleTimeString('id-ID')}`;
            } else {
                el.textContent = 'Memperbarui data...';
            }
        }

        // ========== CACHING FUNCTIONS ==========
        function getCachedData() {
            const cachedItem = localStorage.getItem(appState.cache.key);
            if (!cachedItem) return null;
            try {
                const { data, timestamp } = JSON.parse(cachedItem);
                if (Date.now() - timestamp > appState.cache.expiry) {
                    localStorage.removeItem(appState.cache.key);
                    return null;
                }
                return { data, timestamp };
            } catch (error) {
                localStorage.removeItem(appState.cache.key);
                return null;
            }
        }

        function setCachedData(data) {
            const timestamp = Date.now();
            const itemToCache = { data, timestamp };
            try {
                localStorage.setItem(appState.cache.key, JSON.stringify(itemToCache));
                updateLastUpdatedTimestamp(timestamp);
            } catch (error) {
                console.error(`Error saving cache:`, error);
            }
        }

        // ========== DATA FETCHING ==========
        async function fetchAllInsidenData() {
            if (APPS_SCRIPT_URL === 'URL_APPS_SCRIPT_ANDA_DI_SINI') {
                showErrorBanner('URL Apps Script belum dikonfigurasi.');
                return null;
            }
            try {
                // FIXED: Changed source from 'insiden' to 'dashboard' as the Apps Script expects this parameter
                // and the 'dashboard' source already contains the necessary incident data.
                const response = await fetch(`${APPS_SCRIPT_URL}?source=dashboard`);
                if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                const data = await response.json();
                if (data.error) throw new Error(`Apps Script Error: ${data.error}`);
                return {
                    dataDasbor: data.Data_Dasbor || [],
                    performance: data.Performance || []
                };
            } catch (error) {
                console.error("Fetch failed permanently for insiden data:", error);
                showErrorBanner(`Gagal mengambil data dari server. Data yang ditampilkan mungkin usang. Silakan coba lagi.`);
                return null;
            }
        }

        // ========== CHART MANAGEMENT ==========
        const chartInstances = {};
        function initializeCharts() {
            const defaultChartOptions = (extraOptions = {}) => ({
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: appState.currentTheme === 'dark' ? '#f1f5f9' : '#1f2937' } } },
                scales: {
                    x: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.2)' } },
                    y: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.2)' } }
                }, ...extraOptions
            });
            const createChart = (id, type, options) => {
                const ctx = document.getElementById(id)?.getContext("2d");
                if (ctx) { if (chartInstances[id]) chartInstances[id].destroy(); chartInstances[id] = new Chart(ctx, { type, data: { labels: [], datasets: [] }, options }); }
            };
            createChart('trenInsidenChart', 'line', defaultChartOptions({ plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }));
            createChart('klasifikasiInsidenChart', 'pie', defaultChartOptions({ plugins: { legend: { position: 'right' } } }));
            createChart('hsePerformanceChart', 'line', defaultChartOptions({ scales: { y: { beginAtZero: true, position: 'left' } } }));
        }

        // ========== UI UPDATE FUNCTIONS ==========
        function updateUI(data) {
            if (!data || !data.dataDasbor || !data.performance) {
                console.warn("Update UI skipped due to incomplete data.");
                return;
            };
            appState.data = data;
            updateLaporanDashboard(data);
            document.querySelectorAll('.component-loading').forEach(el => el.classList.remove('component-loading'));
        }

        function updateLaporanDashboard(data) {
            const insidenData = data.dataDasbor, perfData = data.performance;
            document.getElementById('total-insiden').textContent = insidenData.length;
            document.getElementById('total-lti').textContent = insidenData.filter(d => d.kategoriKecelakaan === 'LTI').length;
            document.getElementById('total-non-lti').textContent = insidenData.filter(d => d.kategoriKecelakaan === 'Non-LTI').length;
            document.getElementById('total-near-miss').textContent = insidenData.filter(d => d.kategoriKecelakaan === 'Near Miss').length;
            const monthlyTrend = Array(12).fill(0); insidenData.forEach(d => { const month = new Date(d.tanggalKejadian).getMonth(); if (month >= 0 && month < 12) monthlyTrend[month]++; });
            if (chartInstances.trenInsidenChart) {
                chartInstances.trenInsidenChart.data = {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'],
                    datasets: [{ label: 'Jumlah Insiden', data: monthlyTrend, borderColor: '#dc2626', backgroundColor: 'rgba(220, 38, 38, 0.1)', tension: 0.4, fill: true }]
                };
                chartInstances.trenInsidenChart.update();
            }
            const classificationCounts = insidenData.reduce((acc, d) => { const cat = d.kategoriKecelakaan || 'Lainnya'; acc[cat] = (acc[cat] || 0) + 1; return acc; }, {});
            if (chartInstances.klasifikasiInsidenChart) {
                chartInstances.klasifikasiInsidenChart.data = {
                    labels: Object.keys(classificationCounts),
                    datasets: [{ data: Object.values(classificationCounts), backgroundColor: ['#dc2626', '#f59e0b', '#10b981', '#6b7280'] }]
                };
                chartInstances.klasifikasiInsidenChart.update();
            }

            const tableBody = document.getElementById('laporan-insiden-table-body');
            if (tableBody) {
                tableBody.innerHTML = insidenData.map(row => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4">${row.id || '-'}</td>
                    <td class="py-3 px-4">${row.tanggalKejadian || '-'}</td>
                    <td class="py-3 px-4">${row.judulInsiden || '-'}</td>
                    <td class="py-3 px-4">${row.kategoriKecelakaan || '-'}</td>
                    <td class="py-3 px-4">${row.statusLpi || '-'}</td>
                </tr>
            `).join('');
            }

            document.getElementById('ltifr-ytd').textContent = perfData.find(row => row.Deskripsi === 'LTIFR (YTD)')?.YTD || '-';
            document.getElementById('trir-ytd').textContent = perfData.find(row => row.Deskripsi === 'TRIR (YTD)')?.YTD || '-';
            document.getElementById('manhours-ytd').textContent = parseFloat(perfData.find(row => row.Deskripsi === 'TOTAL MANHOURS (YTD)')?.YTD || 0).toLocaleString('id-ID');
            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const ltifrMonthly = perfData.find(row => row.Deskripsi === 'LTIFR'), trirMonthly = perfData.find(row => row.Deskripsi === 'TRIR');
            if (chartInstances.hsePerformanceChart && ltifrMonthly && trirMonthly) {
                chartInstances.hsePerformanceChart.data = {
                    labels: months,
                    datasets: [
                        { label: 'LTIFR', data: months.map(m => ltifrMonthly[m] || 0), borderColor: '#dc2626', tension: 0.4, yAxisID: 'y' },
                        { label: 'TRIR', data: months.map(m => trirMonthly[m] || 0), borderColor: '#f59e0b', tension: 0.4, yAxisID: 'y' }
                    ]
                };
                chartInstances.hsePerformanceChart.update();
            }
        }

        // ========== THEME & NAVIGATION ==========
        function setupTabs(tabContainerId) {
            const tabContainer = document.getElementById(tabContainerId); if (!tabContainer) return;
            const tabLinks = tabContainer.querySelectorAll('.tab-link'), tabContents = tabContainer.closest('.bg-white').querySelectorAll('.tab-content');
            tabLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const tabId = link.dataset.tab;
                    tabLinks.forEach(l => { l.classList.remove('border-purple-500', 'text-purple-600'); l.classList.add('border-transparent', 'text-gray-500'); });
                    link.classList.add('border-purple-500', 'text-purple-600'); link.classList.remove('border-transparent', 'text-gray-500');
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId + '-content')?.classList.add('active');
                });
            });
        }
        function toggleTheme() {
            appState.currentTheme = appState.currentTheme === "light" ? "dark" : "light";
            document.body.classList.remove("theme-light", "theme-dark");
            document.body.classList.add(`theme-${appState.currentTheme}`);
            localStorage.setItem("theme", appState.currentTheme);
            const themeToggleButton = document.getElementById("theme-toggle");
            if (themeToggleButton) {
                const newIconName = appState.currentTheme === "light" ? "moon" : "sun";
                themeToggleButton.innerHTML = `<i data-lucide="${newIconName}" class="w-5 h-5 text-gray-600"></i>`;
            }
            lucide.createIcons();
            initializeCharts();
            updateUI(appState.data);
        }

        // ========== EVENT LISTENERS ==========
        function setupEventListeners() {
            setupTabs('laporan-tabs');
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('refresh-button').addEventListener('click', forceRefreshData);
        }

        async function forceRefreshData() {
            const refreshButton = document.getElementById('refresh-button');
            if (!refreshButton) return;
            const icon = refreshButton.firstElementChild;

            if (icon) icon.classList.add('animate-spin');
            refreshButton.disabled = true;

            updateLastUpdatedTimestamp(null);

            const freshData = await fetchAllInsidenData();

            if (freshData) {
                console.log("Forced refresh successful. Updating UI and cache.");
                updateUI(freshData);
                setCachedData(freshData);
            } else {
                console.log("Forced refresh failed to retrieve new data.");
            }

            if (icon) icon.classList.remove('animate-spin');
            refreshButton.disabled = false;
        }

        // ========== MAIN INITIALIZATION ==========
        async function initializePage() {
            const cached = getCachedData();

            if (cached) {
                console.log("All data loaded from cache. Rendering initial UI.");
                updateUI(cached.data);
                updateLastUpdatedTimestamp(cached.timestamp);
            }

            await forceRefreshData();
        }


        document.addEventListener('DOMContentLoaded', async function () {
            document.body.classList.add(`theme-${appState.currentTheme}`);
            const themeToggleButton = document.getElementById("theme-toggle");
            if (themeToggleButton) {
                const iconName = appState.currentTheme === 'light' ? 'moon' : 'sun';
                themeToggleButton.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5 text-gray-600"></i>`;
            }

            lucide.createIcons();
            initializeCharts();

            await initializePage();

            setupEventListeners();
        });
    </script>
</body>

</html>