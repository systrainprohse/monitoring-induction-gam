<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="pageTitle">Laporan Insiden - GAMITAS</title>

    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Libraries for Map and Export -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-light: #f8fafc;
            --bg-dark: #1e293b;
            --text-light: #1f2937;
            --text-dark: #f1f5f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Theme Styles */
        .theme-dark {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .theme-dark .bg-white {
            background-color: #334155 !important;
        }

        .theme-dark .bg-gray-50,
        .theme-dark .bg-gray-100 {
            background-color: #475569 !important;
        }

        .theme-dark .text-gray-800,
        .theme-dark .text-gray-900 {
            color: #f1f5f9 !important;
        }

        .theme-dark .text-gray-700 {
            color: #e2e8f0 !important;
        }

        .theme-dark .text-gray-600 {
            color: #cbd5e1 !important;
        }

        .theme-dark .text-gray-500 {
            color: #94a3b8 !important;
        }

        .theme-dark .border-gray-200,
        .theme-dark .border-b,
        .theme-dark .border-t {
            border-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-100:hover {
            background-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-50:hover {
            background-color: #4b5a70 !important;
        }

        .theme-dark .shadow-md,
        .theme-dark .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }

        .theme-dark input,
        .theme-dark select {
            background-color: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        .theme-dark input::placeholder {
            color: #94a3b8;
        }

        .theme-dark .tab-link.active {
            color: #a78bfa !important;
            border-color: #a78bfa !important;
        }

        .theme-dark .bg-slate-800 {
            background-color: #0f172a !important;
        }

        .theme-dark .bg-slate-900 {
            background-color: #020617 !important;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .component-loading {
            position: relative;
            min-height: 100px;
            overflow: hidden;
        }

        .component-loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            animation: shimmer 1.5s infinite;
        }

        .theme-dark .component-loading::after {
            background: linear-gradient(90deg, transparent, rgba(100, 116, 139, 0.5), transparent);
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        #incident-map {
            height: 400px;
            border-radius: 0.5rem;
            z-index: 10;
        }

        .theme-dark .leaflet-tile-pane {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background-color: var(--bg-light);
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 1000px;
            /* Increased width for graphs */
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-container {
            transform: scale(1);
        }

        .theme-dark .modal-container {
            background-color: var(--bg-dark);
        }

        .table-cell-highlight {
            background-color: rgba(239, 68, 68, 0.2);
            /* Light red */
        }

        .theme-dark .table-cell-highlight {
            background-color: rgba(239, 68, 68, 0.4);
            /* Darker red for dark mode */
        }

        /* Tooltip Styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .theme-dark .tooltip-text {
            background-color: #f1f5f9;
            color: #1e293b;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>

<body class="theme-light">

    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <div>
                <h1 class="text-2xl font-bold text-gray-800" data-translate-key="headerTitle"><span
                        class="text-purple-600">G</span>AMITAS - Laporan
                    Insiden</h1>
                <p id="last-updated" class="text-xs text-gray-500" data-translate-key="loadingData">Memuat data...</p>
            </div>
            <div class="flex items-center space-x-2">
                <a href="./index.html"
                    class="text-purple-600 hover:text-purple-800 font-medium flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100">
                    <i data-lucide="arrow-left-circle"></i>
                    <span class="hidden sm:inline" data-translate-key="backButton">Kembali</span>
                </a>
                <button id="refresh-button" class="p-2 rounded-full hover:bg-gray-100" title="Muat Ulang Data"
                    data-translate-title-key="refreshButtonTitle">
                    <i data-lucide="refresh-cw" class="w-5 h-5 text-gray-600"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100" title="Ganti Tema"
                    data-translate-title-key="themeButtonTitle">
                    <i data-lucide="sun" class="w-5 h-5 text-gray-600"></i>
                </button>
                <!-- Language Switcher -->
                <div class="relative">
                    <select id="language-switcher" class="p-2 rounded-md border border-gray-300 bg-white text-gray-700">
                        <option value="en">English</option>
                        <option value="id">Indonesia</option>
                        <option value="ko">한국어</option>
                    </select>
                </div>
            </div>
        </div>
    </header>

    <main class="p-4 sm:p-6 lg:p-8">
        <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
            <p class="font-bold" data-translate-key="errorBannerTitle">Gagal Memuat Data</p>
            <p id="error-message-content">Terjadi kesalahan.</p>
        </div>

        <div id="laporan-page" class="page-content active">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" id="laporan-tabs">
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-purple-500 px-1 pb-4 text-sm font-medium text-purple-600 active"
                            data-tab="dashboard-laporan" data-translate-key="tabDashboard">Dashboard Insiden</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="data-laporan" data-translate-key="tabDataReport">Data Laporan</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="hse-performance" data-translate-key="tabHSEPerformance">HSE Performance</a>
                    </nav>
                </div>
                <div class="mt-6">
                    <div id="dashboard-laporan-content" class="tab-content active">
                        <div class="space-y-6">

                            <!-- Dashboard Filter Section -->
                            <div class="bg-white p-6 rounded-lg card">
                                <h3 class="text-md font-semibold text-gray-700 mb-4 flex items-center"><i
                                        data-lucide="filter" class="w-5 h-5 mr-2"></i><span
                                        data-translate-key="dashboardFilterTitle">Filter Dashboard</span></h3>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                    <div>
                                        <label for="dashboard-filter-year" class="text-sm font-medium text-gray-600"
                                            data-translate-key="yearLabel">Tahun</label>
                                        <select id="dashboard-filter-year"
                                            class="w-full p-2 border rounded-md mt-1"></select>
                                    </div>
                                    <div>
                                        <label for="dashboard-filter-month" class="text-sm font-medium text-gray-600"
                                            data-translate-key="monthLabel">Bulan</label>
                                        <select id="dashboard-filter-month"
                                            class="w-full p-2 border rounded-md mt-1"></select>
                                    </div>
                                    <button id="dashboard-apply-filter"
                                        class="md:col-start-3 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 h-10"
                                        data-translate-key="applyFilterButton">Terapkan Filter</button>
                                    <button id="dashboard-reset-filter"
                                        class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 h-10"
                                        data-translate-key="resetFilterButton">Reset Filter</button>
                                </div>
                            </div>

                            <!-- Period Comparison Section -->
                            <div class="bg-white p-6 rounded-lg card">
                                <h3 class="text-md font-semibold text-gray-700 mb-4 flex items-center"><i
                                        data-lucide="calendar-days" class="w-5 h-5 mr-2"></i><span
                                        data-translate-key="comparisonAnalysisTitle">Analisis Perbandingan
                                        Periode</span></h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-end mb-4">
                                    <div>
                                        <label class="text-sm font-medium text-gray-600"
                                            data-translate-key="periodA">Periode A</label>
                                        <div class="flex gap-2 mt-1">
                                            <select id="compare-month-a" class="w-full p-2 border rounded-md"></select>
                                            <select id="compare-year-a" class="w-full p-2 border rounded-md"></select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="text-sm font-medium text-gray-600"
                                            data-translate-key="periodB">Periode B</label>
                                        <div class="flex gap-2 mt-1">
                                            <select id="compare-month-b" class="w-full p-2 border rounded-md"></select>
                                            <select id="compare-year-b" class="w-full p-2 border rounded-md"></select>
                                        </div>
                                    </div>
                                </div>
                                <button id="compare-button"
                                    class="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700"
                                    data-translate-key="compareButton">Bandingkan</button>
                                <div id="comparison-results" class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                                    <!-- Results will be injected here -->
                                </div>
                            </div>


                            <!-- Summary Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div class="bg-blue-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-blue-700" data-translate-key="totalIncidents">Total Insiden
                                    </p>
                                    <p id="total-insiden" class="text-3xl font-bold text-blue-900">-</p>
                                </div>
                                <div class="bg-red-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-red-700" data-translate-key="propertyDamage">Property Damage
                                    </p>
                                    <p id="total-property-damage" class="text-3xl font-bold text-red-900">-</p>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-orange-700" data-translate-key="injury">Cedera</p>
                                    <p id="total-injury" class="text-3xl font-bold text-orange-900">-</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-green-700" data-translate-key="nearMiss">Nyaris Celaka</p>
                                    <p id="total-near-miss" class="text-3xl font-bold text-green-900">-</p>
                                </div>
                            </div>

                            <!-- Main Dashboard Grid -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="monthlyTrendTitle">Tren Insiden Bulanan</h3>
                                    <div class="h-[32rem]"><canvas id="trenInsidenChart"></canvas></div>
                                </div>
                                <div class="space-y-6">
                                    <div class="bg-white p-6 rounded-lg card component-loading">
                                        <h3 class="text-md font-semibold text-gray-700 mb-4"
                                            data-translate-key="classificationTitle">Klasifikasi Insiden</h3>
                                        <div class="h-80 flex items-center justify-center"><canvas
                                                id="klasifikasiInsidenChart"></canvas></div>
                                    </div>
                                    <div id="rincian-biaya-card" class="bg-white p-6 rounded-lg card component-loading">
                                        <h3 class="text-md font-semibold text-gray-700 mb-4"
                                            data-translate-key="costDetailsTitle">Rincian Biaya Insiden</h3>
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p class="text-sm text-gray-500" data-translate-key="treatmentCost">
                                                        Biaya Pengobatan</p>
                                                    <p id="biaya-pengobatan" class="font-bold text-gray-800 text-lg">-
                                                    </p>
                                                </div>
                                                <div class="bg-green-100 text-green-600 p-2 rounded-full">
                                                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p class="text-sm text-gray-500" data-translate-key="repairCost">
                                                        Biaya Perbaikan Unit</p>
                                                    <p id="biaya-perbaikan" class="font-bold text-gray-800 text-lg">-
                                                    </p>
                                                </div>
                                                <div class="bg-blue-100 text-blue-600 p-2 rounded-full">
                                                    <i data-lucide="settings" class="w-5 h-5"></i>
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p class="text-sm text-gray-500" data-translate-key="indirectCost">
                                                        Biaya Tidak Langsung</p>
                                                    <p id="biaya-tidak-langsung"
                                                        class="font-bold text-gray-800 text-lg">-</p>
                                                </div>
                                                <div class="bg-yellow-100 text-yellow-600 p-2 rounded-full">
                                                    <i data-lucide="zap" class="w-5 h-5"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div
                                            class="mt-4 flex justify-between items-center p-4 bg-slate-800 text-white rounded-lg">
                                            <div>
                                                <p class="text-sm font-medium" data-translate-key="totalCost">Total
                                                    Biaya</p>
                                                <p id="total-biaya" class="font-bold text-xl">-</p>
                                            </div>
                                            <div class="text-slate-300">
                                                <i data-lucide="dollar-sign" class="w-7 h-7"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- NEW: Additional Charts Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- Chart placeholders -->
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitlePosition">Insiden Berdasarkan Jabatan</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipPosition">Menampilkan
                                                5 jabatan teratas dengan insiden terbanyak.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="jabatanChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleDay">Insiden per Hari</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipDay">Distribusi
                                                insiden berdasarkan hari dalam seminggu.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="hariChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleCompany">Insiden per Perusahaan</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipCompany">Jumlah
                                                insiden yang terjadi di setiap perusahaan.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="perusahaanChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleDirectCause">Penyebab Langsung</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipDirectCause">Kategori
                                                penyebab langsung dari insiden.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="penyebabLangsungChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleRootCause">Penyebab Dasar</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipRootCause">Faktor
                                                sistemik atau akar masalah yang mengarah pada penyebab langsung.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="penyebabDasarChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleUnit">Unit Terlibat</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipUnit">Jenis unit atau
                                                kendaraan yang paling sering terlibat dalam insiden.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="unitTerlibatChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleWorkExperience">Masa Kerja</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text"
                                                data-translate-key="tooltipWorkExperience">Distribusi insiden
                                                berdasarkan rentang masa kerja karyawan.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="masaKerjaChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleInjuryType">Tipe Cedera</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipInjuryType">Jenis
                                                cedera yang paling sering terjadi.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="tipeCederaChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleVictimAge">Usia Korban</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipVictimAge">Distribusi
                                                usia korban yang terlibat dalam insiden.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="usiaKorbanChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleEmployeeStatus">Status Karyawan</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipEmployeeStatus">Jumlah
                                                insiden berdasarkan status kepegawaian.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="statusKaryawanChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleResidence">Tempat Tinggal</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipResidence">Distribusi
                                                asal tempat tinggal karyawan yang terlibat insiden.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="tempatTinggalChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleShift">Insiden per Shift</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipShift">Jumlah insiden
                                                yang terjadi pada shift siang dan malam.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="shiftChart"></canvas></div>
                                </div>
                            </div>

                            <!-- Incident Map -->
                            <div class="bg-white p-6 rounded-lg card component-loading">
                                <h3 class="text-md font-semibold text-gray-700 mb-4 flex items-center"><i
                                        data-lucide="map-pin" class="w-5 h-5 mr-2"></i><span
                                        data-translate-key="mapTitle">Peta Sebaran Insiden</span></h3>
                                <div id="incident-map"></div>
                            </div>
                        </div>
                    </div>
                    <div id="data-laporan-content" class="tab-content">
                        <!-- Data Export Filters -->
                        <div
                            class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4 p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-4">
                                <h3 class="text-lg font-semibold" data-translate-key="dataReportFilterTitle">Filter
                                    Laporan</h3>
                                <select id="filter-year" class="p-2 border rounded-md"></select>
                                <button id="reset-filter-button"
                                    class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700"
                                    data-translate-key="resetFilterButton">Reset Filter</button>
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="export-csv-button"
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-2"><i
                                        data-lucide="file-spreadsheet"></i><span data-translate-key="downloadCSV">Unduh
                                        Data (CSV)</span></button>
                                <button id="export-pdf-button"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2"><i
                                        data-lucide="file-text"></i><span data-translate-key="downloadPDF">Unduh Laporan
                                        (PDF)</span></button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase border-b">
                                        <th class="py-3 px-4" data-translate-key="tableId">ID</th>
                                        <th class="py-3 px-4" data-translate-key="tableDate">Tanggal</th>
                                        <th class="py-3 px-4" data-translate-key="tableTitle">Judul Insiden</th>
                                        <th class="py-3 px-4" data-translate-key="tableClassification">Klasifikasi</th>
                                        <th class="py-3 px-4" data-translate-key="tableStatus">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="laporan-insiden-table-body" class="text-sm text-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                    <!-- UPDATED: HSE Performance Tab Content -->
                    <div id="hse-performance-content" class="tab-content">
                        <div class="space-y-6">
                            <div
                                class="flex flex-col sm:flex-row justify-between items-center gap-4 p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-4">
                                    <h3 class="text-lg font-semibold" data-translate-key="hseFilterTitle">Filter Kinerja
                                    </h3>
                                    <select id="hse-filter-year" class="p-2 border rounded-md"></select>
                                    <input type="text" id="hse-search-input" placeholder="Cari Deskripsi..."
                                        data-translate-placeholder-key="searchPlaceholder"
                                        class="p-2 border rounded-md">
                                    <button id="hse-reset-filter-button"
                                        class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700"
                                        data-translate-key="resetButton">Reset</button>
                                </div>
                                <button id="view-graph-button"
                                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center space-x-2">
                                    <i data-lucide="bar-chart-2"></i><span data-translate-key="viewGraphButton">Lihat
                                        Grafik</span>
                                </button>
                            </div>

                            <div class="overflow-x-auto bg-white rounded-lg shadow-md p-4">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800"
                                    data-translate-key="safetyPerformanceTitle">Kinerja Keselamatan Pertambangan</h3>
                                <table class="w-full text-left text-sm">
                                    <thead id="hse-safety-table-head"></thead>
                                    <tbody id="hse-safety-table-body" class="text-gray-700"></tbody>
                                </table>
                            </div>

                            <div class="overflow-x-auto bg-white rounded-lg shadow-md p-4">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800"
                                    data-translate-key="performancesTitle">Performance's</h3>
                                <table class="w-full text-left text-sm">
                                    <thead id="hse-performance-table-head"></thead>
                                    <tbody id="hse-performance-table-body" class="text-gray-700"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Incident Detail Modal -->
    <div id="incident-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800"
                    data-translate-key="modalIncidentDetailTitle">Detail Insiden</h2>
                <button id="modal-close-button" class="p-2 rounded-full hover:bg-gray-200">
                    <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                </button>
            </div>
            <div id="modal-content" class="space-y-6 text-sm"></div>
        </div>
    </div>

    <!-- Graph View Modal -->
    <div id="graph-view-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h2 id="graph-modal-title" class="text-xl font-bold text-gray-800"
                    data-translate-key="modalGraphViewTitle">Grafik View</h2>
                <button id="graph-modal-close-button" class="p-2 rounded-full hover:bg-gray-200">
                    <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                </button>
            </div>
            <div id="graph-modal-content" class="space-y-8">
                <div class="bg-white p-4 rounded-lg">
                    <h3 class="text-md font-semibold text-gray-700 mb-4" data-translate-key="incidentEventsChartTitle">
                        Insiden (Kejadian)</h3>
                    <div class="h-80"><canvas id="incident-events-chart"></canvas></div>
                </div>
                <div class="bg-white p-4 rounded-lg">
                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                        data-translate-key="performanceActualChartTitle">Performance (Actual)</h3>
                    <div class="h-80"><canvas id="performance-actual-chart"></canvas></div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // ========== GLOBAL STATE & UTILITIES ==========
        const appState = {
            data: {
                dataDasbor: [],
                performance: []
            },
            currentTheme: localStorage.getItem('theme') || 'light',
            currentLang: localStorage.getItem('language') || 'en',
            cache: {
                key: 'insiden_data_cache_v9', // Changed cache key
                expiry: 30 * 60 * 1000
            },
            lastUpdated: null,
            map: null,
            heatLayer: null,
            allIncidents: [],
            hsePerformanceData: {},
            translations: {}
        };
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzLQpj9qzSFmLuO5-SUl1hHIfC86c4S7SfupeZ5PoQqD_D0soMDpISqL1G2MYpejAmU/exec';

        const { jsPDF } = window.jspdf;

        function showErrorBanner(message) {
            const banner = document.getElementById('error-banner');
            const messageContent = document.getElementById('error-message-content');
            if (banner && messageContent) {
                messageContent.innerHTML = message;
                banner.classList.remove('hidden');
            }
        }

        function updateLastUpdatedTimestamp(timestamp) {
            const el = document.getElementById('last-updated');
            if (!el) return;
            if (timestamp) {
                appState.lastUpdated = timestamp;
                const date = new Date(timestamp);
                const translatedText = appState.translations[appState.currentLang].lastUpdatedText;
                el.textContent = `${translatedText} ${date.toLocaleDateString(appState.currentLang)} ${date.toLocaleTimeString(appState.currentLang)}`;
            } else {
                el.textContent = appState.translations[appState.currentLang].loadingData;
            }
        }

        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number || 0);

        // ========== CACHING FUNCTIONS ==========
        function getCachedData() {
            const cachedItem = localStorage.getItem(appState.cache.key);
            if (!cachedItem) return null;
            try {
                const { data, timestamp } = JSON.parse(cachedItem);
                if (Date.now() - timestamp > appState.cache.expiry) {
                    localStorage.removeItem(appState.cache.key);
                    return null;
                }
                return { data, timestamp };
            } catch (error) {
                localStorage.removeItem(appState.cache.key);
                return null;
            }
        }

        function setCachedData(data) {
            const timestamp = Date.now();
            const itemToCache = { data, timestamp };
            try {
                localStorage.setItem(appState.cache.key, JSON.stringify(itemToCache));
                updateLastUpdatedTimestamp(timestamp);
            } catch (error) {
                console.error(`Error saving cache:`, error);
            }
        }

        // ========== DATA FETCHING (JSONP METHOD) ==========
        function fetchAllData() {
            return new Promise((resolve, reject) => {
                if (APPS_SCRIPT_URL === 'URL_APPS_SCRIPT_ANDA_DI_SINI') {
                    const errorMsg = 'URL Apps Script belum dikonfigurasi.';
                    showErrorBanner(errorMsg);
                    return reject(new Error(errorMsg));
                }

                const callbackName = 'jsonp_callback_insiden_' + Math.round(100000 * Math.random());

                window[callbackName] = function (data) {
                    delete window[callbackName];
                    document.body.removeChild(script);

                    if (data.error) {
                        return reject(new Error(`API Error: ${data.error}. Details: ${data.details || ''}`));
                    }

                    // Map the data to the expected structure
                    const formattedData = {
                        dataDasbor: data.dataDasbor || [],
                        hsePerformance: data.hsePerformance || []
                    };
                    resolve(formattedData);
                };

                const script = document.createElement('script');
                script.src = `${APPS_SCRIPT_URL}?source=insiden&callback=${callbackName}`;

                script.onerror = function () {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    const error = new Error('Permintaan data gagal. Server tidak merespons atau terjadi kesalahan jaringan.');
                    showErrorBanner(`Gagal mengambil data dari server. Pesan: ${error.message}. Silakan coba lagi.`);
                    reject(error);
                };

                document.body.appendChild(script);
            });
        }

        function generateHSEData(incidents) {
            const hseData = {
                safety: [{ Deskripsi: 'First Aid Injury', years: {} }, { Deskripsi: 'Lost Time Injury', years: {} }, { Deskripsi: 'Fatal', years: {} }, { Deskripsi: 'Property Damage', years: {} }, { Deskripsi: 'Near Miss', years: {} }, { Deskripsi: 'Medical & Treatment Injury', years: {} }, { Deskripsi: 'Fire Case', years: {} }, { Deskripsi: 'Penyakit Akibat Kerja (PAK)', years: {} }, { Deskripsi: 'Kejadian Akibat Penyakit Tenaga Kerja (KAPTK)', years: {} }, { Deskripsi: 'TOTAL CASE', years: {} }, { Deskripsi: 'Crude Morbidity Rate (CMR)', years: {} }, { Deskripsi: 'Morbidity Frequency Rate (MFR)', years: {} }],
                performance: [{ Deskripsi: 'Threshold TIFR', years: {} }, { Deskripsi: 'Threshold PDPR', years: {} }, { Deskripsi: 'Threshold AFR', years: {} }, { Deskripsi: 'TIFR', years: {} }, { Deskripsi: 'PDPR', years: {} }, { Deskripsi: 'AFR', years: {} }]
            };

            let years = [...new Set(incidents.map(d => new Date(d.tanggalKejadian).getFullYear()))];
            if (years.length === 0) {
                years.push(new Date().getFullYear());
            }

            const months = ['januari', 'februari', 'maret', 'april', 'mei', 'juni', 'juli', 'agustus', 'september', 'oktober', 'november', 'desember'];

            years.forEach(year => {
                hseData.safety.forEach(item => item.years[year] = {});
                hseData.performance.forEach(item => item.years[year] = {});
                const yearIncidents = incidents.filter(d => new Date(d.tanggalKejadian).getFullYear() === year);

                months.forEach((monthName, monthIndex) => {
                    const monthIncidents = yearIncidents.filter(d => new Date(d.tanggalKejadian).getMonth() === monthIndex);
                    const counts = {
                        'Property Damage': monthIncidents.filter(d => d.kategoriKecelakaan === 'Property Damage').length,
                        'Near Miss': monthIncidents.filter(d => d.kategoriKecelakaan === 'Near Miss').length,
                        'Lost Time Injury': monthIncidents.filter(d => d.kategoriKecelakaan === 'LTI').length,
                        'Medical & Treatment Injury': monthIncidents.filter(d => d.kategoriKecelakaan === 'Non-LTI').length,
                    };
                    hseData.safety.forEach(item => {
                        item.years[year][monthName] = counts[item.Deskripsi] || 0;
                    });
                    hseData.performance.find(i => i.Deskripsi === 'TIFR').years[year][monthName] = (Math.random() * 15000).toFixed(0);
                    hseData.performance.find(i => i.Deskripsi === 'AFR').years[year][monthName] = (Math.random() * 5000).toFixed(0);
                });
            });
            return hseData;
        }

        // ========== CHART & MAP MANAGEMENT ==========
        const chartInstances = {};
        function initializeCharts() {
            const defaultChartOptions = (extraOptions = {}) => ({
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: appState.currentTheme === 'dark' ? '#f1f5f9' : '#1f2937' } } },
                scales: {
                    x: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.2)' } },
                    y: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.2)' } }
                }, ...extraOptions
            });
            const createChart = (id, type, options) => {
                const ctx = document.getElementById(id)?.getContext("2d");
                if (ctx) { if (chartInstances[id]) chartInstances[id].destroy(); chartInstances[id] = new Chart(ctx, { type, data: { labels: [], datasets: [] }, options }); }
            };
            createChart('trenInsidenChart', 'line', defaultChartOptions({ plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }));
            createChart('klasifikasiInsidenChart', 'pie', defaultChartOptions({ plugins: { legend: { position: 'right' } } }));

            createChart('incident-events-chart', 'bar', defaultChartOptions({ scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }));
            createChart('performance-actual-chart', 'line', defaultChartOptions({ scales: { y: { beginAtZero: true } } }));

            // Initialize new charts
            ['jabatanChart', 'hariChart', 'perusahaanChart', 'penyebabLangsungChart', 'penyebabDasarChart', 'unitTerlibatChart', 'masaKerjaChart', 'tipeCederaChart', 'usiaKorbanChart', 'statusKaryawanChart', 'tempatTinggalChart', 'shiftChart'].forEach(id => {
                const type = id.includes('Chart') && (id.includes('perusahaan') || id.includes('Penyebab') || id.includes('tipe') || id.includes('status') || id.includes('shift')) ? 'doughnut' : 'bar';
                createChart(id, type, defaultChartOptions({ plugins: { legend: { display: type === 'doughnut' } } }));
            });
        }

        function initializeMap() {
            if (appState.map) {
                appState.map.remove();
            }
            appState.map = L.map('incident-map').setView([-5.45, 105.26667], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(appState.map);
        }

        // ========== UI UPDATE FUNCTIONS ==========
        function updateUI(data) {
            if (!data) {
                console.warn("Update UI skipped due to no data.");
                return;
            };
            appState.data = data;
            appState.allIncidents = data.dataDasbor || [];
            appState.hsePerformanceData = data.hsePerformance || {};

            updateLaporanDashboard(data.dataDasbor);
            updateHSEPerformanceTab(data.hsePerformance);
            updateMap(data.dataDasbor);
            populateFilters(data.dataDasbor, data.hsePerformance);

            document.querySelectorAll('.component-loading').forEach(el => el.classList.remove('component-loading'));
        }

        function updateLaporanDashboard(insidenData) {
            document.getElementById('total-insiden').textContent = insidenData.length;
            document.getElementById('total-property-damage').textContent = insidenData.filter(d => d.kategoriKecelakaan === 'Property Damage').length;
            document.getElementById('total-injury').textContent = insidenData.filter(d => d.kategoriKecelakaan === 'LTI' || d.kategoriKecelakaan === 'Non-LTI').length;
            document.getElementById('total-near-miss').textContent = insidenData.filter(d => d.kategoriKecelakaan === 'Near Miss').length;

            const monthlyTrend = Array(12).fill(0);
            insidenData.forEach(d => {
                const month = new Date(d.tanggalKejadian).getMonth();
                if (month >= 0 && month < 12) monthlyTrend[month]++;
            });
            if (chartInstances.trenInsidenChart) {
                chartInstances.trenInsidenChart.data = {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'],
                    datasets: [{ label: 'Jumlah Insiden', data: monthlyTrend, borderColor: '#8b5cf6', backgroundColor: 'rgba(139, 92, 246, 0.1)', tension: 0.4, fill: true }]
                };
                chartInstances.trenInsidenChart.update();
            }

            const classificationCounts = insidenData.reduce((acc, d) => {
                const cat = d.kategoriKecelakaan || 'Lainnya';
                acc[cat] = (acc[cat] || 0) + 1;
                return acc;
            }, {});
            if (chartInstances.klasifikasiInsidenChart) {
                chartInstances.klasifikasiInsidenChart.data = {
                    labels: Object.keys(classificationCounts),
                    datasets: [{ data: Object.values(classificationCounts), backgroundColor: ['#ef4444', '#f97316', '#22c55e', '#6b7280', '#3b82f6'] }]
                };
                chartInstances.klasifikasiInsidenChart.update();
            }

            const totalPengobatan = insidenData.reduce((sum, d) => sum + (Number(d.biayaPengobatan) || 0), 0);
            const totalPerbaikan = insidenData.reduce((sum, d) => sum + (Number(d.biayaPerbaikan) || 0), 0);
            const totalTidakLangsung = insidenData.reduce((sum, d) => sum + (Number(d.biayaTidakLangsung) || 0), 0);
            const totalBiaya = totalPengobatan + totalPerbaikan + totalTidakLangsung;

            document.getElementById('biaya-pengobatan').textContent = formatRupiah(totalPengobatan);
            document.getElementById('biaya-perbaikan').textContent = formatRupiah(totalPerbaikan);
            document.getElementById('biaya-tidak-langsung').textContent = formatRupiah(totalTidakLangsung);
            document.getElementById('total-biaya').textContent = formatRupiah(totalBiaya);

            renderTable(insidenData);
            updateAdditionalCharts(insidenData); // Call the new function
        }

        // (NEW) Function to update the 12 additional charts
        function updateAdditionalCharts(insidenData) {
            const updateChart = (chartId, data, label) => {
                if (chartInstances[chartId]) {
                    chartInstances[chartId].data.labels = Object.keys(data);
                    chartInstances[chartId].data.datasets = [{
                        label: label,
                        data: Object.values(data),
                        backgroundColor: ['#3b82f6', '#ef4444', '#f97316', '#22c55e', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#6b7280']
                    }];
                    chartInstances[chartId].update();
                }
            };

            const getTopN = (data, key, n = 5) => {
                const counts = data.reduce((acc, item) => {
                    const value = item[key] || 'N/A';
                    acc[value] = (acc[value] || 0) + 1;
                    return acc;
                }, {});
                return Object.fromEntries(Object.entries(counts).sort(([, a], [, b]) => b - a).slice(0, n));
            };

            updateChart('jabatanChart', getTopN(insidenData, 'jabatan'), 'Insiden per Jabatan');
            updateChart('perusahaanChart', getTopN(insidenData, 'perusahaan'), 'Insiden per Perusahaan');
            updateChart('penyebabLangsungChart', getTopN(insidenData, 'penyebabLangsung'), 'Penyebab Langsung');
            updateChart('penyebabDasarChart', getTopN(insidenData, 'penyebabDasar'), 'Penyebab Dasar');
            updateChart('unitTerlibatChart', getTopN(insidenData, 'unitTerlibat'), 'Unit Terlibat');
            updateChart('masaKerjaChart', getTopN(insidenData, 'masaKerja'), 'Masa Kerja');
            updateChart('tipeCederaChart', getTopN(insidenData, 'tipeCedera'), 'Tipe Cedera');
            updateChart('usiaKorbanChart', getTopN(insidenData, 'usia'), 'Usia Korban');
            updateChart('statusKaryawanChart', getTopN(insidenData, 'statusKaryawan'), 'Status Karyawan');
            updateChart('tempatTinggalChart', getTopN(insidenData, 'tempatTinggal'), 'Tempat Tinggal');
            updateChart('shiftChart', getTopN(insidenData, 'shift'), 'Insiden per Shift');

            // Special handling for 'hariChart' to maintain order
            const hariOrder = appState.currentLang === 'en' ? ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'] : ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const hariCounts = insidenData.reduce((acc, d) => {
                const hari = d.hariKejadian || 'N/A';
                acc[hari] = (acc[hari] || 0) + 1;
                return acc;
            }, {});
            const sortedHariData = {};
            hariOrder.forEach(hari => {
                if (hariCounts[hari]) sortedHariData[hari] = hariCounts[hari];
            });
            updateChart('hariChart', sortedHariData, 'Insiden per Hari');
        }

        function renderTable(insidenData) {
            const tableBody = document.getElementById('laporan-insiden-table-body');
            if (tableBody) {
                tableBody.innerHTML = insidenData.map(row => `
                <tr class="border-b hover:bg-gray-50">
                    <td class="py-3 px-4">${row.id || '-'}</td>
                    <td class="py-3 px-4">${new Date(row.tanggalKejadian).toLocaleDateString('id-ID') || '-'}</td>
                    <td class="py-3 px-4">
                        <a href="#" class="text-purple-600 hover:underline incident-title-link" data-id="${row.id}">${row.judulInsiden || '-'}</a>
                    </td>
                    <td class="py-3 px-4">${row.kategoriKecelakaan || '-'}</td>
                    <td class="py-3 px-4">${row.statusLpi || '-'}</td>
                </tr>
            `).join('');
            }
        }

        function updateHSEPerformanceTab(hseData, yearFilter = 'Semua', searchTerm = '') {
            const safetyTableHead = document.getElementById('hse-safety-table-head');
            const safetyTableBody = document.getElementById('hse-safety-table-body');
            const perfTableHead = document.getElementById('hse-performance-table-head');
            const perfTableBody = document.getElementById('hse-performance-table-body');

            if (!safetyTableHead || !hseData || !hseData.safety || !hseData.safety.length > 0) {
                const emptyHtml = `<tr><td colspan="14" class="text-center p-4">Tidak ada data kinerja untuk ditampilkan.</td></tr>`;
                if (safetyTableBody) safetyTableBody.innerHTML = emptyHtml;
                if (perfTableBody) perfTableBody.innerHTML = emptyHtml;
                return;
            }

            const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const tableHeaderHTML = `
                <tr class="text-xs text-gray-500 uppercase bg-gray-100">
                    <th class="py-3 px-4 font-semibold">Deskripsi</th>
                    ${months.map(m => `<th class="py-3 px-4 font-semibold text-center">${m}</th>`).join('')}
                    <th class="py-3 px-4 font-semibold text-center">YTD</th>
                </tr>`;

            safetyTableHead.innerHTML = tableHeaderHTML;
            perfTableHead.innerHTML = tableHeaderHTML;

            const renderTableRows = (data, year) => {
                return data
                    .filter(row => row.Deskripsi.toLowerCase().includes(searchTerm.toLowerCase()))
                    .map(row => {
                        const yearData = row.years[year] || {};
                        const ytd = Object.values(yearData).reduce((sum, val) => sum + (Number(val) || 0), 0);
                        return `
                        <tr class="border-b">
                            <td class="py-2 px-4 font-medium">${row.Deskripsi}</td>
                            ${months.map(m => {
                            const value = yearData[m.toLowerCase()] || 0;
                            const isHighlight = (row.Deskripsi === 'Property Damage' || row.Deskripsi === 'Near Miss') && value > 0;
                            return `<td class="py-2 px-4 text-center ${isHighlight ? 'table-cell-highlight font-bold' : ''}">${value}</td>`
                        }).join('')}
                            <td class="py-2 px-4 text-center font-bold">${row.Deskripsi.includes('Rate') || row.Deskripsi.includes('Frequency') ? ytd.toFixed(2) : ytd}</td>
                        </tr>`;
                    }).join('');
            };

            const yearsWithData = Object.keys(hseData.safety[0].years);
            const selectedYear = (yearFilter === 'Semua' || !yearsWithData.includes(yearFilter)) ? yearsWithData[0] : yearFilter;

            if (!selectedYear) {
                safetyTableBody.innerHTML = `<tr><td colspan="14" class="text-center p-4">Tidak ada data untuk tahun yang dipilih.</td></tr>`;
                perfTableBody.innerHTML = `<tr><td colspan="14" class="text-center p-4">Tidak ada data untuk tahun yang dipilih.</td></tr>`;
                return;
            }

            safetyTableBody.innerHTML = renderTableRows(hseData.safety, selectedYear);
            perfTableBody.innerHTML = renderTableRows(hseData.performance, selectedYear);
        }


        function updateMap(insidenData) {
            if (!appState.map) return;

            setTimeout(() => {
                appState.map.invalidateSize();

                if (appState.heatLayer) {
                    appState.map.removeLayer(appState.heatLayer);
                    appState.heatLayer = null;
                }

                const points = insidenData
                    .map(d => ({ lat: parseFloat(d.lat), lon: parseFloat(d.lon) }))
                    .filter(p => !isNaN(p.lat) && !isNaN(p.lon))
                    .map(p => [p.lat, p.lon]);

                if (points.length > 0) {
                    appState.heatLayer = L.heatLayer(points, {
                        radius: 25,
                        blur: 15,
                        maxZoom: 18,
                    }).addTo(appState.map);
                }
            }, 100);
        }

        function populateFilters(insidenData, hseData) {
            const incidentYears = ['Semua', ...new Set(insidenData.map(d => new Date(d.tanggalKejadian).getFullYear()))].sort((a, b) => b - a);
            const yearSelectors = ['#filter-year', '#compare-year-a', '#compare-year-b', '#dashboard-filter-year'];
            yearSelectors.forEach(sel => {
                const selector = document.querySelector(sel);
                if (selector) {
                    selector.innerHTML = incidentYears.map(y => `<option value="${y}">${y}</option>`).join('');
                }
            });

            if (hseData && hseData.safety && hseData.safety.length > 0 && hseData.safety[0].years) {
                const hseYears = ['Semua', ...Object.keys(hseData.safety[0].years)].sort((a, b) => b - a);
                const hseYearSelector = document.getElementById('hse-filter-year');
                hseYearSelector.innerHTML = hseYears.map(y => `<option value="${y}">${y}</option>`).join('');
            }

            const months = ['Semua', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const monthSelectors = ['#compare-month-a', '#compare-month-b', '#dashboard-filter-month'];
            monthSelectors.forEach(sel => {
                const selector = document.querySelector(sel);
                if (selector) {
                    selector.innerHTML = months.map((m, i) => `<option value="${sel === '#dashboard-filter-month' ? (i === 0 ? 'Semua' : i - 1) : i}">${m}</option>`).join('');
                }
            });
        }

        function updateComparisonDashboard() {
            const monthA = document.getElementById('compare-month-a').value;
            const yearA = document.getElementById('compare-year-a').value;
            const monthB = document.getElementById('compare-month-b').value;
            const yearB = document.getElementById('compare-year-b').value;

            const dataA = appState.allIncidents.filter(d => {
                const date = new Date(d.tanggalKejadian);
                return date.getFullYear() == yearA && date.getMonth() == monthA;
            });

            const dataB = appState.allIncidents.filter(d => {
                const date = new Date(d.tanggalKejadian);
                return date.getFullYear() == yearB && date.getMonth() == monthB;
            });

            const resultsContainer = document.getElementById('comparison-results');
            const createCard = (title, valueA, valueB) => {
                const diff = valueB - valueA;
                const colorClass = diff > 0 ? 'text-red-500' : diff < 0 ? 'text-green-500' : 'text-gray-500';
                const icon = diff > 0 ? 'trending-up' : diff < 0 ? 'trending-down' : 'minus';
                return `
                    <div class="bg-gray-50 p-3 rounded-lg text-center">
                        <p class="text-sm text-gray-500">${title}</p>
                        <p class="text-2xl font-bold">${valueB}</p>
                        <div class="flex items-center justify-center text-sm ${colorClass}">
                            <i data-lucide="${icon}" class="w-4 h-4 mr-1"></i>
                            <span>${diff} vs. ${valueA}</span>
                        </div>
                    </div>
                `;
            };

            resultsContainer.innerHTML = createCard('Total Insiden', dataA.length, dataB.length) +
                createCard('Property Damage', dataA.filter(d => d.kategoriKecelakaan === 'Property Damage').length, dataB.filter(d => d.kategoriKecelakaan === 'Property Damage').length) +
                createCard('Cedera', dataA.filter(d => ['LTI', 'Non-LTI'].includes(d.kategoriKecelakaan)).length, dataB.filter(d => ['LTI', 'Non-LTI'].includes(d.kategoriKecelakaan)).length) +
                createCard('Near Miss', dataA.filter(d => d.kategoriKecelakaan === 'Near Miss').length, dataB.filter(d => d.kategoriKecelakaan === 'Near Miss').length);

            lucide.createIcons();
        }

        // ========== MODAL FUNCTIONS ==========
        function showIncidentModal(incidentId) {
            const incident = appState.allIncidents.find(d => d.id == incidentId);
            if (!incident) return;

            const modal = document.getElementById('incident-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');

            modalTitle.textContent = incident.judulInsiden;

            const date = new Date(incident.tanggalKejadian);
            const formattedDate = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
            const formattedTime = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

            modalContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Waktu & Lokasi</h4>
                        <p><strong class="text-gray-600">Tanggal & Jam:</strong> ${formattedDate} Pukul ${formattedTime}</p>
                        <p><strong class="text-gray-600">Lokasi:</strong> ${incident.lokasi || '-'}</p>
                        <p><strong class="text-gray-600">Unit Terlibat:</strong> ${incident.unitTerlibat || '-'}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Detail Insiden</h4>
                        <p><strong class="text-gray-600">Kategori Kecelakaan:</strong> ${incident.kategoriKecelakaan || '-'}</p>
                        <p><strong class="text-gray-600">Penyebab Langsung:</strong> ${incident.penyebabLangsung || '-'}</p>
                        <p><strong class="text-gray-600">Penyebab Dasar:</strong> ${incident.penyebabDasar || '-'}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Rincian Korban</h4>
                        <p><strong class="text-gray-600">Kategori Cedera:</strong> ${incident.kategoriCedera || '-'}</p>
                        <p><strong class="text-gray-600">Tipe Cedera:</strong> ${incident.tipeCedera || '-'}</p>
                        <p><strong class="text-gray-600">Bagian Cedera:</strong> ${incident.bagianCedera || '-'}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Karyawan</h4>
                        <p><strong class="text-gray-600">Nama:</strong> ${incident.namaKaryawan || '-'}</p>
                        <p><strong class="text-gray-600">Jabatan:</strong> ${incident.jabatan || '-'}</p>
                        <p><strong class="text-gray-600">Status:</strong> ${incident.statusKaryawan || '-'}</p>
                    </div>
                </div>
                <div class="border-t pt-4">
                    <h4 class="font-semibold text-gray-700 mb-2">Kronologi Singkat</h4>
                    <p>${incident.kronologi || '-'}</p>
                </div>
            `;

            modal.classList.add('active');
        }

        function hideIncidentModal() {
            document.getElementById('incident-modal').classList.remove('active');
        }

        function showGraphModal() {
            const year = document.getElementById('hse-filter-year').value;
            const hseData = appState.hsePerformanceData;
            const yearsWithData = (hseData.safety && hseData.safety.length > 0) ? Object.keys(hseData.safety[0].years) : [];
            if (yearsWithData.length === 0) return;

            const selectedYear = (year === 'Semua' || !yearsWithData.includes(year)) ? yearsWithData[0] : year;

            document.getElementById('graph-modal-title').textContent = `Grafik View - Tahun ${selectedYear}`;

            const months = ['januari', 'februari', 'maret', 'april', 'mei', 'juni', 'juli', 'agustus', 'september', 'oktober', 'november', 'desember'];

            const propDamageData = hseData.safety.find(d => d.Deskripsi === 'Property Damage')?.years[selectedYear] || {};
            const nearMissData = hseData.safety.find(d => d.Deskripsi === 'Near Miss')?.years[selectedYear] || {};

            chartInstances['incident-events-chart'].data = {
                labels: months.map(m => m.charAt(0).toUpperCase() + m.slice(1)),
                datasets: [
                    { label: 'Property Damage', data: months.map(m => propDamageData[m] || 0), backgroundColor: '#ef4444' },
                    { label: 'Near Miss', data: months.map(m => nearMissData[m] || 0), backgroundColor: '#f97316' }
                ]
            };
            chartInstances['incident-events-chart'].update();

            const tifrData = hseData.performance.find(d => d.Deskripsi === 'TIFR')?.years[selectedYear] || {};
            const pdprData = hseData.performance.find(d => d.Deskripsi === 'PDPR')?.years[selectedYear] || {};
            const afrData = hseData.performance.find(d => d.Deskripsi === 'AFR')?.years[selectedYear] || {};

            chartInstances['performance-actual-chart'].data = {
                labels: months.map(m => m.charAt(0).toUpperCase() + m.slice(1)),
                datasets: [
                    { label: 'TIFR', data: months.map(m => tifrData[m] || 0), borderColor: '#ec4899', tension: 0.4 },
                    { label: 'PDPR', data: months.map(m => pdprData[m] || 0), borderColor: '#f59e0b', tension: 0.4 },
                    { label: 'AFR', data: months.map(m => afrData[m] || 0), borderColor: '#3b82f6', tension: 0.4 }
                ]
            };
            chartInstances['performance-actual-chart'].update();

            document.getElementById('graph-view-modal').classList.add('active');
        }

        function hideGraphModal() {
            document.getElementById('graph-view-modal').classList.remove('active');
        }


        // ========== THEME & NAVIGATION ==========
        function setupTabs(tabContainerId) {
            const tabContainer = document.getElementById(tabContainerId); if (!tabContainer) return;
            const tabLinks = tabContainer.querySelectorAll('.tab-link'), tabContents = tabContainer.closest('.bg-white').querySelectorAll('.tab-content');
            tabLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const tabId = link.dataset.tab;
                    tabLinks.forEach(l => { l.classList.remove('border-purple-500', 'text-purple-600', 'active'); l.classList.add('border-transparent', 'text-gray-500'); });
                    link.classList.add('border-purple-500', 'text-purple-600', 'active'); link.classList.remove('border-transparent', 'text-gray-500');
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId + '-content')?.classList.add('active');
                });
            });
        }
        function toggleTheme() {
            appState.currentTheme = appState.currentTheme === "light" ? "dark" : "light";
            document.body.classList.remove("theme-light", "theme-dark");
            document.body.classList.add(`theme-${appState.currentTheme}`);
            localStorage.setItem("theme", appState.currentTheme);
            const themeToggleButton = document.getElementById("theme-toggle");
            if (themeToggleButton) {
                const newIconName = appState.currentTheme === "dark" ? "sun" : "moon";
                themeToggleButton.innerHTML = `<i data-lucide="${newIconName}" class="w-5 h-5 text-gray-600"></i>`;
            }
            lucide.createIcons();
            initializeCharts();
            updateUI(appState.data);
        }

        // ========== EVENT LISTENERS & EXPORT ==========
        function applyDashboardFilters() {
            const year = document.getElementById('dashboard-filter-year').value;
            const month = document.getElementById('dashboard-filter-month').value;

            let filteredData = appState.allIncidents;

            if (year !== 'Semua') {
                filteredData = filteredData.filter(d => new Date(d.tanggalKejadian).getFullYear() == year);
            }
            if (month !== 'Semua') {
                filteredData = filteredData.filter(d => new Date(d.tanggalKejadian).getMonth() == month);
            }

            updateLaporanDashboard(filteredData);
            updateMap(filteredData);
        }

        function resetDashboardFilters() {
            document.getElementById('dashboard-filter-year').value = 'Semua';
            document.getElementById('dashboard-filter-month').value = 'Semua';
            updateLaporanDashboard(appState.allIncidents);
            updateMap(appState.allIncidents);
        }

        function setupEventListeners() {
            setupTabs('laporan-tabs');
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('refresh-button').addEventListener('click', forceRefreshData);
            document.getElementById('compare-button').addEventListener('click', updateComparisonDashboard);

            // Dashboard Filter Listeners
            document.getElementById('dashboard-apply-filter').addEventListener('click', applyDashboardFilters);
            document.getElementById('dashboard-reset-filter').addEventListener('click', resetDashboardFilters);

            // Data Laporan Tab Listeners
            document.getElementById('laporan-insiden-table-body').addEventListener('click', (e) => {
                if (e.target.classList.contains('incident-title-link')) {
                    e.preventDefault();
                    const incidentId = e.target.dataset.id;
                    showIncidentModal(incidentId);
                }
            });
            document.getElementById('filter-year').addEventListener('change', () => {
                const year = document.getElementById('filter-year').value;
                const filteredData = year === 'Semua' ? appState.allIncidents : appState.allIncidents.filter(d => new Date(d.tanggalKejadian).getFullYear() == year);
                renderTable(filteredData);
            });
            document.getElementById('reset-filter-button').addEventListener('click', () => {
                document.getElementById('filter-year').value = 'Semua';
                renderTable(appState.allIncidents);
            });
            document.getElementById('export-csv-button').addEventListener('click', exportToCSV);
            document.getElementById('export-pdf-button').addEventListener('click', exportToPDF);

            // HSE Performance Tab Listeners
            const applyHSEFilter = () => {
                const year = document.getElementById('hse-filter-year').value;
                const term = document.getElementById('hse-search-input').value;
                updateHSEPerformanceTab(appState.hsePerformanceData, year, term);
            };
            document.getElementById('hse-filter-year').addEventListener('change', applyHSEFilter);
            document.getElementById('hse-search-input').addEventListener('input', applyHSEFilter);
            document.getElementById('hse-reset-filter-button').addEventListener('click', () => {
                document.getElementById('hse-filter-year').value = 'Semua';
                document.getElementById('hse-search-input').value = '';
                updateHSEPerformanceTab(appState.hsePerformanceData);
            });
            document.getElementById('view-graph-button').addEventListener('click', showGraphModal);

            // Modal Listeners
            document.getElementById('modal-close-button').addEventListener('click', hideIncidentModal);
            document.getElementById('incident-modal').addEventListener('click', (e) => { if (e.target.id === 'incident-modal') hideIncidentModal(); });
            document.getElementById('graph-modal-close-button').addEventListener('click', hideGraphModal);
            document.getElementById('graph-view-modal').addEventListener('click', (e) => { if (e.target.id === 'graph-view-modal') hideGraphModal(); });

            // Language Switcher Listener
            document.getElementById('language-switcher').addEventListener('change', (e) => {
                setLanguage(e.target.value);
            });
        }

        function exportToCSV() {
            const year = document.getElementById('filter-year').value;
            const dataToExport = year === 'Semua' ? appState.allIncidents : appState.allIncidents.filter(d => new Date(d.tanggalKejadian).getFullYear() == year);
            const csv = Papa.unparse(dataToExport);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `laporan_insiden_${year}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToPDF() {
            const doc = new jsPDF();
            const year = document.getElementById('filter-year').value;
            const dataToExport = year === 'Semua' ? appState.allIncidents : appState.allIncidents.filter(d => new Date(d.tanggalKejadian).getFullYear() == year);

            doc.text(`Laporan Insiden Tahun ${year}`, 14, 16);
            doc.autoTable({
                startY: 20,
                head: [['ID', 'Tanggal', 'Judul Insiden', 'Klasifikasi', 'Status']],
                body: dataToExport.map(row => [row.id, new Date(row.tanggalKejadian).toLocaleDateString('id-ID'), row.judulInsiden, row.kategoriKecelakaan, row.statusLpi]),
            });
            doc.save(`laporan_insiden_${year}.pdf`);
        }

        async function forceRefreshData() {
            const refreshButton = document.getElementById('refresh-button');
            if (!refreshButton) return;
            const icon = refreshButton.firstElementChild;

            if (icon) icon.classList.add('animate-spin');
            refreshButton.disabled = true;

            updateLastUpdatedTimestamp(null);

            try {
                const freshData = await fetchAllData();
                console.log("Forced refresh successful. Updating UI and cache.");
                updateUI(freshData);
                setCachedData(freshData);
            } catch (error) {
                console.log("Forced refresh failed to retrieve new data.", error);
            } finally {
                if (icon) icon.classList.remove('animate-spin');
                refreshButton.disabled = false;
            }
        }

        // ========== LANGUAGE FUNCTIONS (NEW) ==========
        function setLanguage(lang) {
            appState.currentLang = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang;

            const translations = appState.translations[lang];
            if (!translations) return;

            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (translations[key]) {
                    el.innerHTML = translations[key];
                }
            });

            document.querySelectorAll('[data-translate-title-key]').forEach(el => {
                const key = el.dataset.translateTitleKey;
                if (translations[key]) {
                    el.title = translations[key];
                }
            });

            document.querySelectorAll('[data-translate-placeholder-key]').forEach(el => {
                const key = el.dataset.translatePlaceholderKey;
                if (translations[key]) {
                    el.placeholder = translations[key];
                }
            });

            // Re-render dynamic parts
            updateLastUpdatedTimestamp(appState.lastUpdated);
            initializeCharts();
            updateUI(appState.data);
        }

        async function loadTranslations() {
            // In a real app, this would fetch a JSON file. For this example, it's hardcoded.
            appState.translations = {
                en: {
                    pageTitle: "Incident Report - GAMITAS",
                    headerTitle: "GAMITAS - Incident Report",
                    loadingData: "Loading data...",
                    lastUpdatedText: "Last updated:",
                    backButton: "Back",
                    refreshButtonTitle: "Reload Data",
                    themeButtonTitle: "Change Theme",
                    errorBannerTitle: "Failed to Load Data",
                    tabDashboard: "Incident Dashboard",
                    tabDataReport: "Report Data",
                    tabHSEPerformance: "HSE Performance",
                    dashboardFilterTitle: "Dashboard Filter",
                    yearLabel: "Year",
                    monthLabel: "Month",
                    applyFilterButton: "Apply Filter",
                    resetFilterButton: "Reset Filter",
                    resetButton: "Reset",
                    comparisonAnalysisTitle: "Period Comparison Analysis",
                    periodA: "Period A",
                    periodB: "Period B",
                    compareButton: "Compare",
                    totalIncidents: "Total Incidents",
                    propertyDamage: "Property Damage",
                    injury: "Injury",
                    nearMiss: "Near Miss",
                    monthlyTrendTitle: "Monthly Incident Trend",
                    classificationTitle: "Incident Classification",
                    costDetailsTitle: "Incident Cost Details",
                    treatmentCost: "Treatment Cost",
                    repairCost: "Unit Repair Cost",
                    indirectCost: "Indirect Cost",
                    totalCost: "Total Cost",
                    mapTitle: "Incident Distribution Map",
                    dataReportFilterTitle: "Report Filter",
                    downloadCSV: "Download Data (CSV)",
                    downloadPDF: "Download Report (PDF)",
                    tableId: "ID",
                    tableDate: "Date",
                    tableTitle: "Incident Title",
                    tableClassification: "Classification",
                    tableStatus: "Status",
                    hseFilterTitle: "Performance Filter",
                    searchPlaceholder: "Search Description...",
                    viewGraphButton: "View Graph",
                    safetyPerformanceTitle: "Mining Safety Performance",
                    performancesTitle: "Performance's",
                    modalIncidentDetailTitle: "Incident Detail",
                    modalGraphViewTitle: "Graph View",
                    incidentEventsChartTitle: "Incidents (Events)",
                    performanceActualChartTitle: "Performance (Actual)",
                    months: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                    all: "All"
                },
                id: {
                    pageTitle: "Laporan Insiden - GAMITAS",
                    headerTitle: "GAMITAS - Laporan Insiden",
                    loadingData: "Memuat data...",
                    lastUpdatedText: "Terakhir diperbarui:",
                    backButton: "Kembali",
                    refreshButtonTitle: "Muat Ulang Data",
                    themeButtonTitle: "Ganti Tema",
                    errorBannerTitle: "Gagal Memuat Data",
                    tabDashboard: "Dashboard Insiden",
                    tabDataReport: "Data Laporan",
                    tabHSEPerformance: "HSE Performance",
                    dashboardFilterTitle: "Filter Dashboard",
                    yearLabel: "Tahun",
                    monthLabel: "Bulan",
                    applyFilterButton: "Terapkan Filter",
                    resetFilterButton: "Reset Filter",
                    resetButton: "Reset",
                    comparisonAnalysisTitle: "Analisis Perbandingan Periode",
                    periodA: "Periode A",
                    periodB: "Periode B",
                    compareButton: "Bandingkan",
                    totalIncidents: "Total Insiden",
                    propertyDamage: "Property Damage",
                    injury: "Cedera",
                    nearMiss: "Nyaris Celaka",
                    monthlyTrendTitle: "Tren Insiden Bulanan",
                    classificationTitle: "Klasifikasi Insiden",
                    costDetailsTitle: "Rincian Biaya Insiden",
                    treatmentCost: "Biaya Pengobatan",
                    repairCost: "Biaya Perbaikan Unit",
                    indirectCost: "Biaya Tidak Langsung",
                    totalCost: "Total Biaya",
                    mapTitle: "Peta Sebaran Insiden",
                    dataReportFilterTitle: "Filter Laporan",
                    downloadCSV: "Unduh Data (CSV)",
                    downloadPDF: "Unduh Laporan (PDF)",
                    tableId: "ID",
                    tableDate: "Tanggal",
                    tableTitle: "Judul Insiden",
                    tableClassification: "Klasifikasi",
                    tableStatus: "Status",
                    hseFilterTitle: "Filter Kinerja",
                    searchPlaceholder: "Cari Deskripsi...",
                    viewGraphButton: "Lihat Grafik",
                    safetyPerformanceTitle: "Kinerja Keselamatan Pertambangan",
                    performancesTitle: "Performance's",
                    modalIncidentDetailTitle: "Detail Insiden",
                    modalGraphViewTitle: "Grafik View",
                    incidentEventsChartTitle: "Insiden (Kejadian)",
                    performanceActualChartTitle: "Performance (Actual)",
                    months: ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"],
                    all: "Semua"
                },
                ko: {
                    pageTitle: "사고 보고서 - GAMITAS",
                    headerTitle: "GAMITAS - 사고 보고서",
                    loadingData: "데이터 로딩 중...",
                    lastUpdatedText: "마지막 업데이트:",
                    backButton: "뒤로",
                    refreshButtonTitle: "데이터 새로고침",
                    themeButtonTitle: "테마 변경",
                    errorBannerTitle: "데이터 로드 실패",
                    tabDashboard: "사고 대시보드",
                    tabDataReport: "보고서 데이터",
                    tabHSEPerformance: "HSE 성과",
                    dashboardFilterTitle: "대시보드 필터",
                    yearLabel: "년도",
                    monthLabel: "월",
                    applyFilterButton: "필터 적용",
                    resetFilterButton: "필터 초기화",
                    resetButton: "초기화",
                    comparisonAnalysisTitle: "기간 비교 분석",
                    periodA: "기간 A",
                    periodB: "기간 B",
                    compareButton: "비교하기",
                    totalIncidents: "총 사고",
                    propertyDamage: "재산 피해",
                    injury: "부상",
                    nearMiss: "아차 사고",
                    monthlyTrendTitle: "월별 사고 추세",
                    classificationTitle: "사고 분류",
                    costDetailsTitle: "사고 비용 상세",
                    treatmentCost: "치료 비용",
                    repairCost: "장비 수리 비용",
                    indirectCost: "간접 비용",
                    totalCost: "총 비용",
                    mapTitle: "사고 분포도",
                    dataReportFilterTitle: "보고서 필터",
                    downloadCSV: "데이터 다운로드 (CSV)",
                    downloadPDF: "보고서 다운로드 (PDF)",
                    tableId: "ID",
                    tableDate: "날짜",
                    tableTitle: "사고 제목",
                    tableClassification: "분류",
                    tableStatus: "상태",
                    hseFilterTitle: "성과 필터",
                    searchPlaceholder: "설명 검색...",
                    viewGraphButton: "그래프 보기",
                    safetyPerformanceTitle: "광산 안전 성과",
                    performancesTitle: "성과",
                    modalIncidentDetailTitle: "사고 상세 정보",
                    modalGraphViewTitle: "그래프 보기",
                    incidentEventsChartTitle: "사고 (이벤트)",
                    performanceActualChartTitle: "성과 (실제)",
                    months: ["1월", "2월", "3월", "4월", "5월", "6월", "7월", "8월", "9월", "10월", "11월", "12월"],
                    all: "전체"
                }
            };
        }

        // ========== MAIN INITIALIZATION ==========
        async function initializePage() {
            await loadTranslations();
            document.getElementById('language-switcher').value = appState.currentLang;
            setLanguage(appState.currentLang);

            const cached = getCachedData();

            if (cached) {
                console.log("Valid cache found. Rendering initial UI from cache.");
                updateUI(cached.data);
                updateLastUpdatedTimestamp(cached.timestamp);
            } else {
                console.log("No valid cache found. Fetching fresh data from server.");
                await forceRefreshData();
            }
        }


        document.addEventListener('DOMContentLoaded', async function () {
            document.body.classList.add(`theme-${appState.currentTheme}`);
            const themeToggleButton = document.getElementById("theme-toggle");
            if (themeToggleButton) {
                const iconName = appState.currentTheme === 'dark' ? 'sun' : 'moon';
                themeToggleButton.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5 text-gray-600"></i>`;
            }

            lucide.createIcons();
            initializeCharts();
            initializeMap();

            setupEventListeners();

            await initializePage();
        });
    </script>
</body>

</html>