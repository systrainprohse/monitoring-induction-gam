<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-translate-key="pageTitle">Incident Report - GAMITAS</title>

    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Libraries for Map and Export -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/papaparse/5.4.1/papaparse.min.js"></script>


    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --bg-light: #f8fafc;
            --bg-dark: #1e293b;
            --text-light: #1f2937;
            --text-dark: #f1f5f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-light);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* Dark Theme Styles */
        .theme-dark {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .theme-dark .bg-white {
            background-color: #334155 !important;
        }

        .theme-dark .bg-gray-50,
        .theme-dark .bg-gray-100 {
            background-color: #475569 !important;
        }

        .theme-dark .text-gray-800,
        .theme-dark .text-gray-900 {
            color: #f1f5f9 !important;
        }

        .theme-dark .text-gray-700 {
            color: #e2e8f0 !important;
        }

        .theme-dark .text-gray-600 {
            color: #cbd5e1 !important;
        }

        .theme-dark .text-gray-500 {
            color: #94a3b8 !important;
        }

        .theme-dark .border-gray-200,
        .theme-dark .border-b,
        .theme-dark .border-t {
            border-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-100:hover {
            background-color: #475569 !important;
        }

        .theme-dark .hover\:bg-gray-50:hover {
            background-color: #4b5a70 !important;
        }

        .theme-dark .shadow-md,
        .theme-dark .shadow-lg {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }

        .theme-dark input,
        .theme-dark select {
            background-color: #475569;
            border-color: #64748b;
            color: #f1f5f9;
        }

        .theme-dark input::placeholder {
            color: #94a3b8;
        }

        .theme-dark .sidebar-link.active {
            background-color: #5b21b6;
            color: white;
        }

        .theme-dark .tab-link.active {
            color: #a78bfa !important;
            border-color: #a78bfa !important;
        }

        .theme-dark .bg-slate-800 {
            background-color: #0f172a !important;
        }

        .theme-dark .bg-slate-900 {
            background-color: #020617 !important;
        }

        .sidebar-link.active {
            background-color: #f3e8ff;
            color: #9333ea;
            font-weight: 600;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .component-loading {
            position: relative;
            min-height: 100px;
            overflow: hidden;
        }

        .component-loading::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            animation: shimmer 1.5s infinite;
        }

        .theme-dark .component-loading::after {
            background: linear-gradient(90deg, transparent, rgba(100, 116, 139, 0.5), transparent);
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        #incident-map {
            height: 400px;
            border-radius: 0.5rem;
            z-index: 10;
        }

        .theme-dark .leaflet-tile-pane {
            filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7);
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            background-color: var(--bg-light);
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 1000px;
            /* Increased width for graphs */
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-container {
            transform: scale(1);
        }

        .theme-dark .modal-container {
            background-color: var(--bg-dark);
        }

        .table-cell-highlight {
            background-color: rgba(239, 68, 68, 0.2);
            /* Light red */
        }

        .theme-dark .table-cell-highlight {
            background-color: rgba(239, 68, 68, 0.4);
            /* Darker red for dark mode */
        }

        /* Tooltip Styles */
        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .theme-dark .tooltip-text {
            background-color: #f1f5f9;
            color: #1e293b;
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Pagination Styles */
        .pagination-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
        }

        .pagination-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            background-color: #ffffff;
            color: #374151;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .pagination-button:hover:not(:disabled) {
            background-color: #f3f4f6;
        }

        .pagination-button:disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }

        .theme-dark .pagination-button {
            background-color: #4b5563;
            border-color: #6b7280;
            color: #f3f4f6;
        }

        .theme-dark .pagination-button:hover:not(:disabled) {
            background-color: #6b7280;
        }

        @media (max-width: 768px) {
            main {
                margin-left: 0 !important;
            }

            #sidebar {
                transform: translateX(-100%);
            }

            #sidebar.show {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body class="theme-light">

    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed left-0 top-0 h-full w-64 bg-white shadow-lg z-50 transition-transform flex flex-col">
        <div class="p-6 border-b">
            <h1 id="company-name-sidebar" class="text-2xl font-bold text-gray-800">
                <span class="text-purple-600">G</span>AMITAS
            </h1>
            <p class="text-xs text-gray-500">Integrated Safety System</p>
        </div>
        <nav class="mt-4 flex-1 overflow-y-auto">
            <ul class="space-y-1 px-4">
                <li>
                    <a href="./index.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="dashboard">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="./induksi.html"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="induksi">
                        <i data-lucide="user-check" class="w-5 h-5"></i>
                        <span>Induksi</span>
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="pelatihan" data-external-url="./pelatihan.html">
                        <i data-lucide="award" class="w-5 h-5"></i>
                        <span>Pelatihan Internal</span>
                    </a>
                </li>
                <li>
                    <a href="#" class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg"
                        data-page="laporan_insiden">
                        <i data-lucide="file-warning" class="w-5 h-5"></i>
                        <span>Laporan Insiden</span>
                    </a>
                </li>
                <li>
                    <a href="#"
                        class="sidebar-link flex items-center space-x-3 px-4 py-2.5 rounded-lg text-gray-600 hover:bg-gray-100"
                        data-page="observasi">
                        <i data-lucide="search-check" class="w-5 h-5"></i>
                        <span>Laporan Observasi</span>
                    </a>
                </li>
            </ul>
        </nav>
        <div class="p-4 border-t">
            <a href="./index.html"
                class="w-full flex items-center space-x-3 px-4 py-2 rounded-lg text-gray-700 hover:bg-gray-100">
                <i data-lucide="log-out" class="w-5 h-5"></i>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <!-- Mobile Menu Toggle -->
    <button id="mobile-menu-toggle" class="fixed top-4 left-4 z-[60] p-2 rounded-lg bg-white shadow-md md:hidden">
        <i data-lucide="menu" class="w-6 h-6"></i>
    </button>

    <main class="md:ml-64 p-4 sm:p-6 lg:p-8">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-3xl font-bold text-gray-800" data-translate-key="headerTitle">Incident Report</h2>
                <p id="last-updated" class="text-xs text-gray-500" data-translate-key="loadingData">Loading data...</p>
            </div>
            <div class="flex items-center space-x-2">
                <a href="https://docs.google.com/spreadsheets/d/1bFevC9EGzYmyQTLSCMxu53_7sH7Ab24GT4O0A4nZXTA/edit?usp=sharing"
                    target="_blank" class="p-2 rounded-full hover:bg-gray-100" title="Sumber Data"
                    data-translate-title-key="sourceDataButtonTitle">
                    <i data-lucide="database" class="w-5 h-5 text-gray-600"></i>
                </a>
                <button id="refresh-button" class="p-2 rounded-full hover:bg-gray-100" title="Reload Data"
                    data-translate-title-key="refreshButtonTitle">
                    <i data-lucide="refresh-cw" class="w-5 h-5 text-gray-600"></i>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-100" title="Change Theme"
                    data-translate-title-key="themeButtonTitle">
                    <i data-lucide="sun" class="w-5 h-5 text-gray-600"></i>
                </button>
                <div class="relative">
                    <select id="language-switcher" class="p-2 rounded-md border border-gray-300 bg-white text-gray-700">
                        <option value="en" selected>English</option>
                        <option value="id">Indonesia</option>
                        <option value="ko">한국어</option>
                    </select>
                </div>
            </div>
        </header>

        <div id="error-banner" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6" role="alert">
            <p class="font-bold" data-translate-key="errorBannerTitle">Failed to Load Data</p>
            <p id="error-message-content">An error occurred.</p>
        </div>

        <div id="laporan-page" class="page-content active">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex space-x-6 overflow-x-auto" aria-label="Tabs" id="laporan-tabs">
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-purple-500 px-1 pb-4 text-sm font-medium text-purple-600 active"
                            data-tab="dashboard-laporan" data-translate-key="tabDashboard">Incident Dashboard</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="data-laporan" data-translate-key="tabDataReport">Report Data</a>
                        <a href="#"
                            class="tab-link shrink-0 border-b-2 border-transparent px-1 pb-4 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700"
                            data-tab="hse-performance" data-translate-key="tabHSEPerformance">HSE Performance</a>
                    </nav>
                </div>
                <div class="mt-6">
                    <div id="dashboard-laporan-content" class="tab-content active">
                        <div class="space-y-6">

                            <!-- Dashboard Filter Section -->
                            <div class="bg-white p-6 rounded-lg card">
                                <h3 class="text-md font-semibold text-gray-700 mb-4 flex items-center"><i
                                        data-lucide="filter" class="w-5 h-5 mr-2"></i><span
                                        data-translate-key="dashboardFilterTitle">Dashboard Filter</span></h3>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                    <div>
                                        <label for="dashboard-filter-year" class="text-sm font-medium text-gray-600"
                                            data-translate-key="yearLabel">Year</label>
                                        <select id="dashboard-filter-year"
                                            class="w-full p-2 border rounded-md mt-1"></select>
                                    </div>
                                    <div>
                                        <label for="dashboard-filter-month" class="text-sm font-medium text-gray-600"
                                            data-translate-key="monthLabel">Month</label>
                                        <select id="dashboard-filter-month"
                                            class="w-full p-2 border rounded-md mt-1"></select>
                                    </div>
                                    <button id="dashboard-apply-filter"
                                        class="md:col-start-3 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 h-10"
                                        data-translate-key="applyFilterButton">Apply Filter</button>
                                    <button id="dashboard-reset-filter"
                                        class="bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 h-10"
                                        data-translate-key="resetFilterButton">Reset Filter</button>
                                </div>
                            </div>

                            <!-- Period Comparison Section (Functionality can be enhanced later) -->


                            <!-- Summary Cards -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                                <div class="bg-blue-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-blue-700" data-translate-key="totalIncidents">Total Incidents
                                    </p>
                                    <p id="total-insiden" class="text-3xl font-bold text-blue-900">-</p>
                                </div>
                                <div class="bg-red-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-red-700" data-translate-key="propertyDamage">Property Damage
                                    </p>
                                    <p id="total-property-damage" class="text-3xl font-bold text-red-900">-</p>
                                </div>
                                <div class="bg-orange-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-orange-700" data-translate-key="fatality">Fatality</p>
                                    <p id="total-fatality" class="text-3xl font-bold text-orange-900">-</p>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg card component-loading">
                                    <p class="text-sm text-green-700" data-translate-key="nearMiss">Near Miss</p>
                                    <p id="total-near-miss" class="text-3xl font-bold text-green-900">-</p>
                                </div>
                            </div>

                            <!-- Main Dashboard Grid -->
                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                                        data-translate-key="monthlyTrendTitle">Monthly Incident Trend</h3>
                                    <div class="h-[32rem]"><canvas id="trenInsidenChart"></canvas></div>
                                </div>
                                <div class="space-y-6">
                                    <div class="bg-white p-6 rounded-lg card component-loading">
                                        <h3 class="text-md font-semibold text-gray-700 mb-4"
                                            data-translate-key="classificationTitle">Incident Classification</h3>
                                        <div class="h-80 flex items-center justify-center"><canvas
                                                id="klasifikasiInsidenChart"></canvas></div>
                                    </div>
                                    <div id="rincian-biaya-card" class="bg-white p-6 rounded-lg card component-loading">
                                        <h3 class="text-md font-semibold text-gray-700 mb-4"
                                            data-translate-key="costDetailsTitle">Incident Cost Details</h3>
                                        <div class="space-y-3">
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p class="text-sm text-gray-500" data-translate-key="treatmentCost">
                                                        Treatment Cost</p>
                                                    <p id="biaya-pengobatan" class="font-bold text-gray-800 text-lg">-
                                                    </p>
                                                </div>
                                                <div class="bg-green-100 text-green-600 p-2 rounded-full">
                                                    <i data-lucide="check-circle" class="w-5 h-5"></i>
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p class="text-sm text-gray-500" data-translate-key="repairCost">
                                                        Unit Repair Cost</p>
                                                    <p id="biaya-perbaikan" class="font-bold text-gray-800 text-lg">-
                                                    </p>
                                                </div>
                                                <div class="bg-blue-100 text-blue-600 p-2 rounded-full">
                                                    <i data-lucide="settings" class="w-5 h-5"></i>
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <div>
                                                    <p class="text-sm text-gray-500" data-translate-key="indirectCost">
                                                        Indirect Cost</p>
                                                    <p id="biaya-tidak-langsung"
                                                        class="font-bold text-gray-800 text-lg">-</p>
                                                </div>
                                                <div class="bg-yellow-100 text-yellow-600 p-2 rounded-full">
                                                    <i data-lucide="zap" class="w-5 h-5"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div
                                            class="mt-4 flex justify-between items-center p-4 bg-slate-800 text-white rounded-lg">
                                            <div>
                                                <p class="text-sm font-medium" data-translate-key="totalCost">Total
                                                    Cost</p>
                                                <p id="total-biaya" class="font-bold text-xl">-</p>
                                            </div>
                                            <div class="text-slate-300">
                                                <i data-lucide="dollar-sign" class="w-7 h-7"></i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- NEW: Additional Charts Grid -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                <!-- Chart placeholders -->
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitlePosition">Incidents by Position</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipPosition">Shows
                                                the top 5 positions with the most incidents.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="jabatanChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleDay">Incidents by Day</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipDay">Distribution
                                                of incidents by day of the week.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="hariChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleCompany">Incidents by Company</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipCompany">Number
                                                of incidents occurring in each company.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="perusahaanChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleDirectCause">Direct Cause</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text"
                                                data-translate-key="tooltipDirectCause">Categories
                                                of direct causes of incidents.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="penyebabLangsungChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleRootCause">Root Cause</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipRootCause">Systemic
                                                factors or root problems leading to direct causes.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="penyebabDasarChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleUnit">Unit Involved</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipUnit">Types of units
                                                or
                                                vehicles most frequently involved in incidents.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="unitTerlibatChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleWorkExperience">Work Experience</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text"
                                                data-translate-key="tooltipWorkExperience">Distribution of incidents
                                                based on employee's length of service.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="masaKerjaChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleInjuryType">Injury Type</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipInjuryType">Most
                                                common types of injuries.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="tipeCederaChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleVictimAge">Victim Age</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipVictimAge">Age
                                                distribution of victims involved in incidents.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="usiaKorbanChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleEmployeeStatus">Employee Status</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipEmployeeStatus">Number
                                                of incidents by employment status.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="statusKaryawanChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleResidence">Residence</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text"
                                                data-translate-key="tooltipResidence">Distribution
                                                of employees' places of origin involved in incidents.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="tempatTinggalChart"></canvas></div>
                                </div>
                                <div class="bg-white p-6 rounded-lg card component-loading">
                                    <h3
                                        class="text-md font-semibold text-gray-700 mb-4 flex items-center justify-between">
                                        <span data-translate-key="chartTitleShift">Incidents per Shift</span>
                                        <div class="tooltip-container">
                                            <i data-lucide="info" class="w-4 h-4 text-gray-400"></i>
                                            <span class="tooltip-text" data-translate-key="tooltipShift">Number of
                                                incidents
                                                occurring on day and night shifts.</span>
                                        </div>
                                    </h3>
                                    <div class="h-80"><canvas id="shiftChart"></canvas></div>
                                </div>
                            </div>

                            <!-- Incident Map -->
                            <div class="bg-white p-6 rounded-lg card component-loading">
                                <h3 class="text-md font-semibold text-gray-700 mb-4 flex items-center"><i
                                        data-lucide="map-pin" class="w-5 h-5 mr-2"></i><span
                                        data-translate-key="mapTitle">Incident Distribution Map</span></h3>
                                <div id="incident-map"></div>
                            </div>
                        </div>
                    </div>
                    <div id="data-laporan-content" class="tab-content">
                        <!-- Data Export Filters -->
                        <div
                            class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4 p-4 bg-gray-50 rounded-lg">
                            <div class="flex items-center gap-4">
                                <h3 class="text-lg font-semibold" data-translate-key="dataReportFilterTitle">Report
                                    Filter
                                </h3>
                                <!-- Filter dihilangkan karena paginasi lebih efisien -->
                            </div>
                            <div class="flex items-center gap-2">
                                <button id="export-csv-button"
                                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 flex items-center space-x-2"><i
                                        data-lucide="file-spreadsheet"></i><span
                                        data-translate-key="downloadCSV">Download
                                        Data (CSV)</span></button>
                                <button id="export-pdf-button"
                                    class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center space-x-2"><i
                                        data-lucide="file-text"></i><span data-translate-key="downloadPDF">Download
                                        Report
                                        (PDF)</span></button>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left">
                                <thead>
                                    <tr class="text-xs text-gray-500 uppercase border-b">
                                        <th class="py-3 px-4" data-translate-key="tableId">ID</th>
                                        <th class="py-3 px-4" data-translate-key="tableDate">Date</th>
                                        <th class="py-3 px-4" data-translate-key="tableTitle">Incident Title</th>
                                        <th class="py-3 px-4" data-translate-key="tableClassification">Classification
                                        </th>
                                        <th class="py-3 px-4" data-translate-key="tableStatus">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="laporan-insiden-table-body" class="text-sm text-gray-700"></tbody>
                            </table>
                        </div>
                        <!-- Pagination Controls -->
                        <div id="pagination-controls-container" class="pagination-controls">
                            <button id="prev-page-button" class="pagination-button">&laquo; Previous</button>
                            <span id="page-info">Page 1 of 1</span>
                            <button id="next-page-button" class="pagination-button">Next &raquo;</button>
                        </div>
                    </div>
                    <!-- UPDATED: HSE Performance Tab Content -->
                    <div id="hse-performance-content" class="tab-content">
                        <div class="space-y-6">
                            <div
                                class="flex flex-col sm:flex-row justify-between items-center gap-4 p-4 bg-gray-50 rounded-lg">
                                <div class="flex items-center gap-4">
                                    <h3 class="text-lg font-semibold" data-translate-key="hseFilterTitle">Performance
                                        Filter
                                    </h3>
                                    <select id="hse-filter-year" class="p-2 border rounded-md"></select>
                                    <input type="text" id="hse-search-input" placeholder="Search Description..."
                                        data-translate-placeholder-key="searchPlaceholder"
                                        class="p-2 border rounded-md">
                                    <button id="hse-reset-filter-button"
                                        class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700"
                                        data-translate-key="resetButton">Reset</button>
                                </div>
                                <button id="view-graph-button"
                                    class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center space-x-2">
                                    <i data-lucide="bar-chart-2"></i><span data-translate-key="viewGraphButton">View
                                        Graph</span>
                                </button>
                            </div>

                            <div class="overflow-x-auto bg-white rounded-lg shadow-md p-4">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800"
                                    data-translate-key="safetyPerformanceTitle">Mining Safety Performance</h3>
                                <table class="w-full text-left text-sm">
                                    <thead id="hse-safety-table-head"></thead>
                                    <tbody id="hse-safety-table-body" class="text-gray-700"></tbody>
                                </table>
                            </div>

                            <div class="overflow-x-auto bg-white rounded-lg shadow-md p-4">
                                <h3 class="text-xl font-semibold mb-4 text-gray-800"
                                    data-translate-key="performancesTitle">Performance's</h3>
                                <table class="w-full text-left text-sm">
                                    <thead id="hse-performance-table-head"></thead>
                                    <tbody id="hse-performance-table-body" class="text-gray-700"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Password Modal -->
    <div id="password-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[101] p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h4 class="font-bold text-lg">Akses Terbatas</h4>
                <button class="modal-close-btn text-gray-500 hover:text-gray-800 p-2 rounded-full"><i data-lucide="x"
                        class="w-5 h-5"></i></button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Silakan masukkan password untuk mengakses halaman ini.</p>
            <form id="password-form">
                <div>
                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="password-input"
                        class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                        required>
                    <p id="password-error" class="text-red-500 text-sm mt-1 hidden">Password salah!</p>
                </div>
                <div class="flex gap-2 pt-4">
                    <button type="submit"
                        class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">Buka</button>
                    <button type="button"
                        class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-400 modal-close-btn">Batal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Incident Detail Modal -->
    <div id="incident-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800"
                    data-translate-key="modalIncidentDetailTitle">Incident Detail</h2>
                <button id="modal-close-button" class="p-2 rounded-full hover:bg-gray-200">
                    <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                </button>
            </div>
            <div id="modal-content" class="space-y-6 text-sm"></div>
        </div>
    </div>

    <!-- Graph View Modal -->
    <div id="graph-view-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-4 border-b pb-4">
                <h2 id="graph-modal-title" class="text-xl font-bold text-gray-800"
                    data-translate-key="modalGraphViewTitle">Graph View</h2>
                <button id="graph-modal-close-button" class="p-2 rounded-full hover:bg-gray-200">
                    <i data-lucide="x" class="w-6 h-6 text-gray-600"></i>
                </button>
            </div>
            <div id="graph-modal-content" class="space-y-8">
                <div class="bg-white p-4 rounded-lg">
                    <h3 class="text-md font-semibold text-gray-700 mb-4" data-translate-key="incidentEventsChartTitle">
                        Safety Performance (Events)</h3>
                    <div class="h-80"><canvas id="incident-events-chart"></canvas></div>
                </div>
                <div class="bg-white p-4 rounded-lg">
                    <h3 class="text-md font-semibold text-gray-700 mb-4"
                        data-translate-key="performanceActualChartTitle">Performance Indicators (Rates)</h3>
                    <div class="h-80"><canvas id="performance-actual-chart"></canvas></div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // ========== GLOBAL STATE & UTILITIES ==========
        const appState = {
            fullChartData: null,
            tableData: [],
            hsePerformanceData: [],
            pagination: {
                currentPage: 1,
                totalPages: 1,
                totalData: 0,
            },
            currentTheme: localStorage.getItem('theme') || 'light',
            currentLang: localStorage.getItem('language') || 'en',
            cache: {
                key: 'insiden_chart_data_cache_v12',
                expiry: 30 * 60 * 1000
            },
            lastUpdated: null,
            map: null,
            heatLayer: null,
            translations: {},
            targetPage: null,
            targetUrl: null,
        };

        const API_URL = 'https://script.google.com/macros/s/AKfycbxxPAy1dkhqUc0sQDHYJBgijKRIk49QfJlYR_iNcSYEAv6iX0Zs-Tc3UIlVqTFLWQjNaw/exec';

        const { jsPDF } = window.jspdf;

        function showErrorBanner(message) {
            const banner = document.getElementById('error-banner');
            const messageContent = document.getElementById('error-message-content');
            if (banner && messageContent) {
                messageContent.innerHTML = message;
                banner.classList.remove('hidden');
            }
        }

        function updateLastUpdatedTimestamp(timestamp) {
            const el = document.getElementById('last-updated');
            if (!el) return;
            if (timestamp) {
                appState.lastUpdated = timestamp;
                const date = new Date(timestamp);
                const translatedText = appState.translations[appState.currentLang]?.lastUpdatedText || 'Last updated:';
                el.textContent = `${translatedText} ${date.toLocaleDateString(appState.currentLang)} ${date.toLocaleTimeString(appState.currentLang)}`;
            } else {
                el.textContent = appState.translations[appState.currentLang]?.loadingData || 'Loading data...';
            }
        }

        const formatRupiah = (number) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(number || 0);

        // ========== CACHING FUNCTIONS (FOR CHART DATA) ==========
        function getCachedData() {
            const cachedItem = localStorage.getItem(appState.cache.key);
            if (!cachedItem) return null;
            try {
                const { data, timestamp } = JSON.parse(cachedItem);
                if (Date.now() - timestamp > appState.cache.expiry) {
                    localStorage.removeItem(appState.cache.key);
                    return null;
                }
                return { data, timestamp };
            } catch (error) {
                localStorage.removeItem(appState.cache.key);
                return null;
            }
        }

        function setCachedData(data) {
            const timestamp = Date.now();
            const itemToCache = { data, timestamp };
            try {
                localStorage.setItem(appState.cache.key, JSON.stringify(itemToCache));
                updateLastUpdatedTimestamp(timestamp);
            } catch (error) {
                console.error(`Error saving cache:`, error);
            }
        }

        // ========== DATA FETCHING (JSONP METHOD) ==========
        function fetchData(action, params = {}) {
            return new Promise((resolve, reject) => {
                const callbackName = `jsonp_callback_${action}_` + Math.round(100000 * Math.random());

                window[callbackName] = function (data) {
                    delete window[callbackName];
                    document.body.removeChild(script);

                    if (data.error) {
                        return reject(new Error(`API Error: ${data.error}. Details: ${data.details || ''}`));
                    }
                    resolve(data);
                };

                const urlParams = new URLSearchParams(params);
                urlParams.append('action', action);
                urlParams.append('callback', callbackName);

                const script = document.createElement('script');
                script.src = `${API_URL}?${urlParams.toString()}`;

                script.onerror = function () {
                    delete window[callbackName];
                    document.body.removeChild(script);
                    const error = new Error('Permintaan data gagal. Server tidak merespons atau terjadi kesalahan jaringan.');
                    showErrorBanner(`Gagal mengambil data dari server. Pesan: ${error.message}. Silakan coba lagi.`);
                    reject(error);
                };

                document.body.appendChild(script);
            });
        }


        // ========== CHART & MAP MANAGEMENT ==========
        const chartInstances = {};
        function initializeCharts() {
            const defaultChartOptions = (extraOptions = {}) => ({
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: appState.currentTheme === 'dark' ? '#f1f5f9' : '#1f2937' } } },
                scales: {
                    x: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.2)' } },
                    y: { ticks: { color: appState.currentTheme === 'dark' ? '#cbd5e1' : '#1f2937' }, grid: { color: 'rgba(128, 128, 128, 0.2)' } }
                }, ...extraOptions
            });
            const createChart = (id, type, options) => {
                const ctx = document.getElementById(id)?.getContext("2d");
                if (ctx) { if (chartInstances[id]) chartInstances[id].destroy(); chartInstances[id] = new Chart(ctx, { type, data: { labels: [], datasets: [] }, options }); }
            };

            // Inisialisasi grafik dengan tipe yang sudah ditentukan
            createChart('trenInsidenChart', 'line', defaultChartOptions({ plugins: { legend: { display: true, position: 'top' } }, scales: { y: { beginAtZero: true } } }));
            createChart('klasifikasiInsidenChart', 'pie', defaultChartOptions({ plugins: { legend: { position: 'right' } } }));
            createChart('incident-events-chart', 'bar', defaultChartOptions({ scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } } }));
            createChart('performance-actual-chart', 'line', defaultChartOptions({ scales: { y: { beginAtZero: true } } }));

            // Variasi Grafik
            createChart('jabatanChart', 'bar', defaultChartOptions({ indexAxis: 'y', plugins: { legend: { display: false } } }));
            createChart('hariChart', 'radar', defaultChartOptions({ plugins: { legend: { display: false } } })); // Diubah ke Radar
            createChart('perusahaanChart', 'polarArea', defaultChartOptions()); // Diubah ke Polar Area
            createChart('penyebabLangsungChart', 'bar', defaultChartOptions({ plugins: { legend: { display: false } } }));
            createChart('penyebabDasarChart', 'bar', defaultChartOptions({ plugins: { legend: { display: false } } }));
            createChart('unitTerlibatChart', 'bar', defaultChartOptions({ indexAxis: 'y', plugins: { legend: { display: false } } }));
            createChart('masaKerjaChart', 'bar', defaultChartOptions());
            createChart('tipeCederaChart', 'doughnut', defaultChartOptions());
            createChart('usiaKorbanChart', 'line', defaultChartOptions({ plugins: { legend: { display: false } } }));
            createChart('statusKaryawanChart', 'pie', defaultChartOptions()); // Diubah ke Pie
            createChart('tempatTinggalChart', 'bar', defaultChartOptions());
            createChart('shiftChart', 'pie', defaultChartOptions()); // Diubah ke Pie
        }

        function initializeMap() {
            if (appState.map) {
                appState.map.remove();
            }
            appState.map = L.map('incident-map').setView([-5.45, 105.26667], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '© OpenStreetMap contributors'
            }).addTo(appState.map);
        }

        // ========== UI UPDATE FUNCTIONS ==========
        function updateDashboardUI(data) {
            if (!data) {
                console.warn("Update Dashboard UI skipped due to no data.");
                return;
            }

            // Update Summary Cards
            document.getElementById('total-insiden').textContent = data.summary.totalInsiden;
            document.getElementById('total-property-damage').textContent = data.summary.totalPropertyDamage;
            document.getElementById('total-fatality').textContent = data.summary.totalFatality;
            document.getElementById('total-near-miss').textContent = data.summary.totalNearMiss;

            // Update Costs
            document.getElementById('biaya-pengobatan').textContent = formatRupiah(data.costs.pengobatan);
            document.getElementById('biaya-perbaikan').textContent = formatRupiah(data.costs.perbaikan);
            document.getElementById('biaya-tidak-langsung').textContent = formatRupiah(data.costs.tidakLangsung);
            document.getElementById('total-biaya').textContent = formatRupiah(data.costs.total);

            // Update Charts using full data for trends, and filtered data for others
            updateAllCharts(data);

            // Update Map
            updateMap(data.mapPoints);

            // Populate Filters if not already populated
            if (appState.fullChartData) {
                populateFilters(appState.fullChartData.monthlyTrend);
            }

            document.querySelectorAll('.component-loading').forEach(el => el.classList.remove('component-loading'));
        }

        function updateAllCharts(chartData) {
            const yearFilter = document.getElementById('dashboard-filter-year').value;

            // Monthly Trend Chart
            if (chartInstances.trenInsidenChart && appState.fullChartData) {
                const trendData = appState.fullChartData.monthlyTrend;
                const datasets = [];
                const colors = ['#8b5cf6', '#ef4444', '#22c55e', '#f97316', '#3b82f6'];
                let colorIndex = 0;

                if (yearFilter === 'Semua') {
                    for (const year in trendData) {
                        datasets.push({
                            label: `Tahun ${year}`,
                            data: trendData[year],
                            borderColor: colors[colorIndex % colors.length],
                            backgroundColor: 'transparent',
                            tension: 0.4,
                            fill: false
                        });
                        colorIndex++;
                    }
                } else {
                    datasets.push({
                        label: `Jumlah Insiden ${yearFilter}`,
                        data: trendData[yearFilter] || Array(12).fill(0),
                        borderColor: '#8b5cf6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    });
                }

                chartInstances.trenInsidenChart.data = {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'],
                    datasets: datasets
                };
                chartInstances.trenInsidenChart.update();
            }

            // Other charts based on filtered data
            const updateChart = (chartId, data, label) => {
                if (chartInstances[chartId] && data) {
                    chartInstances[chartId].data.labels = Object.keys(data);
                    chartInstances[chartId].data.datasets = [{
                        label: label,
                        data: Object.values(data),
                        backgroundColor: ['#3b82f6', '#ef4444', '#f97316', '#22c55e', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981', '#6b7280']
                    }];
                    chartInstances[chartId].update();
                }
            };

            updateChart('klasifikasiInsidenChart', chartData.classification, 'Klasifikasi');
            updateChart('jabatanChart', chartData.byJabatan, 'Insiden per Jabatan');
            updateChart('perusahaanChart', chartData.byPerusahaan, 'Insiden per Perusahaan');
            updateChart('penyebabLangsungChart', chartData.byPenyebabLangsung, 'Penyebab Langsung');
            updateChart('penyebabDasarChart', chartData.byPenyebabDasar, 'Penyebab Dasar');
            updateChart('unitTerlibatChart', chartData.byUnitTerlibat, 'Unit Terlibat');
            updateChart('masaKerjaChart', chartData.byMasaKerja, 'Masa Kerja');
            updateChart('tipeCederaChart', chartData.byTipeCedera, 'Tipe Cedera');
            updateChart('usiaKorbanChart', chartData.byUsia, 'Usia Korban');
            updateChart('statusKaryawanChart', chartData.byStatusKaryawan, 'Status Karyawan');
            updateChart('tempatTinggalChart', chartData.byTempatTinggal, 'Tempat Tinggal');
            updateChart('shiftChart', chartData.byShift, 'Insiden per Shift');

            // Special handling for Radar Chart
            const hariOrder = appState.currentLang === 'en' ? ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'] : ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
            const sortedHariLabels = [];
            const sortedHariData = [];
            hariOrder.forEach(hari => {
                if (chartData.byHari[hari]) {
                    sortedHariLabels.push(hari);
                    sortedHariData.push(chartData.byHari[hari]);
                }
            });
            if (chartInstances.hariChart) {
                chartInstances.hariChart.data = {
                    labels: sortedHariLabels,
                    datasets: [{
                        label: 'Insiden per Hari',
                        data: sortedHariData,
                        backgroundColor: 'rgba(139, 92, 246, 0.2)',
                        borderColor: '#8b5cf6',
                        pointBackgroundColor: '#8b5cf6'
                    }]
                };
                chartInstances.hariChart.update();
            }
        }

        function renderTable(paginatedData) {
            appState.tableData = paginatedData.data;
            appState.pagination.currentPage = paginatedData.page;
            appState.pagination.totalPages = paginatedData.totalPages;
            appState.pagination.totalData = paginatedData.totalData;

            const tableBody = document.getElementById('laporan-insiden-table-body');
            if (tableBody) {
                if (paginatedData.data.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4">Tidak ada data untuk ditampilkan.</td></tr>`;
                } else {
                    tableBody.innerHTML = paginatedData.data.map(row => `
                        <tr class="border-b hover:bg-gray-50">
                            <td class="py-3 px-4">${row.id || '-'}</td>
                            <td class="py-3 px-4">${new Date(row.tanggalKejadian).toLocaleDateString('id-ID') || '-'}</td>
                            <td class="py-3 px-4">
                                <a href="#" class="text-purple-600 hover:underline incident-title-link" data-id="${row.id}">${row.judulInsiden || '-'}</a>
                            </td>
                            <td class="py-3 px-4">${row.kategoriKecelakaan || '-'}</td>
                            <td class="py-3 px-4">${row.statusLpi || '-'}</td>
                        </tr>
                    `).join('');
                }
            }
            renderPaginationControls();
        }

        function renderPaginationControls() {
            const { currentPage, totalPages } = appState.pagination;
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prev-page-button').disabled = currentPage <= 1;
            document.getElementById('next-page-button').disabled = currentPage >= totalPages;
        }

        function updateHSEPerformanceTab(hseData, yearFilter = 'Semua', searchTerm = '') {
            appState.hsePerformanceData = hseData;
            const safetyTableHead = document.getElementById('hse-safety-table-head');
            const safetyTableBody = document.getElementById('hse-safety-table-body');
            const perfTableHead = document.getElementById('hse-performance-table-head');
            const perfTableBody = document.getElementById('hse-performance-table-body');

            if (!safetyTableHead || !hseData || hseData.length === 0) {
                const emptyHtml = `<tr><td colspan="14" class="text-center p-4">Tidak ada data kinerja untuk ditampilkan.</td></tr>`;
                if (safetyTableBody) safetyTableBody.innerHTML = emptyHtml;
                if (perfTableBody) perfTableBody.innerHTML = emptyHtml;
                return;
            }

            const safetyMetrics = ['First Aid Injury', 'Lost Time Injury', 'Fatal', 'Property Damage', 'Near Miss', 'Medical & Treatment Injury', 'Fire Case', 'Penyakit Akibat Kerja (PAK)', 'Kejadian Akibat Penyakit Tenaga Kerja (KAPTK)', 'TOTAL CASE'];
            const performanceMetrics = ['TIFR', 'PDPR', 'AFR', 'Threshold TIFR', 'Threshold PDPR', 'Threshold AFR'];

            const yearsWithData = ['Semua', ...new Set(hseData.map(d => d.year))].sort((a, b) => b - a);
            const hseYearSelector = document.getElementById('hse-filter-year');
            if (hseYearSelector.options.length === 0) {
                hseYearSelector.innerHTML = yearsWithData.map(y => `<option value="${y}">${y}</option>`).join('');
            }

            const selectedYear = (yearFilter === 'Semua' || !yearsWithData.includes(parseInt(yearFilter))) ? Math.max(...yearsWithData.filter(y => y !== 'Semua')) : parseInt(yearFilter);

            const yearData = hseData.filter(d => d.year == selectedYear);
            const safetyData = yearData.filter(d => safetyMetrics.includes(d.deskripsi) && d.deskripsi.toLowerCase().includes(searchTerm.toLowerCase()));
            const performanceData = yearData.filter(d => performanceMetrics.includes(d.deskripsi) && d.deskripsi.toLowerCase().includes(searchTerm.toLowerCase()));

            const months = ['januari', 'februari', 'maret', 'april', 'mei', 'juni', 'juli', 'agustus', 'september', 'oktober', 'november', 'desember'];
            const tableHeaderHTML = `
                <tr class="text-xs text-gray-500 uppercase bg-gray-100">
                    <th class="py-3 px-4 font-semibold">Deskripsi</th>
                    ${months.map(m => `<th class="py-3 px-4 font-semibold text-center">${m.charAt(0).toUpperCase() + m.slice(1)}</th>`).join('')}
                    <th class="py-3 px-4 font-semibold text-center">YTD</th>
                </tr>`;

            safetyTableHead.innerHTML = tableHeaderHTML;
            perfTableHead.innerHTML = tableHeaderHTML;

            const renderTableRows = (data) => {
                if (data.length === 0) return `<tr><td colspan="14" class="text-center p-4">Tidak ada data untuk filter ini.</td></tr>`;
                return data.map(row => {
                    return `
                        <tr class="border-b">
                            <td class="py-2 px-4 font-medium">${row.deskripsi}</td>
                            ${months.map(m => `<td class="py-2 px-4 text-center">${row[m] || 0}</td>`).join('')}
                            <td class="py-2 px-4 text-center font-bold">${row.ytd || 0}</td>
                        </tr>`;
                }).join('');
            };

            safetyTableBody.innerHTML = renderTableRows(safetyData);
            perfTableBody.innerHTML = renderTableRows(performanceData);
        }

        function updateMap(mapPoints) {
            if (!appState.map || !mapPoints) return;

            setTimeout(() => {
                const mapContainer = document.getElementById('incident-map');
                if (mapContainer.offsetWidth > 0 && mapContainer.offsetHeight > 0) {
                    appState.map.invalidateSize();

                    if (appState.heatLayer) {
                        appState.map.removeLayer(appState.heatLayer);
                        appState.heatLayer = null;
                    }

                    const points = mapPoints.map(p => [p.lat, p.lon]);

                    if (points.length > 0) {
                        try {
                            appState.heatLayer = L.heatLayer(points, {
                                radius: 25,
                                blur: 15,
                                maxZoom: 18,
                            }).addTo(appState.map);
                        } catch (e) {
                            console.error("Could not add heat layer, possibly due to map size issues.", e);
                        }
                    }
                } else {
                    console.warn("Map container has no size yet, retrying map update...");
                    setTimeout(() => updateMap(mapPoints), 250);
                }
            }, 150);
        }


        function populateFilters(monthlyTrendData) {
            const incidentYears = ['Semua', ...Object.keys(monthlyTrendData)].sort((a, b) => b - a);
            const yearSelectors = ['#dashboard-filter-year'];
            yearSelectors.forEach(sel => {
                const selector = document.querySelector(sel);
                if (selector && selector.options.length <= 1) { // Populate only if empty
                    selector.innerHTML = incidentYears.map(y => `<option value="${y}">${y}</option>`).join('');
                }
            });

            const months = ['Semua', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
            const monthSelectors = ['#dashboard-filter-month'];
            monthSelectors.forEach(sel => {
                const selector = document.querySelector(sel);
                if (selector && selector.options.length <= 1) {
                    selector.innerHTML = months.map((m, i) => `<option value="${i === 0 ? 'Semua' : i - 1}">${m}</option>`).join('');
                }
            });
        }

        // ========== MODAL FUNCTIONS ==========
        function showIncidentModal(incidentId) {
            const incident = appState.tableData.find(d => d.id == incidentId);
            if (!incident) {
                alert("Detail insiden tidak ditemukan di data yang sedang ditampilkan. Coba muat ulang atau cari di halaman lain.");
                return;
            }

            const modal = document.getElementById('incident-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');

            modalTitle.textContent = incident.judulInsiden;

            const date = new Date(incident.tanggalKejadian);
            const formattedDate = date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
            const formattedTime = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });

            modalContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Waktu & Lokasi</h4>
                        <p><strong class="text-gray-600">Tanggal & Jam:</strong> ${formattedDate} Pukul ${formattedTime}</p>
                        <p><strong class="text-gray-600">Lokasi:</strong> ${incident.lokasiKejadian || '-'}</p>
                        <p><strong class="text-gray-600">Unit Terlibat:</strong> ${incident.unitTerlibat || '-'}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Detail Insiden</h4>
                        <p><strong class="text-gray-600">Kategori Kecelakaan:</strong> ${incident.kategoriKecelakaan || '-'}</p>
                        <p><strong class="text-gray-600">Penyebab Langsung:</strong> ${incident.penyebabLangsung || '-'}</p>
                        <p><strong class="text-gray-600">Penyebab Dasar:</strong> ${incident.penyebabDasar || '-'}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Rincian Korban</h4>
                        <p><strong class="text-gray-600">Kategori Cedera:</strong> ${incident.kategoriCedera || '-'}</p>
                        <p><strong class="text-gray-600">Tipe Cedera:</strong> ${incident.tipeCedera || '-'}</p>
                        <p><strong class="text-gray-600">Bagian Cedera:</strong> ${incident.bagianCedera || '-'}</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-700 mb-2">Karyawan</h4>
                        <p><strong class="text-gray-600">Perusahaan:</strong> ${incident.perusahaan || '-'}</p>
                        <p><strong class="text-gray-600">Jabatan:</strong> ${incident.jabatan || '-'}</p>
                        <p><strong class="text-gray-600">Status:</strong> ${incident.statusKaryawan || '-'}</p>
                    </div>
                </div>
            `;

            modal.classList.add('active');
        }

        function hideIncidentModal() {
            document.getElementById('incident-modal').classList.remove('active');
        }

        function showGraphModal() {
            const year = document.getElementById('hse-filter-year').value;
            const hseData = appState.hsePerformanceData;
            const yearsWithData = [...new Set(hseData.map(d => d.year))];
            if (yearsWithData.length === 0) return;

            const selectedYear = (year === 'Semua' || !yearsWithData.includes(parseInt(year))) ? Math.max(...yearsWithData) : parseInt(year);
            const yearData = hseData.filter(d => d.year == selectedYear);

            document.getElementById('graph-modal-title').textContent = `Grafik View - Tahun ${selectedYear}`;

            const months = ['januari', 'februari', 'maret', 'april', 'mei', 'juni', 'juli', 'agustus', 'september', 'oktober', 'november', 'desember'];
            const monthLabels = months.map(m => m.charAt(0).toUpperCase() + m.slice(1));

            const safetyMetrics = ['Lost Time Injury', 'Property Damage', 'Near Miss'];
            const safetyChartData = safetyMetrics.map(metric => {
                const row = yearData.find(d => d.deskripsi === metric);
                return {
                    label: metric,
                    data: row ? months.map(m => row[m] || 0) : Array(12).fill(0),
                    backgroundColor: metric === 'Lost Time Injury' ? '#ef4444' : metric === 'Property Damage' ? '#f97316' : '#22c55e'
                };
            });

            chartInstances['incident-events-chart'].data = {
                labels: monthLabels,
                datasets: safetyChartData
            };
            chartInstances['incident-events-chart'].update();

            const performanceMetrics = ['TIFR', 'PDPR', 'AFR'];
            const thresholdMetrics = ['Threshold TIFR', 'Threshold PDPR', 'Threshold AFR'];
            const colors = { TIFR: '#ec4899', PDPR: '#f59e0b', AFR: '#3b82f6' };

            const performanceChartData = performanceMetrics.map(metric => {
                const row = yearData.find(d => d.deskripsi === metric);
                return {
                    label: metric,
                    data: row ? months.map(m => row[m] || 0) : Array(12).fill(0),
                    borderColor: colors[metric],
                    tension: 0.4,
                    type: 'line'
                };
            });

            const thresholdChartData = thresholdMetrics.map(metric => {
                const row = yearData.find(d => d.deskripsi === metric);
                const baseMetric = metric.replace('Threshold ', '');
                return {
                    label: metric,
                    data: row ? months.map(m => row[m] || 0) : Array(12).fill(0),
                    borderColor: colors[baseMetric],
                    borderDash: [5, 5],
                    tension: 0.4,
                    type: 'line'
                }
            });

            chartInstances['performance-actual-chart'].data = {
                labels: monthLabels,
                datasets: [...performanceChartData, ...thresholdChartData]
            };
            chartInstances['performance-actual-chart'].update();

            document.getElementById('graph-view-modal').classList.add('active');
        }


        function hideGraphModal() {
            document.getElementById('graph-view-modal').classList.remove('active');
        }


        // ========== THEME & NAVIGATION ==========
        function setupTabs(tabContainerId) {
            const tabContainer = document.getElementById(tabContainerId); if (!tabContainer) return;
            const tabLinks = tabContainer.querySelectorAll('.tab-link'), tabContents = tabContainer.closest('.bg-white').querySelectorAll('.tab-content');
            tabLinks.forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    const tabId = link.dataset.tab;
                    tabLinks.forEach(l => { l.classList.remove('border-purple-500', 'text-purple-600', 'active'); l.classList.add('border-transparent', 'text-gray-500'); });
                    link.classList.add('border-purple-500', 'text-purple-600', 'active'); link.classList.remove('border-transparent', 'text-gray-500');
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tabId + '-content')?.classList.add('active');
                });
            });
        }
        function toggleTheme() {
            appState.currentTheme = appState.currentTheme === "light" ? "dark" : "light";
            document.body.classList.remove("theme-light", "theme-dark");
            document.body.classList.add(`theme-${appState.currentTheme}`);
            localStorage.setItem("theme", appState.currentTheme);
            const themeToggleButton = document.getElementById("theme-toggle");
            if (themeToggleButton) {
                const newIconName = appState.currentTheme === "dark" ? "sun" : "moon";
                themeToggleButton.innerHTML = `<i data-lucide="${newIconName}" class="w-5 h-5 text-gray-600"></i>`;
            }
            lucide.createIcons();
            initializeCharts();
            if (appState.fullChartData) updateDashboardUI(appState.fullChartData);
            if (appState.hsePerformanceData) updateHSEPerformanceTab(appState.hsePerformanceData);
        }

        // ========== PASSWORD PROTECTION ==========
        const CORRECT_PASSWORD = "gamitas2025";
        function requestPasswordAndSwitchPage(pageId, externalUrl = null) {
            if (sessionStorage.getItem('gamitas_access_granted') === 'true') {
                if (externalUrl) { window.open(externalUrl, '_blank'); }
            } else {
                showPasswordModal(pageId, externalUrl);
            }
        }
        function showPasswordModal(pageId, externalUrl = null) {
            appState.targetPage = pageId;
            appState.targetUrl = externalUrl;
            const modal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');
            passwordInput.value = '';
            passwordError.classList.add('hidden');
            modal.classList.remove('hidden');
            passwordInput.focus();
        }
        function handlePasswordSubmit(e) {
            e.preventDefault();
            const passwordInput = document.getElementById('password-input');
            const passwordError = document.getElementById('password-error');
            if (passwordInput.value === CORRECT_PASSWORD) {
                sessionStorage.setItem('gamitas_access_granted', 'true');
                document.getElementById('password-modal').classList.add('hidden');
                if (appState.targetUrl) {
                    window.open(appState.targetUrl, '_blank');
                }
                appState.targetPage = null;
                appState.targetUrl = null;
            } else {
                passwordError.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // ========== EVENT LISTENERS & EXPORT ==========
        async function loadTablePage(page) {
            if (page < 1 || page > appState.pagination.totalPages) return;
            try {
                const paginatedData = await fetchData('getPaginatedData', { page: page, pageSize: 50 });
                renderTable(paginatedData);
            } catch (error) {
                console.error(`Failed to load page ${page}:`, error);
                showErrorBanner(`Gagal memuat halaman ${page}. Coba lagi.`);
            }
        }

        async function applyDashboardFilters() {
            const year = document.getElementById('dashboard-filter-year').value;
            const month = document.getElementById('dashboard-filter-month').value;

            try {
                const filteredData = await fetchData('getChartData', { year, month });
                updateDashboardUI(filteredData);
            } catch (error) {
                console.error("Failed to fetch filtered data:", error);
                showErrorBanner(`Gagal menerapkan filter: ${error.message}`);
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                const pageId = link.dataset.page;
                const externalUrl = link.dataset.externalUrl;
                const isProtected = pageId === 'pelatihan' || pageId === 'observasi';

                if (isProtected) {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        requestPasswordAndSwitchPage(pageId, externalUrl);
                    });
                }
            });
            document.querySelector('.sidebar-link[data-page="laporan_insiden"]')?.classList.add('active');

            setupTabs('laporan-tabs');
            document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
            document.getElementById('refresh-button').addEventListener('click', forceRefreshData);

            // Dashboard Filter Listeners
            document.getElementById('dashboard-apply-filter').addEventListener('click', applyDashboardFilters);
            document.getElementById('dashboard-reset-filter').addEventListener('click', () => {
                document.getElementById('dashboard-filter-year').value = 'Semua';
                document.getElementById('dashboard-filter-month').value = 'Semua';
                if (appState.fullChartData) {
                    updateDashboardUI(appState.fullChartData);
                }
            });

            // Data Laporan Tab Listeners
            document.getElementById('laporan-insiden-table-body').addEventListener('click', (e) => {
                const link = e.target.closest('.incident-title-link');
                if (link) {
                    e.preventDefault();
                    const incidentId = link.dataset.id;
                    showIncidentModal(incidentId);
                }
            });
            document.getElementById('prev-page-button').addEventListener('click', () => loadTablePage(appState.pagination.currentPage - 1));
            document.getElementById('next-page-button').addEventListener('click', () => loadTablePage(appState.pagination.currentPage + 1));

            document.getElementById('export-csv-button').addEventListener('click', exportToCSV);
            document.getElementById('export-pdf-button').addEventListener('click', exportToPDF);

            // HSE Performance Tab Listeners
            const applyHSEFilter = () => {
                const year = document.getElementById('hse-filter-year').value;
                const term = document.getElementById('hse-search-input').value;
                updateHSEPerformanceTab(appState.hsePerformanceData, year, term);
            };
            document.getElementById('hse-filter-year').addEventListener('change', applyHSEFilter);
            document.getElementById('hse-search-input').addEventListener('input', applyHSEFilter);
            document.getElementById('hse-reset-filter-button').addEventListener('click', () => {
                document.getElementById('hse-filter-year').value = 'Semua';
                document.getElementById('hse-search-input').value = '';
                updateHSEPerformanceTab(appState.hsePerformanceData);
            });
            document.getElementById('view-graph-button').addEventListener('click', showGraphModal);

            // Modal Listeners
            document.getElementById('modal-close-button').addEventListener('click', hideIncidentModal);
            document.getElementById('incident-modal').addEventListener('click', (e) => { if (e.target.id === 'incident-modal') hideIncidentModal(); });
            document.getElementById('graph-modal-close-button').addEventListener('click', hideGraphModal);
            document.getElementById('graph-view-modal').addEventListener('click', (e) => { if (e.target.id === 'graph-view-modal') hideGraphModal(); });

            // Language Switcher Listener
            document.getElementById('language-switcher').addEventListener('change', (e) => {
                setLanguage(e.target.value);
            });

            // Password Modal Listeners
            document.getElementById('password-form')?.addEventListener('submit', handlePasswordSubmit);
            document.body.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-close-btn') || e.target.closest('.modal-close-btn') || e.target.id === 'password-modal') {
                    document.querySelectorAll('.fixed.inset-0').forEach(modal => modal.classList.add('hidden'));
                }
            });

            // Sidebar mobile toggle
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            const sidebar = document.getElementById('sidebar');
            mobileMenuToggle.addEventListener('click', (e) => { e.stopPropagation(); sidebar.classList.toggle('show'); });
            document.addEventListener('click', (e) => { if (!sidebar.contains(e.target) && !mobileMenuToggle.contains(e.target)) { sidebar.classList.remove('show'); } });
        }

        function exportToCSV() {
            alert("Fungsi ekspor hanya akan mengunduh data dari halaman yang sedang ditampilkan.");
            const csv = Papa.unparse(appState.tableData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `laporan_insiden_halaman_${appState.pagination.currentPage}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function exportToPDF() {
            alert("Fungsi ekspor hanya akan mengunduh data dari halaman yang sedang ditampilkan.");
            const doc = new jsPDF();
            doc.text(`Laporan Insiden Halaman ${appState.pagination.currentPage}`, 14, 16);
            doc.autoTable({
                startY: 20,
                head: [['ID', 'Tanggal', 'Judul Insiden', 'Klasifikasi', 'Status']],
                body: appState.tableData.map(row => [row.id, new Date(row.tanggalKejadian).toLocaleDateString('id-ID'), row.judulInsiden, row.kategoriKecelakaan, row.statusLpi]),
            });
            doc.save(`laporan_insiden_halaman_${appState.pagination.currentPage}.pdf`);
        }

        async function forceRefreshData() {
            const refreshButton = document.getElementById('refresh-button');
            if (!refreshButton) return;
            const icon = refreshButton.firstElementChild;

            if (icon) icon.classList.add('animate-spin');
            refreshButton.disabled = true;

            updateLastUpdatedTimestamp(null);
            localStorage.removeItem(appState.cache.key);

            try {
                const [chartData, tablePage1, hseData] = await Promise.all([
                    fetchData('getChartData'),
                    fetchData('getPaginatedData', { page: 1, pageSize: 50 }),
                    fetchData('getHseData')
                ]);

                console.log("Forced refresh successful. Updating UI and cache.");
                appState.fullChartData = chartData;
                updateDashboardUI(chartData);
                renderTable(tablePage1);
                updateHSEPerformanceTab(hseData);
                setCachedData(chartData);
            } catch (error) {
                console.error("Forced refresh failed to retrieve new data.", error);
                showErrorBanner(`Gagal memuat ulang data: ${error.message}`);
            } finally {
                if (icon) icon.classList.remove('animate-spin');
                refreshButton.disabled = false;
            }
        }

        // ========== LANGUAGE FUNCTIONS (NEW) ==========
        function setLanguage(lang) {
            appState.currentLang = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang;

            const translations = appState.translations[lang];
            if (!translations) return;

            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (translations[key]) {
                    el.innerHTML = translations[key];
                }
            });

            document.querySelectorAll('[data-translate-title-key]').forEach(el => {
                const key = el.dataset.translateTitleKey;
                if (translations[key]) {
                    el.title = translations[key];
                }
            });

            document.querySelectorAll('[data-translate-placeholder-key]').forEach(el => {
                const key = el.dataset.translatePlaceholderKey;
                if (translations[key]) {
                    el.placeholder = translations[key];
                }
            });

            updateLastUpdatedTimestamp(appState.lastUpdated);
            initializeCharts();
            if (appState.fullChartData) updateDashboardUI(appState.fullChartData);
            if (appState.hsePerformanceData) updateHSEPerformanceTab(appState.hsePerformanceData);
        }

        async function loadTranslations() {
            appState.translations = {
                en: {
                    pageTitle: "Incident Report - GAMITAS", headerTitle: "GAMITAS - Incident Report", loadingData: "Loading data...", lastUpdatedText: "Last updated:", fatality: "Fatality", sourceDataButtonTitle: "Data Source",
                    // ... other keys
                },
                id: {
                    pageTitle: "Laporan Insiden - GAMITAS", headerTitle: "GAMITAS - Laporan Insiden", loadingData: "Memuat data...", lastUpdatedText: "Terakhir diperbarui:", fatality: "Fatalitas", sourceDataButtonTitle: "Sumber Data",
                    // ... other keys
                },
                ko: {
                    pageTitle: "사고 보고서 - GAMITAS", headerTitle: "GAMITAS - 사고 보고서", loadingData: "데이터 로딩 중...", lastUpdatedText: "마지막 업데이트:", fatality: "사망 사고", sourceDataButtonTitle: "데이터 소스",
                    // ... other keys
                }
            };
        }

        // ========== MAIN INITIALIZATION ==========
        async function initializePage() {
            await loadTranslations();
            document.getElementById('language-switcher').value = appState.currentLang;
            setLanguage(appState.currentLang);

            const cachedChartData = getCachedData();

            if (cachedChartData) {
                console.log("Valid cache found. Rendering from cache.");
                appState.fullChartData = cachedChartData.data;
                updateDashboardUI(cachedChartData.data);
                updateLastUpdatedTimestamp(cachedChartData.timestamp);
            } else {
                console.log("No valid cache. Fetching fresh data.");
                try {
                    const chartData = await fetchData('getChartData');
                    appState.fullChartData = chartData;
                    updateDashboardUI(chartData);
                    setCachedData(chartData);
                } catch (error) {
                    console.error("Failed to fetch initial chart data:", error);
                    showErrorBanner(`Gagal memuat data utama dasbor: ${error.message}`);
                }
            }

            try {
                const [tablePage1, hseData] = await Promise.all([
                    fetchData('getPaginatedData', { page: 1, pageSize: 50 }),
                    fetchData('getHseData')
                ]);
                renderTable(tablePage1);
                updateHSEPerformanceTab(hseData);
            } catch (error) {
                console.error("Failed to fetch paginated or HSE data:", error);
                showErrorBanner(`Gagal memuat data tabel atau HSE: ${error.message}`);
            }
        }


        document.addEventListener('DOMContentLoaded', async function () {
            document.body.classList.add(`theme-${appState.currentTheme}`);
            const themeToggleButton = document.getElementById("theme-toggle");
            if (themeToggleButton) {
                const iconName = appState.currentTheme === 'dark' ? 'sun' : 'moon';
                themeToggleButton.innerHTML = `<i data-lucide="${iconName}" class="w-5 h-5 text-gray-600"></i>`;
            }

            lucide.createIcons();
            initializeCharts();
            initializeMap();
            setupEventListeners();
            await initializePage();
        });
    </script>
</body>

</html>